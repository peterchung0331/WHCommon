# PRD: 허브 통합 관리 - 중앙 계정 권한 관리 시스템

## 1. Introduction/Overview

### 문제 정의
현재 각 허브(WBFinHub, WBSalesHub 등)가 독립적인 계정(accounts) 테이블을 관리하고 있어, 사용자 권한 관리가 분산되어 있습니다. 이로 인해 다음과 같은 문제가 발생합니다:

1. **권한 관리의 복잡성**: 각 허브마다 별도로 계정을 생성하고 권한을 부여해야 함
2. **일관성 부족**: 동일한 사용자가 허브마다 다른 상태나 정보를 가질 수 있음
3. **감사 추적 어려움**: 사용자의 전체 활동 이력을 통합 조회하기 어려움
4. **관리 비용 증가**: 각 허브를 개별적으로 관리해야 하는 운영 부담

### 솔루션
허브매니저에서 모든 허브의 계정 권한을 중앙에서 관리하는 시스템을 구축합니다. API 기반 중앙 인증/권한 서비스 방식으로 JWT 토큰에 허브별 권한 정보를 포함하고, 각 허브는 미들웨어에서 이를 검증합니다.

## 2. Goals

### 주요 목표
1. **중앙 집중식 권한 관리**: 허브매니저에서 모든 허브의 사용자 권한을 통합 관리
2. **유연한 역할 체계**: 각 허브별로 고유한 역할(Role) 정의 가능
3. **실시간 권한 검증**: JWT 토큰 + API 캐싱을 통한 빠른 권한 확인
4. **포괄적인 감사 로그**: 권한 변경, 로그인, 허브 접근 등 모든 활동 기록
5. **직관적인 관리 UI**: Tools 메뉴를 통한 손쉬운 권한 관리

### 성공 지표
- 모든 허브의 계정 권한이 허브매니저를 통해 관리됨
- 권한 변경 후 5분 이내 모든 허브에 반영
- 감사 로그 100% 기록 (권한 변경, 로그인, 허브 접근)
- 관리자가 5분 이내에 신규 사용자 권한 설정 가능

## 3. User Stories

### 관리자 (Admin)
1. **계정 권한 부여**: "관리자로서, 새로운 사용자에게 핀허브 FINANCE 역할을 부여하고 싶습니다. 허브매니저의 Accounts 메뉴에서 사용자를 선택하고 핀허브 탭에서 역할을 선택하여 저장합니다."

2. **권한 변경 이력 조회**: "관리자로서, 특정 사용자의 권한이 언제 누구에 의해 변경되었는지 확인하고 싶습니다. Audit Logs 메뉴에서 사용자를 필터링하고 PERMISSION_GRANTED, ROLE_CHANGED 액션을 조회합니다."

3. **허브별 역할 확인**: "관리자로서, 세일즈허브에서 사용 가능한 역할 목록(MASTER, ADMIN, USER, VIEWER)을 확인하고 각 역할의 권한을 이해하고 싶습니다."

### 일반 사용자 (User)
1. **허브 접근**: "사용자로서, 허브매니저에서 로그인한 후 핀허브 버튼을 클릭하면, 내가 부여받은 역할에 따라 핀허브에 자동으로 로그인하고 싶습니다."

2. **권한 없음 안내**: "사용자로서, 접근 권한이 없는 허브에 접속을 시도하면 명확한 오류 메시지를 받고 싶습니다."

### 개발자 (Developer)
1. **새 허브 통합**: "개발자로서, 새로운 허브를 추가할 때 허브매니저의 권한 시스템을 쉽게 통합하고 싶습니다. JWT 미들웨어를 추가하고 역할 정의만 등록하면 됩니다."

2. **권한 검증**: "개발자로서, 각 API 엔드포인트에서 사용자의 허브 역할을 확인하고 접근을 제어하고 싶습니다. req.user.hubRole을 확인하여 조건부 로직을 구현합니다."

## 4. Functional Requirements

### FR1: 중앙 권한 관리
1. 허브매니저에 `hub_memberships` 테이블을 생성하여 사용자-허브-역할 매핑 저장
2. 각 허브별로 사용 가능한 역할을 `hub_role_definitions` 테이블에 정의
3. 관리자가 특정 사용자에게 특정 허브의 특정 역할을 부여/변경/취소할 수 있음
4. 역할 상태(ACTIVE, INACTIVE, SUSPENDED) 관리 가능

### FR2: API 기반 권한 검증
1. 허브매니저에 권한 검증 API 제공 (`GET /api/auth/verify-hub-permission`)
2. 각 허브의 JWT 미들웨어에서 권한 확인:
   - JWT 토큰의 `hub_permissions` 필드 확인
   - 없으면 허브매니저 API 호출
   - 권한 결과를 5분간 캐싱
3. 접근 권한이 없는 경우 403 Forbidden 응답

### FR3: JWT 토큰에 권한 정보 포함
1. Access Token 생성 시 사용자의 모든 허브별 권한을 `hub_permissions` 필드에 포함
2. 형식: `{ WBFINHUB: { role: 'ADMIN', status: 'ACTIVE' }, WBSALESHUB: { role: 'USER', status: 'ACTIVE' } }`
3. Token Refresh 시 최신 권한 정보로 업데이트

### FR4: 허브 통합 관리 UI
1. 허브매니저 GlobalNav 우상단에 "Tools" 드롭다운 메뉴 추가
2. Tools 메뉴에 "Accounts", "Audit Logs" 항목 포함
3. Accounts 페이지:
   - 왼쪽: 사용자 목록
   - 오른쪽: 선택된 사용자의 허브별 권한 관리 패널
   - 허브 탭 전환, 역할 선택, 상태 변경, 저장/취소 버튼
4. 사이드바 형식의 일관된 네비게이션

### FR5: 감사 로그
1. 다음 활동을 `audit_logs` 테이블에 기록:
   - `LOGIN`: 사용자 로그인
   - `LOGOUT`: 사용자 로그아웃
   - `PERMISSION_GRANTED`: 권한 부여
   - `PERMISSION_REVOKED`: 권한 취소
   - `ROLE_CHANGED`: 역할 변경
   - `HUB_ACCESSED`: 허브 접근
2. 각 로그에 사용자, 허브, 변경 전/후 값, IP 주소, User Agent 포함
3. Audit Logs 페이지에서 필터링 및 조회:
   - 사용자별, 허브별, 액션별, 날짜 범위별 필터
   - 페이지네이션 지원

### FR6: 기존 허브 테이블 제거
1. WBFinHub, WBSalesHub의 `accounts` 테이블 백업
2. 백업 확인 후 테이블 삭제
3. 각 허브의 JWT 미들웨어를 허브매니저 API 기반으로 전환

## 5. Non-Goals (Out of Scope)

### 현재 구현에서 제외
1. **세부 권한(Permission) 관리**: 역할 내 개별 기능별 권한 설정 (향후 확장 가능하도록 JSONB 필드 준비)
2. **기존 데이터 마이그레이션**: 신규 시작 방식으로 기존 계정 데이터는 백업만 수행
3. **권한 승인 워크플로우**: 사용자가 권한을 요청하고 관리자가 승인하는 프로세스 (즉시 부여 방식만 지원)
4. **역할 계층 구조**: 역할 간 상속 관계 (각 역할은 독립적)
5. **허브 간 권한 의존성**: 특정 허브 접근을 위해 다른 허브 권한 필요 조건 설정

### 향후 확장 가능 기능
- 권한 템플릿: 자주 사용하는 역할 조합을 템플릿으로 저장
- 권한 만료: 특정 날짜까지만 유효한 임시 권한
- 2단계 인증: 민감한 허브 접근 시 추가 인증

## 6. Design Considerations

### UI/UX 설계
1. **일관된 디자인**: 각 허브의 사이드바 스타일과 일관성 유지
2. **직관적인 네비게이션**: Tools 아이콘(⚙️)으로 관리 기능 명확히 구분
3. **즉시 피드백**: 권한 변경 후 성공/실패 토스트 메시지 표시
4. **컬러 코딩**: 역할별 색상 구분 (ADMIN=빨강, USER=파랑, VIEWER=회색)

### 반응형 디자인
- 모바일: 사이드바를 하단 탭으로 전환
- 태블릿: 사이드바 축소 가능
- 데스크톱: 전체 사이드바 표시

## 7. Technical Considerations

### 기술 스택
- **Backend**: Node.js, Express.js, PostgreSQL
- **Frontend**: Next.js (App Router), React, TypeScript, Tailwind CSS
- **인증**: JWT (RS256), Token Rotation, Blacklist
- **캐싱**: 메모리 캐시 (5분 TTL)

### 성능 고려사항
1. **JWT 토큰 크기**: 허브 수 증가 시 토큰 크기 관리 필요 (현재 최대 10개 허브 가정)
2. **권한 캐싱**: 각 허브에서 5분 캐싱으로 HubManager API 부하 감소
3. **감사 로그 인덱싱**: `user_id`, `hub_id`, `action`, `created_at`에 인덱스 생성
4. **DB 연결 풀**: HubManager API 호출 증가에 대비한 커넥션 풀 최적화

### 보안 고려사항
1. **JWT 검증**: 각 허브에서 RS256 공개키로 토큰 서명 검증
2. **Blacklist 확인**: 폐기된 토큰 사용 방지
3. **Rate Limiting**: HubManager API에 Rate Limit 적용
4. **Audit Log**: 모든 권한 변경 활동 기록

### 확장성
- **새 허브 추가**: `hubs` 테이블에 추가하고 역할 정의만 등록
- **새 역할 추가**: `hub_role_definitions` 테이블에 INSERT
- **다중 조직 지원**: `organizations` 테이블 추가하여 조직별 허브 그룹화 (향후)

## 8. Success Metrics

### 기능적 성공 지표
1. ✅ 모든 사용자 권한이 허브매니저에서 관리됨 (100%)
2. ✅ 권한 변경 후 5분 이내 모든 허브에 반영
3. ✅ 감사 로그 100% 기록 (누락 없음)
4. ✅ 관리자가 5분 이내에 신규 사용자 권한 설정 완료

### 기술적 성공 지표
1. 권한 검증 API 응답 시간 < 100ms (캐시 히트 시)
2. JWT 토큰 크기 < 2KB
3. 감사 로그 조회 응답 시간 < 500ms (100건 기준)
4. 각 허브의 JWT 미들웨어 성능 저하 < 10%

### 사용자 경험 지표
1. 관리자 만족도: 권한 관리 UI 사용 편의성 설문 (5점 만점 평균 4점 이상)
2. 오류율: 권한 관련 403 에러 중 정당한 거부 비율 95% 이상
3. 지원 티켓 감소: 권한 관련 문의 50% 감소

## 9. Open Questions

### 해결된 질문 (사용자 답변 완료)
1. ~~허브 통합 관리 대시보드 접근 위치?~~ → 허브매니저 우상단 Tools 메뉴
2. ~~허브별 권한 역할 체계?~~ → 허브별로 다른 역할 체계 유지
3. ~~기존 데이터 마이그레이션?~~ → 신규 시작 (백업만 수행)
4. ~~감사 로그 범위?~~ → 계정 권한 변경, 로그인/로그아웃, 허브 간 이동

### 남은 질문
1. **권한 캐시 무효화**: 긴급하게 권한을 즉시 반영해야 할 경우 캐시 무효화 API 필요 여부?
2. **역할 설명 다국어**: 역할 표시명과 설명을 영어/한국어 다국어 지원 필요 여부?
3. **감사 로그 보관 기간**: 감사 로그를 영구 보관할지, 일정 기간(예: 1년) 후 아카이브할지?
4. **권한 변경 알림**: 사용자 권한 변경 시 이메일 알림 필요 여부?

## 10. Implementation Timeline

### Phase 1: DB 및 백엔드 (1-2일)
- DB 스키마 생성
- 권한 관리 API 구현
- JWT 서비스 수정

### Phase 2: 프론트엔드 (1-2일)
- Tools 메뉴 추가
- Accounts 페이지 구현
- Audit Logs 페이지 구현

### Phase 3: 허브 통합 (0.5-1일)
- 각 허브 JWT 미들웨어 수정
- 권한 캐싱 구현

### Phase 4: 테스트 및 배포 (0.5-1일)
- 통합 테스트
- 기존 테이블 백업 및 제거
- 프로덕션 배포

**예상 총 소요 시간**: 3-5일

## 11. Dependencies

### 기술적 의존성
- HubManager JWT 인증 시스템 (기존)
- PostgreSQL 데이터베이스 (기존)
- 각 허브의 JWT 미들웨어 (수정 필요)

### 조직적 의존성
- 관리자 계정 권한 정책 확정
- 각 허브별 역할 정의 합의
- 기존 사용자 재등록 프로세스

## 12. Risks and Mitigation

### 리스크
1. **JWT 토큰 크기 증가**: 허브 수가 많아지면 토큰이 커질 수 있음
   - **완화**: 허브 수 제한(최대 10개) 또는 참조 방식 전환 검토

2. **권한 캐싱 지연**: 권한 변경 후 최대 5분 지연 가능
   - **완화**: 긴급 시 캐시 무효화 API 추가 또는 TTL 단축

3. **HubManager API 장애**: HubManager가 다운되면 모든 허브 로그인 불가
   - **완화**: 각 허브의 로컬 캐시 활용, 만료된 캐시라도 임시 사용

4. **기존 사용자 재등록 부담**: 신규 시작 방식으로 기존 사용자 재설정 필요
   - **완화**: 자동 계정 생성 기능 활용, 관리자 일괄 권한 부여 스크립트 제공

## 13. Approval

### 검토 및 승인 필요
- [ ] 백엔드 리드: API 설계 및 DB 스키마 검토
- [ ] 프론트엔드 리드: UI/UX 설계 검토
- [ ] 보안 담당자: 권한 관리 및 감사 로그 보안 검토
- [ ] 프로덕트 오너: 전체 요구사항 및 우선순위 승인

---

**문서 버전**: 1.0
**작성일**: 2026-01-04
**작성자**: Claude Code
**최종 수정일**: 2026-01-04
