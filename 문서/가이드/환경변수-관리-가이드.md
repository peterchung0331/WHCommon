# 환경변수 관리 가이드

WorkHub 프로젝트의 환경변수 관리 방법을 설명합니다.

## 개요

모든 환경변수는 `.env` 파일로 관리되며, Doppler는 백업 및 동기화 용도로 사용됩니다.

### 환경별 파일
- **로컬 개발**: `.env.local` - 로컬 개발 환경에서 사용
- **프로덕션**: `.env.prd` - 프로덕션 배포 시 사용
- **Git 관리**: 두 파일 모두 `.gitignore`에 포함되어 Git에 커밋되지 않음

## 초기 설정

### 1. Git Hooks 설치

프로젝트 루트에서 다음 명령어를 실행하여 Git Hook을 설치합니다:

```bash
bash WHCommon/scripts/install-hooks.sh
```

설치되는 Hook:
- `pre-commit`: 커밋 전에 `.env.local`을 Doppler Development에 업로드
- `post-merge`: Git Pull 후 Doppler Development에서 `.env.local` 다운로드

### 2. 로컬 환경변수 설정

최초 개발 시작 시 Doppler에서 환경변수를 다운로드합니다:

```bash
# WBHubManager 프로젝트의 경우
cd /mnt/c/GitHub/WBHubManager
bash WHCommon/scripts/sync-doppler.sh download dev

# HWTestAgent 프로젝트의 경우
cd /mnt/c/GitHub/WBHubManager/HWTestAgent
bash ../WHCommon/scripts/sync-doppler.sh download dev
```

이 명령어는 Doppler Development 설정에서 환경변수를 다운로드하여 `.env.local` 파일을 생성합니다.

## 일상 작업 흐름

### 로컬 개발

1. **환경변수 읽기**: 애플리케이션이 자동으로 `.env.local`에서 환경변수를 로드
2. **환경변수 수정**: `.env.local` 파일을 직접 편집
3. **Git Commit**: 자동으로 `.env.local`이 Doppler Development에 업로드됨 (pre-commit hook)
4. **Git Pull**: 자동으로 Doppler Development에서 최신 환경변수 다운로드 (post-merge hook)

### 수동 동기화

필요시 수동으로 Doppler와 동기화할 수 있습니다:

```bash
# .env.local → Doppler Development 업로드
bash WHCommon/scripts/sync-doppler.sh upload dev

# Doppler Development → .env.local 다운로드
bash WHCommon/scripts/sync-doppler.sh download dev
```

## 프로덕션 배포

배포 스크립트(`deploy-oracle.sh`)를 실행하면 다음 단계가 자동으로 수행됩니다:

1. **Doppler Production에서 `.env.prd` 생성**
   ```bash
   bash WHCommon/scripts/sync-doppler.sh download prd
   ```

2. **코드를 GitHub에 푸시**

3. **`.env.prd`를 오라클 서버에 전송**
   ```bash
   scp .env.prd ubuntu@158.180.95.246:/home/ubuntu/<project>/.env.prd
   ```

4. **오라클 서버에서 Docker 빌드 및 배포**
   - Docker 컨테이너가 `.env.prd`에서 환경변수 로드

## 프로젝트별 Doppler 토큰 매핑

`WHCommon/env/.env.doppler` 파일에 모든 프로젝트의 Doppler 토큰이 저장되어 있습니다:

| 프로젝트 | Development 토큰 | Production 토큰 |
|---------|----------------|----------------|
| WBHubManager | `DOPPLER_TOKEN_HUBMANAGER_DEV` | `DOPPLER_TOKEN_HUBMANAGER_PRD` |
| WBSalesHub | `DOPPLER_TOKEN_SALESHUB_DEV` | `DOPPLER_TOKEN_SALESHUB_PRD` |
| WBFinHub | `DOPPLER_TOKEN_FINHUB_DEV` | `DOPPLER_TOKEN_FINHUB_PRD` |
| WBOnboardingHub | `DOPPLER_TOKEN_ONBOARDINGHUB_DEV` | `DOPPLER_TOKEN_ONBOARDINGHUB_PRD` |
| HWTestAgent | `DOPPLER_TOKEN_WHTESTAGENT_DEV` | `DOPPLER_TOKEN_TESTAGENT_PRD` |

## 트러블슈팅

### .env.local 파일이 없어요

Doppler에서 다운로드하세요:
```bash
bash WHCommon/scripts/sync-doppler.sh download dev
```

### Doppler 업로드/다운로드가 실패해요

1. `WHCommon/env/.env.doppler` 파일이 존재하는지 확인
2. 해당 프로젝트의 Doppler 토큰이 파일에 있는지 확인
3. 프로젝트 이름이 올바른지 확인 (대소문자 구분)

### Git Hook이 작동하지 않아요

Git Hook을 재설치하세요:
```bash
bash WHCommon/scripts/install-hooks.sh
```

### 환경변수가 로드되지 않아요

1. `.env.local` (또는 `.env.prd`) 파일이 프로젝트 루트에 있는지 확인
2. 서버 로그에서 환경변수 로드 메시지 확인:
   - 성공: `✅ Loaded environment variables from .env.local`
   - 실패: `⚠️  Warning: .env.local not found`
3. `NODE_ENV` 환경변수 확인:
   - 로컬: `development` 또는 미설정
   - 프로덕션: `production`

## 주의사항

- ❌ `.env.local`, `.env.prd` 파일을 Git에 커밋하지 마세요
- ❌ 애플리케이션 실행 중에 Doppler API를 직접 호출하지 마세요
- ✅ 환경변수 변경 시 반드시 `.env.local` 파일을 수정하세요
- ✅ Git Commit 전에 중요한 환경변수가 `.env.local`에 포함되어 있는지 확인하세요
- ✅ 프로덕션 배포 전에 Doppler Production 설정이 최신인지 확인하세요

## 참고 문서

- [배포 가이드 - 오라클](./배포-가이드-오라클.md)
- [Claude Code 컨텍스트](./claude-context.md)

---
마지막 업데이트: 2026-01-02
