# 환경별 차이점 가이드 (로컬 vs Docker 스테이징)

## 개요
이 문서는 로컬 개발 환경과 Docker 스테이징 환경 간의 차이점을 설명하고, 각 환경에서 발생할 수 있는 문제와 해결 방법을 정리합니다.

## 환경 비교표

| 항목 | 로컬 개발 환경 | Docker 스테이징 환경 |
|------|---------------|---------------------|
| **프론트엔드** | Next.js dev server (hot reload) | 정적 빌드 (production build) |
| **백엔드** | nodemon + tsx (개발 모드) | Node.js (프로덕션 모드) |
| **환경변수 로딩** | `.env.local` 파일 | `docker-compose.yml` 환경변수 |
| **포트 구조** | 각 허브별 개별 포트 | 단일 포트 + Nginx 라우팅 |
| **OAuth Client** | 개발용 Google Client ID | 프로덕션용 Google Client ID |
| **데이터베이스** | Railway (원격) 또는 로컬 Docker | Docker 내 PostgreSQL 컨테이너 |
| **쿠키 도메인** | localhost (기본값) | 명시적 설정 |
| **개발 기능** | 활성화 (dev-login 등) | 비활성화 |

---

## 주요 차이점 상세

### 1. 환경변수 관리

#### 로컬 개발 (`.env.local`)
```bash
# 수동으로 관리, 오타 가능
NEXT_PUBLIC_HUB_MANAGER_URL="http://localhost:4090"
GOOGLE_CLIENT_ID="136191848954-..."
DATABASE_URL="postgresql://..."
```

**문제점:**
- 수동 편집으로 인한 오타 가능
- 환경변수 누락 가능
- `.gitignore`에 포함되어 팀원 간 공유 어려움

**해결책:**
- `.env.template` 파일 제공
- `scripts/validate-local-env.sh` 실행하여 검증
- `npm run predev` 훅으로 자동 검증

#### Docker 스테이징 (`docker-compose.yml`)
```yaml
# 중앙 집중 관리, 검증된 값
environment:
  NEXT_PUBLIC_HUB_MANAGER_URL: "http://localhost:4400"
  GOOGLE_CLIENT_ID: "610310091694-..."
  DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/hubmanager"
```

**장점:**
- Git으로 관리되어 팀원 간 동일한 설정 사용
- 빌드 시점에 환경변수 확정
- 오타 가능성 낮음

---

### 2. 프론트엔드 빌드 방식

#### 로컬 개발
```bash
npm run dev
# Next.js dev server 실행
# - 파일 변경 시 hot reload
# - 런타임에 환경변수 변경 가능 (재시작 필요)
# - NODE_ENV=development
```

#### Docker 스테이징
```bash
npm run build:local
npm start
# 정적 파일로 빌드
# - 빌드 시점에 환경변수 번들에 포함
# - 런타임 변경 불가
# - NODE_ENV=production
```

**영향:**
- 로컬에서는 `.env.local` 변경 후 재시작 필요
- Docker에서는 빌드 시점에 값이 확정되어 재빌드 필요

---

### 3. 개발 모드 전용 기능

#### 로컬 개발
```typescript
// 개발 모드 로그인 버튼 표시
{process.env.NODE_ENV === 'development' && (
  <button onClick={handleDevLogin}>개발 모드 로그인</button>
)}
```

#### Docker 스테이징
```typescript
// NODE_ENV=production이므로 개발 모드 기능 숨김
// 위 버튼은 렌더링되지 않음
```

**문제 사례:**
- 로컬 E2E 테스트에서 `button:has-text("로그인")` 셀렉터가 개발 모드 버튼을 선택
- Docker에서는 해당 버튼이 없으므로 문제 없음

**해결책:**
- 로컬 테스트 시 구체적인 셀렉터 사용: `button:has-text("HubManager로 로그인")`

---

### 4. OAuth 플로우 차이

#### 로컬 개발
```
1. 사용자가 "HubManager로 로그인" 클릭
2. Google OAuth 페이지로 이동
3. 이메일 입력 (또는 계정 선택)
4. 비밀번호 입력
5. **동의 페이지 표시** (개발용 앱)
6. "Continue" 클릭 필요
7. /api/auth/google-callback으로 리다이렉트
```

#### Docker 스테이징 (프로덕션 앱)
```
1. 사용자가 "HubManager로 로그인" 클릭
2. Google OAuth 페이지로 이동
3. 이메일 입력
4. 비밀번호 입력
5. **동의 페이지 자동 승인** (검증된 앱, 2회차부터)
6. /api/auth/google-callback으로 바로 리다이렉트
```

**차이 원인:**
- 개발용 Google Client ID는 매번 동의 필요
- 프로덕션용 (verified) 앱은 한 번만 동의

---

### 5. 데이터베이스 연결

#### 로컬 개발
```bash
# Railway (원격 PostgreSQL)
DATABASE_URL="postgresql://postgres:password@ballast.proxy.rlwy.net:31660/railway"

# 또는 로컬 Docker PostgreSQL
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/hubmanager"
```

**문제점:**
- Railway 사용 시 네트워크 지연
- 연결 불안정 시 500 에러 발생 가능

#### Docker 스테이징
```yaml
services:
  postgres:
    image: postgres:15

  hubmanager:
    environment:
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/hubmanager"
```

**장점:**
- 동일한 Docker 네트워크 내에서 안정적 연결
- 네트워크 지연 없음

---

### 6. 브라우저 세션 관리

#### 로컬 개발
- Playwright가 로컬 머신의 브라우저 세션 사용
- 이전 Google 로그인 세션이 남아있을 수 있음
- **계정 선택 페이지** 표시 가능

#### Docker 스테이징
- Docker 컨테이너 내에서 격리된 브라우저 실행
- 매번 새로운 세션 시작
- **이메일 입력 페이지**부터 시작

---

## 로컬 개발 환경에서 발생한 문제 사례

### 사례 1: HUB_MANAGER_URL 오류

**증상:**
- 로그인 버튼 클릭 시 `chrome-error://chromewebdata/` 페이지로 이동

**원인:**
```bash
# .env.local에 잘못된 포트 설정
NEXT_PUBLIC_HUB_MANAGER_URL="http://localhost:3090"  # ❌ 틀림
```

**해결:**
```bash
NEXT_PUBLIC_HUB_MANAGER_URL="http://localhost:4090"  # ✅ 올바름
```

**Docker에서 발생하지 않은 이유:**
- `docker-compose.yml`에 정확한 값이 하드코딩되어 있음

---

### 사례 2: 개발 모드 로그인 버튼 오작동

**증상:**
- E2E 테스트에서 "개발 모드 로그인" 버튼을 클릭하여 `account_inactive` 에러 발생

**원인:**
```typescript
// 개발 모드에서 2개 버튼 모두 표시
<button onClick={handleDevLogin}>개발 모드 로그인</button>
<button onClick={handleHubManagerLogin}>HubManager로 로그인</button>

// 일반적인 셀렉터가 첫 번째 버튼 선택
const loginButton = page.locator('button:has-text("로그인")').first();
```

**해결:**
```typescript
// 구체적인 셀렉터 사용
const loginButton = page.locator('button:has-text("HubManager로 로그인")');
```

**Docker에서 발생하지 않은 이유:**
- `NODE_ENV=production`이므로 개발 모드 버튼이 렌더링되지 않음

---

### 사례 3: Google 계정 선택 페이지 처리 누락

**증상:**
- Google 로그인 시 계정 선택 페이지에서 테스트가 멈춤

**원인:**
- 로컬 브라우저에 이전 Google 세션이 남아있음
- 테스트 스크립트에 계정 선택 로직 없음

**해결:**
```typescript
// 계정 선택 페이지 처리 추가
const accountChooser = page.locator(`div:has-text("${GOOGLE_EMAIL}")`).first();
if (await accountChooser.isVisible()) {
  await accountChooser.click();
}
```

**Docker에서 발생하지 않은 이유:**
- Docker 컨테이너는 매번 새로운 브라우저 세션 사용

---

### 사례 4: OAuth 동의 페이지 "Continue" 버튼

**증상:**
- Google OAuth 플로우가 "You're signing back in to Wavebridge Work Hub" 페이지에서 멈춤

**원인:**
- 개발용 Google Client ID는 매번 동의 페이지 표시
- 테스트 스크립트에 "Continue" 버튼 클릭 로직 없음

**해결:**
```typescript
// OAuth 동의 페이지 처리
const continueButton = page.locator('button:has-text("Continue")').first();
if (await continueButton.isVisible()) {
  await continueButton.click();
}
```

**Docker에서 발생하지 않은 이유 (추정):**
- 프로덕션용 Google Client ID 사용 시 동의가 자동 승인됨

---

### 사례 5: HubManager 500 에러

**증상:**
- Google OAuth 콜백(`/api/auth/google-callback`)에서 500 Internal Server Error 발생

**원인 (추정):**
- Railway 데이터베이스 연결 문제
- JWT 키 불일치
- 세션 스토어 오류

**해결 (진행 중):**
- HubManager 서버 로그 확인 필요
- 로컬 Docker PostgreSQL 사용 권장

**Docker에서 발생하지 않은 이유:**
- 로컬 PostgreSQL 컨테이너 사용으로 안정적인 DB 연결

---

## 권장 사항

### 1. 로컬 개발 환경 설정

#### 신규 개발자 온보딩
```bash
# 1. 템플릿 파일 복사
cp .env.template .env.local

# 2. 필수 값 입력 (Google Client ID, DB URL 등)
nano .env.local

# 3. 환경변수 검증
npm run validate-env

# 4. 로컬 PostgreSQL 시작
docker run -d --name hubmanager-postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=hubmanager \
  -p 5432:5432 \
  postgres:15

# 5. 개발 서버 시작
npm run dev
```

### 2. Docker 스테이징 테스트

```bash
# Docker로 로컬 스테이징 환경 구축
docker-compose -f docker-compose.staging.yml up --build

# E2E 테스트 실행
npm run test:e2e:docker
```

### 3. 환경변수 검증 자동화

#### package.json에 추가
```json
{
  "scripts": {
    "validate-env": "bash scripts/validate-local-env.sh",
    "predev": "npm run validate-env",
    "pretest:e2e": "npm run validate-env"
  }
}
```

#### scripts/validate-local-env.sh
```bash
#!/bin/bash
echo "🔍 Validating local environment variables..."

required_vars=(
  "NEXT_PUBLIC_HUB_MANAGER_URL"
  "NEXT_PUBLIC_API_URL"
  "GOOGLE_CLIENT_ID"
  "GOOGLE_CLIENT_SECRET"
  "GOOGLE_REDIRECT_URI"
  "DATABASE_URL"
)

missing=0
for var in "${required_vars[@]}"; do
  value=$(grep "^$var=" .env.local 2>/dev/null | cut -d= -f2)
  if [ -z "$value" ]; then
    echo "❌ Missing: $var"
    missing=$((missing + 1))
  else
    # URL 검증
    if [[ $var == *"URL"* ]] && [[ $value == *"3090"* ]]; then
      echo "⚠️  Suspicious: $var=$value (should be 4090?)"
    else
      echo "✅ $var=✓"
    fi
  fi
done

if [ $missing -gt 0 ]; then
  echo ""
  echo "❌ $missing required environment variable(s) missing"
  echo "💡 Copy .env.template to .env.local and fill in the values"
  exit 1
fi

echo ""
echo "✅ All required environment variables are set"
```

### 4. E2E 테스트 작성 가이드

#### 환경별 테스트 전략
```typescript
// tests/config.ts
export const getTestConfig = () => {
  const env = process.env.TEST_ENV || 'local';

  const configs = {
    local: {
      baseURL: 'http://localhost:3010',
      hubManagerURL: 'http://localhost:4090',
      expectDevLogin: true,  // 개발 모드 로그인 버튼 있음
      expectConsentPage: true,  // OAuth 동의 페이지 매번 표시
      expectAccountChooser: true,  // 계정 선택 페이지 가능
    },
    docker: {
      baseURL: 'http://localhost:4400',
      hubManagerURL: 'http://localhost:4400',
      expectDevLogin: false,  // 개발 모드 기능 없음
      expectConsentPage: false,  // 동의 자동 승인
      expectAccountChooser: false,  // 항상 새 세션
    },
  };

  return configs[env];
};
```

#### 환경별 셀렉터 사용
```typescript
const config = getTestConfig();

// 개발 모드 고려한 로그인 버튼 선택
const loginButton = config.expectDevLogin
  ? page.locator('button:has-text("HubManager로 로그인")')  // 구체적으로 지정
  : page.locator('button:has-text("로그인")').first();  // 하나뿐이므로 무관

await loginButton.click();

// OAuth 동의 페이지 처리
if (config.expectConsentPage) {
  const continueButton = page.locator('button:has-text("Continue")');
  if (await continueButton.isVisible()) {
    await continueButton.click();
  }
}
```

---

## 트러블슈팅 체크리스트

### 로컬 개발 환경 문제 발생 시

- [ ] `.env.local` 파일 존재 여부 확인
- [ ] 환경변수 값 검증 (`npm run validate-env`)
- [ ] 포트 번호 확인 (HubManager: 4090, SalesHub: 4010)
- [ ] 서버 재시작 여부 확인 (환경변수 변경 후)
- [ ] 로컬 PostgreSQL 컨테이너 실행 확인
- [ ] Google OAuth Redirect URI 등록 확인
- [ ] 브라우저 캐시/쿠키 삭제

### Docker 스테이징 환경 문제 발생 시

- [ ] `docker-compose.yml` 환경변수 확인
- [ ] Docker 이미지 재빌드 (`--build` 플래그)
- [ ] 컨테이너 로그 확인 (`docker logs <container>`)
- [ ] 네트워크 연결 확인 (`docker network inspect`)
- [ ] PostgreSQL 컨테이너 상태 확인
- [ ] Nginx 라우팅 설정 확인

---

## 결론

로컬 개발 환경과 Docker 스테이징 환경은 **환경변수 관리**, **빌드 방식**, **개발 기능 활성화**, **OAuth 설정** 등에서 큰 차이가 있습니다. Docker 스테이징 환경은 프로덕션과 동일한 설정을 사용하므로 더 안정적이지만, 로컬 개발 환경은 편의성을 위해 추가 기능을 제공합니다.

**권장 사항:**
1. 로컬 개발 시 `.env.template` 파일 활용
2. 환경변수 자동 검증 스크립트 실행
3. E2E 테스트는 Docker 스테이징 환경에서 최종 검증
4. 로컬 개발 시 발생한 문제는 Docker에서 재현 여부 확인

---

작성일: 2026-01-06
마지막 업데이트: 2026-01-06
작성자: Claude (AI Assistant)
