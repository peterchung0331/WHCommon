# Oracle Cloud 배포 가이드

모든 WorkHub 프로젝트는 오라클 서버에서 직접 빌드하고 배포합니다.

## 배포 원칙 (2026-01-11 변경)

- ✅ **오라클 서버에서 빌드**: Git pull 후 Docker Compose로 직접 빌드
- ✅ **스테이징/프로덕션 동시 운영**: 4400(스테이징), 4500(프로덕션)
- ✅ **이미지 태그 관리**: staging, production, rollback
- ❌ **로컬 빌드 후 전송**: 더 이상 사용하지 않음

## 배포 환경 정보

### Oracle Cloud 서버
- **IP**: `158.180.95.246`
- **User**: `ubuntu`
- **SSH Key**: `~/.ssh/oracle-cloud.key` (WSL), `C:\GitHub\WHCommon\SSHkey\ssh-key-2026-01-01.key` (Windows)
- **SSH Alias**: `ssh oracle-cloud`

### 환경별 포트
| 환경 | Nginx 포트 | 접속 URL |
|------|-----------|---------|
| **스테이징** | 4400 | http://158.180.95.246:4400 |
| **프로덕션** | 4500/80 | http://workhub.biz |

### 프로젝트별 내부 포트 (Docker 네트워크 내)
| 허브 | Backend 포트 | Location |
|------|-------------|----------|
| **WBHubManager** | 4090 | `/` |
| **WBSalesHub** | 4010 | `/saleshub` |
| **WBFinHub** | 4020 | `/finhub` |
| **WBOnboardingHub** | 4030 | `/onboarding` |
| **HWTestAgent** | 4100 | `/testagent` |

### 데이터베이스 계정 정보

**⚠️ 중요: 각 허브는 독립된 데이터베이스를 사용합니다**

모든 허브는 PostgreSQL을 사용하며, 각 허브별로 독립된 데이터베이스가 할당되어 있습니다.

| 허브 | 데이터베이스명 | DATABASE_URL |
|------|--------------|--------------|
| **WBHubManager** | `wbhubmanager` | `postgresql://workhub:PASSWORD@host.docker.internal:5432/wbhubmanager` |
| **WBSalesHub** | `wbsaleshub` | `postgresql://workhub:PASSWORD@host.docker.internal:5432/wbsaleshub` |
| **WBFinHub** | `wbfinhub` | `postgresql://workhub:PASSWORD@host.docker.internal:5432/wbfinhub` |
| **WBOnboardingHub** | `wbonboardinghub` | `postgresql://workhub:PASSWORD@host.docker.internal:5432/wbonboardinghub` |
| **HWTestAgent** | `testagent` | `postgresql://workhub:PASSWORD@host.docker.internal:5432/testagent` |

**공통 설정**:
- **사용자명**: `workhub`
- **비밀번호**: `.env.staging` / `.env.prd` 파일에서 관리
- **호스트**: `host.docker.internal` (Docker 컨테이너에서 호스트 접근)
- **포트**: `5432`

**배포 시 체크리스트**:
1. ✅ 각 허브의 `.env.staging` / `.env.prd`에서 `DATABASE_URL` 확인
2. ✅ 데이터베이스명이 허브명과 일치하는지 검증
3. ✅ 비밀번호가 올바르게 설정되었는지 확인
4. ✅ 컨테이너 로그에서 DB 연결 성공 확인

**흔한 오류**:
- ❌ `DATABASE_URL=postgresql://workhub:***@host.docker.internal:5432/hubmanager` (잘못된 DB명)
- ✅ `DATABASE_URL=postgresql://workhub:***@host.docker.internal:5432/wbsaleshub` (올바른 DB명)

## 오라클 서버 디렉토리 구조

```
/home/ubuntu/workhub/
├── WBHubManager/              # Git clone
├── WBSalesHub/                # Git clone
├── WBFinHub/                  # Git clone
├── WBOnboardingHub/           # Git clone
├── HWTestAgent/               # Git clone
├── config/
│   ├── .env.common            # 공통 (DB, OAuth, 세션)
│   ├── .env.staging           # 스테이징 (PORT=4400)
│   ├── .env.production        # 프로덕션 (PORT=4500)
│   └── keys/
│       ├── jwt_private.pem    # chmod 600
│       └── jwt_public.pem     # chmod 644
├── docker-compose.yml         # 통합 설정
├── nginx/
│   └── nginx.conf             # 4400/4500 라우팅
└── scripts/
    ├── deploy-staging.sh      # 스테이징 배포
    ├── promote-production.sh  # 프로덕션 승격
    ├── rollback-production.sh # 롤백
    └── cleanup-docker.sh      # Docker 정리
```

## BuildKit 캐시 사용 (필수)

모든 빌드는 **BuildKit을 활성화**하고 **순차 빌드 스크립트**를 사용해야 합니다.

### BuildKit이란?
- Docker의 차세대 빌드 엔진으로, 빌드 성능을 크게 향상시킵니다.
- **캐시 마운트** 기능을 통해 npm 패키지를 재사용하여 다운로드 시간을 70-90% 절감합니다.
- 오라클 서버의 네트워크 제약 환경에서 빌드 안정성을 보장합니다.

### 순차 빌드 스크립트 사용

```bash
# BuildKit 활성화
export DOCKER_BUILDKIT=1

# 순차 빌드 (리소스 경합 방지)
cd /home/ubuntu/workhub
./WBHubManager/scripts/build-sequential.sh production

# 또는 스테이징 빌드
./WBHubManager/scripts/build-sequential.sh staging
```

**중요**: 동시 빌드(`docker-compose build --parallel`)는 **사용하지 마세요**. 오라클 서버의 메모리/네트워크 경합으로 빌드가 실패할 수 있습니다.

### Dockerfile에서 BuildKit 캐시 확인

모든 프로젝트의 Dockerfile에 다음 패턴이 적용되어 있어야 합니다:

```dockerfile
# deps 단계에서 npm ci 전에 타임아웃 설정
RUN npm config set fetch-timeout 120000 && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000

# BuildKit 캐시 마운트로 npm 패키지 재사용
RUN --mount=type=cache,target=/root/.npm \
    npm ci
RUN --mount=type=cache,target=/root/.npm \
    npm --prefix frontend ci
```

이 설정이 없으면 매번 전체 npm 패키지를 다운로드하여 빌드가 매우 느리고 네트워크 타임아웃에 취약합니다.

## 배포 프로세스

### 1. 스테이징 배포

**⚠️ 중요: 오라클 환경 HTTPS 필수**
- 스테이징 환경의 모든 URL은 `https://staging.workhub.biz` 형태 (포트 번호 없음)
- `.env.staging` 파일의 모든 URL은 반드시 `https://`로 시작
- SSL 인증서: Let's Encrypt (staging.workhub.biz)
- nginx-staging이 포트 443(HTTPS)으로 SSL 터미네이션 수행
- 예시:
  ```bash
  APP_URL=https://staging.workhub.biz
  SALESHUB_URL=https://staging.workhub.biz/saleshub
  GOOGLE_REDIRECT_URI=https://staging.workhub.biz/api/auth/google-callback
  ```

#### 방법 1: `.env.staging` 파일 사용 (권장)

각 프로젝트에 `.env.staging` 파일이 있으면 이 방법을 사용합니다.

```bash
# 1. 오라클 서버 접속
ssh oracle-cloud

# 2. 프로젝트 디렉토리로 이동
cd /home/ubuntu/workhub/WBHubManager

# 3. Git pull로 최신 코드 가져오기
git pull

# 4. BuildKit 활성화
export DOCKER_BUILDKIT=1

# 5. 스테이징 이미지 빌드
DOCKER_BUILDKIT=1 docker build -t wbhubmanager:staging .

# 6. 기존 스테이징 컨테이너 중지 및 삭제
docker rm -f wbhubmanager-staging

# 7. .env.staging 파일을 사용하여 컨테이너 실행
docker run -d \
  --name wbhubmanager-staging \
  --network workhub-network \
  --add-host host.docker.internal:host-gateway \
  --env-file .env.staging \
  --health-cmd='wget -q --spider http://localhost:4090/api/health || exit 1' \
  --health-interval=30s \
  --health-timeout=10s \
  --health-retries=3 \
  --health-start-period=40s \
  wbhubmanager:staging

# 8. 로그 확인
docker logs -f wbhubmanager-staging

# 9. 스테이징 테스트
# 브라우저: https://staging.workhub.biz
```

**동일하게 WBSalesHub, WBFinHub에 적용**:
```bash
# WBSalesHub
cd /home/ubuntu/workhub/WBSalesHub
git pull
DOCKER_BUILDKIT=1 docker build -t wbsaleshub:staging .
docker rm -f wbsaleshub-staging
docker run -d --name wbsaleshub-staging --network workhub-network --env-file .env.staging wbsaleshub:staging

# WBFinHub
cd /home/ubuntu/workhub/WBFinHub
git pull
DOCKER_BUILDKIT=1 docker build -t wbfinhub:staging .
docker rm -f wbfinhub-staging
docker run -d --name wbfinhub-staging --network workhub-network --env-file .env.staging wbfinhub:staging
```

#### 방법 2: Docker Compose 사용 (선택)

```bash
# 1. 오라클 서버 접속
ssh oracle-cloud

# 2. BuildKit 활성화
export DOCKER_BUILDKIT=1

# 3. 순차 빌드 실행
cd /home/ubuntu/workhub
./WBHubManager/scripts/build-sequential.sh staging

# 4. 스테이징 실행
docker-compose --profile staging up -d

# 5. 스테이징 테스트
# 브라우저: http://158.180.95.246:4400
```

### 2. 프로덕션 승격

**⚠️ 중요: 오라클 환경 HTTPS 필수**
- 프로덕션 환경의 모든 URL은 `https://workhub.biz` 형태 (포트 번호 없음)
- `.env.prd` 파일의 모든 URL은 반드시 `https://`로 시작
- SSL 인증서: Let's Encrypt (workhub.biz, *.workhub.biz)
- nginx-prod가 포트 443(HTTPS)으로 SSL 터미네이션 수행
- 예시:
  ```bash
  APP_URL=https://workhub.biz
  SALESHUB_URL=https://workhub.biz/saleshub
  GOOGLE_REDIRECT_URI=https://workhub.biz/api/auth/google-callback
  ```

```bash
# 1. 스테이징 테스트 완료 후
cd /home/ubuntu/workhub

# 2. BuildKit 활성화
export DOCKER_BUILDKIT=1

# 3. 프로덕션 빌드
./WBHubManager/scripts/build-sequential.sh production

# 4. 프로덕션 실행
docker-compose --profile production up -d

# 브라우저: https://workhub.biz
```

### 3. 롤백 (문제 발생 시)

```bash
./scripts/rollback-production.sh
```

## 환경변수 관리

### 파일 구조
| 파일 | 용도 | Doppler 환경 |
|------|------|-------------|
| `config/.env.common` | 공통 시크릿 (DB, OAuth) | staging/production 공유 |
| `config/.env.staging` | 스테이징 설정 (PORT=4400) | - |
| `config/.env.production` | 프로덕션 설정 (PORT=4500) | - |

### .env.common 예시
```env
# 데이터베이스
DATABASE_URL=postgresql://workhub:PASSWORD@localhost:5432/hubmanager

# Google OAuth
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx

# 세션
SESSION_SECRET=min-32-chars-random-string

# 허브 간 통신 (Docker 네트워크)
WBFINHUB_BACKEND_URL=http://wbfinhub:4020
WBSALESHUB_BACKEND_URL=http://wbsaleshub:4010
```

### .env.staging 예시
```env
NODE_ENV=production
DOCKER_PORT=4400
# ⚠️ 오라클 환경은 항상 HTTPS 사용
APP_URL=https://staging.workhub.biz
FRONTEND_URL=https://staging.workhub.biz
GOOGLE_REDIRECT_URI=https://staging.workhub.biz/api/auth/google-callback
SALESHUB_URL=https://staging.workhub.biz/saleshub
FINHUB_URL=https://staging.workhub.biz/finhub
```

### .env.production 예시
```env
NODE_ENV=production
DOCKER_PORT=4500
# ⚠️ 오라클 환경은 항상 HTTPS 사용
APP_URL=https://workhub.biz
FRONTEND_URL=https://workhub.biz
GOOGLE_REDIRECT_URI=https://workhub.biz/api/auth/google-callback
SALESHUB_URL=https://workhub.biz/saleshub
FINHUB_URL=https://workhub.biz/finhub
COOKIE_DOMAIN=.workhub.biz
```

### JWT 키 관리
- **위치**: `config/keys/jwt_private.pem`, `config/keys/jwt_public.pem`
- **권한**: `chmod 600 jwt_private.pem`, `chmod 644 jwt_public.pem`
- **마운트**: Docker Compose에서 읽기 전용 볼륨 마운트

## Docker Compose 설정

### 프로필 기반 실행
```yaml
# docker-compose.yml
services:
  wbhubmanager-staging:
    profiles: ["staging"]
    image: wbhubmanager:staging
    env_file:
      - ./config/.env.common
      - ./config/.env.staging
    volumes:
      - ./config/keys:/app/server/keys:ro

  wbhubmanager-prod:
    profiles: ["production"]
    image: wbhubmanager:production
    env_file:
      - ./config/.env.common
      - ./config/.env.production
    volumes:
      - ./config/keys:/app/server/keys:ro
```

### 이미지 태그 관리
| 태그 | 용도 |
|------|------|
| `:staging` | 현재 스테이징 버전 |
| `:production` | 현재 프로덕션 버전 |
| `:rollback` | 이전 프로덕션 버전 (롤백용) |

## 배포 스크립트 상세

### deploy-staging.sh
```bash
#!/bin/bash
set -e

cd /home/ubuntu/workhub

# Git 최신 코드 가져오기
for hub in WBHubManager WBSalesHub WBFinHub WBOnboardingHub HWTestAgent; do
  echo "Pulling $hub..."
  cd $hub && git pull && cd ..
done

# BuildKit 활성화 및 빌드
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
docker-compose build --parallel

# 이미지 태그
for hub in wbhubmanager wbsaleshub wbfinhub wbonboardinghub hwtestagent; do
  docker tag ${hub}:latest ${hub}:staging
done

# 스테이징 실행
docker-compose --profile staging up -d

# 오래된 이미지 정리
./scripts/cleanup-docker.sh

echo "Staging deployed: http://158.180.95.246:4400"
```

### promote-production.sh
```bash
#!/bin/bash
set -e

cd /home/ubuntu/workhub

# 현재 프로덕션을 롤백으로 백업
for hub in wbhubmanager wbsaleshub wbfinhub wbonboardinghub hwtestagent; do
  docker tag ${hub}:production ${hub}:rollback 2>/dev/null || true
done

# 스테이징을 프로덕션으로 승격
for hub in wbhubmanager wbsaleshub wbfinhub wbonboardinghub hwtestagent; do
  docker tag ${hub}:staging ${hub}:production
done

# 프로덕션 재시작
docker-compose --profile production up -d

echo "Production promoted: http://workhub.biz"
```

### rollback-production.sh
```bash
#!/bin/bash
set -e

cd /home/ubuntu/workhub

# 롤백 이미지로 복원
for hub in wbhubmanager wbsaleshub wbfinhub wbonboardinghub hwtestagent; do
  docker tag ${hub}:rollback ${hub}:production
done

# 프로덕션 재시작
docker-compose --profile production up -d

echo "Production rolled back"
```

## Nginx 설정

### nginx.conf
```nginx
# 스테이징 (4400)
server {
    listen 4400;

    location / {
        proxy_pass http://wbhubmanager-staging:4090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /saleshub {
        proxy_pass http://wbsaleshub-staging:4010;
    }

    location /finhub {
        proxy_pass http://wbfinhub-staging:4020;
    }

    location /onboarding {
        proxy_pass http://wbonboardinghub-staging:4030;
    }
}

# 프로덕션 (4500/80)
server {
    listen 4500;
    listen 80;
    server_name workhub.biz;

    location / {
        proxy_pass http://wbhubmanager-prod:4090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /saleshub {
        proxy_pass http://wbsaleshub-prod:4010;
    }

    location /finhub {
        proxy_pass http://wbfinhub-prod:4020;
    }

    location /onboarding {
        proxy_pass http://wbonboardinghub-prod:4030;
    }
}
```

## 배포 후 확인사항

### 1. 컨테이너 실행 확인
```bash
ssh oracle-cloud "docker ps | grep -E 'staging|prod'"
```

### 2. 로그 확인
```bash
ssh oracle-cloud "docker logs -f wbhubmanager-staging"
```

### 3. 헬스 체크
```bash
# 스테이징
curl http://158.180.95.246:4400/api/health

# 프로덕션
curl http://workhub.biz/api/health
```

## 초기 설정 (최초 1회)

### 1. 오라클 서버 준비
```bash
# SSH 접속
ssh oracle-cloud

# 디렉토리 생성
mkdir -p /home/ubuntu/workhub/{config/keys,scripts,nginx}

# Git clone (모든 허브)
cd /home/ubuntu/workhub
git clone git@github.com:your-org/WBHubManager.git
git clone git@github.com:your-org/WBSalesHub.git
git clone git@github.com:your-org/WBFinHub.git
git clone git@github.com:your-org/WBOnboardingHub.git
git clone git@github.com:your-org/HWTestAgent.git
```

### 2. 환경변수 및 키 설정
```bash
# 환경변수 파일 생성
nano /home/ubuntu/workhub/config/.env.common
nano /home/ubuntu/workhub/config/.env.staging
nano /home/ubuntu/workhub/config/.env.production

# JWT 키 복사
scp jwt_private.pem ubuntu@158.180.95.246:/home/ubuntu/workhub/config/keys/
scp jwt_public.pem ubuntu@158.180.95.246:/home/ubuntu/workhub/config/keys/

# 권한 설정
chmod 600 /home/ubuntu/workhub/config/keys/jwt_private.pem
chmod 644 /home/ubuntu/workhub/config/keys/jwt_public.pem
```

### 3. 방화벽 설정
- 오라클 클라우드 콘솔 > Networking > Security Lists
- Ingress Rule 추가: 4400 포트 허용

## Doppler 연동

### 환경 구성 (3환경)
| Doppler Config | 용도 | 로컬 파일 | 오라클 서버 파일 |
|----------------|------|----------|-----------------|
| `dev_wbhubmanager` | 로컬 개발 | `.env.local` | - |
| `stg_wbhubmanager` | 스테이징 | `.env.staging` | `/home/ubuntu/workhub/WBHubManager/.env.staging` |
| `prd_wbhubmanager` | 프로덕션 | `.env.prd` | `/home/ubuntu/workhub/WBHubManager/.env.prd` |

### Doppler Config 명명 규칙
| 환경 | HubManager | SalesHub | FinHub | OnboardingHub |
|------|------------|----------|--------|---------------|
| Development | `dev_wbhubmanager` | `dev_wbsaleshub` | `dev_wbfinhub` | `dev_wbonboardinghub` |
| Staging | `stg_wbhubmanager` | `stg_wbsaleshub` | `stg_wbfinhub` | `stg_wbonboardinghub` |
| Production | `prd_wbhubmanager` | `prd_wbsaleshub` | `prd_wbfinhub` | `prd_wbonboardinghub` |

### 동기화 방향
- **로컬 → 도플러**: 로컬에서 환경변수 수정 후 도플러에 업로드
- **도플러 → 로컬**: `doppler secrets download --no-file --format env > .env.xxx`

### 업로드 스크립트
```bash
# WHCommon에서 실행
cd /mnt/c/GitHub/WHCommon

# 특정 허브 스테이징 업로드 예시
TOKEN=$(grep "DOPPLER_TOKEN_HUBMANAGER_STG" .env.doppler | cut -d'=' -f2)
doppler secrets upload /mnt/c/GitHub/WBHubManager/.env.staging --token "$TOKEN"

# 특정 허브 프로덕션 업로드 예시
TOKEN=$(grep "DOPPLER_TOKEN_HUBMANAGER_PRD" .env.doppler | cut -d'=' -f2)
doppler secrets upload /mnt/c/GitHub/WBHubManager/.env.prd --token "$TOKEN"
```

### 다운로드 스크립트
```bash
# 특정 허브 스테이징 다운로드 예시
TOKEN=$(grep "DOPPLER_TOKEN_SALESHUB_STG" .env.doppler | cut -d'=' -f2)
doppler secrets download --no-file --format env --token "$TOKEN" > /mnt/c/GitHub/WBSalesHub/.env.staging
```

## 트러블슈팅

### Docker 빌드 실패

#### 1. npm ci 단계에서 멈추거나 타임아웃
**원인**: 네트워크 불안정, BuildKit 캐시 미사용, 동시 빌드로 인한 리소스 경합

**해결**:
```bash
# BuildKit 활성화 확인
echo $DOCKER_BUILDKIT  # "1"이 출력되어야 함
export DOCKER_BUILDKIT=1

# 순차 빌드 사용 (필수)
./WBHubManager/scripts/build-sequential.sh production

# Dockerfile에서 BuildKit 캐시 설정 확인
grep "mount=type=cache" WBHubManager/Dockerfile
```

#### 2. "ERROR: failed to solve" 메시지
**원인**: BuildKit 캐시 손상, 디스크 공간 부족

**해결**:
```bash
# BuildKit 캐시 정리
docker builder prune -a

# 디스크 공간 확인
df -h

# 재빌드 (순차 빌드 사용)
export DOCKER_BUILDKIT=1
./WBHubManager/scripts/build-sequential.sh production
```

#### 3. Exit 255 에러 (Docker Compose 버그)
**원인**: Docker Compose v5.0.0의 BuildKit 캐시 마운트 처리 버그

**증상**:
```bash
$ docker compose build
ERROR: failed to solve: ...
Exit code: 255
```

**해결**: `docker build` 직접 호출 사용 (docker compose 대신)
```bash
# ❌ 실패하는 방식
docker compose build

# ✅ 올바른 방식
cd /home/ubuntu/workhub/WBHubManager
DOCKER_BUILDKIT=1 docker build -t wbhubmanager:staging .
```

**참고**: [2026-01-12 최적화 작업](/home/peterchung/WHCommon/작업완료/2026-01-12-docker-build-optimization.md)에서 근본 원인 분석 완료

#### 4. Exit 137 에러 (OOM Killer)
**원인**: 빌드 중 메모리 부족 또는 디스크 공간 부족

**해결**:
```bash
# 메모리 및 디스크 확인
free -h
df -h /

# Dockerfile에 NODE_OPTIONS 추가 확인
grep "NODE_OPTIONS" WBHubManager/Dockerfile
# 출력 예상: ENV NODE_OPTIONS="--max-old-space-size=2048"

# 디스크 부족 시 정리
docker system prune -a
```

#### 5. npm cache clean --force 충돌 에러
**증상**: ENOTEMPTY 에러, 빌드 중단

**원인**: `npm cache clean --force`가 BuildKit 캐시 마운트와 충돌

**해결**: Dockerfile에서 `npm cache clean --force` 제거
```dockerfile
# ❌ 잘못된 방식
RUN --mount=type=cache,target=/root/.npm \
    npm ci && npm cache clean --force

# ✅ 올바른 방식
RUN --mount=type=cache,target=/root/.npm \
    npm ci
```

**참고**: claude-context.md 최적화 가이드 명시적 금지 사항

#### 6. SSH 연결 끊김
**원인**: 빌드 중 출력이 없어서 SSH 유휴 타임아웃 발생

**해결**:
```bash
# ~/.ssh/config에 keep-alive 설정 추가
Host oracle-cloud
    ServerAliveInterval 60
    ServerAliveCountMax 120

# tmux 세션에서 빌드 실행
ssh oracle-cloud
tmux new -s build
export DOCKER_BUILDKIT=1
./WBHubManager/scripts/build-sequential.sh production
# Ctrl+B, D로 세션 분리
# 재접속: tmux attach -t build
```

### 포트 충돌
```bash
# 포트 사용 확인
sudo netstat -tulpn | grep -E '4400|4500'

# 기존 컨테이너 중지
docker-compose --profile staging down
docker-compose --profile production down
```

### 환경변수 문제
```bash
# 컨테이너 환경변수 확인
docker exec wbhubmanager-staging env | grep -E 'NODE_ENV|PUBLIC_URL'

# 환경변수 파일 확인
cat /home/ubuntu/workhub/config/.env.common
```

## 참고사항

- **로컬 빌드 스크립트 폐기**: 각 허브의 `deploy-oracle.sh`는 더 이상 사용하지 않음
- **스테이징 필수 테스트**: 프로덕션 배포 전 반드시 스테이징에서 테스트
- **롤백 준비**: 항상 `:rollback` 태그로 이전 버전 보관
- **WSL 우선 원칙**: 배포 관련 명령은 WSL에서 실행
- **BuildKit 필수**: 모든 빌드는 `export DOCKER_BUILDKIT=1` 후 순차 빌드 스크립트 사용
- **동시 빌드 금지**: `docker-compose build --parallel` 사용 불가 (리소스 경합 발생)

## BuildKit 캐시 동작 원리

### 캐시 저장 위치
- 호스트 머신: `/var/lib/docker/buildkit/cache`
- 빌드 시 `/root/.npm` → 호스트 캐시로 마운트
- 다음 빌드 시 캐시 재사용 → npm 다운로드 생략

### 캐시 확인 방법
```bash
# BuildKit 캐시 크기 확인
docker system df -v | grep -A5 "Build Cache"

# 캐시 사용 통계 확인 (빌드 중 출력)
# => CACHED [deps 4/5] RUN npm ci  # 캐시 히트
```

### 캐시 관리
```bash
# 90일 이상 사용하지 않은 캐시만 삭제
docker builder prune --keep-storage 50GB

# 모든 캐시 삭제 (문제 발생 시)
docker builder prune -a
```

## 상대 경로 패턴 (최신 권장 방식)

### 개요
- **목적**: 빌드 시 환경변수 의존성 제거 → 캐시 100% 활용
- **효과**: 스테이징 → 프로덕션 승격 시 재빌드 불필요 (0초)
- **적용**: WBSalesHub(완료), WBHubManager(예정), WBFinHub(예정)

### 핵심 원칙
1. **빌드 시**: `NEXT_PUBLIC_API_URL` 환경변수를 사용하지 않음
2. **런타임 시**: 모든 API 호출은 상대 경로 (`/api/*`) 사용
3. **라우팅**: Nginx가 `/api/*` 요청을 백엔드로 프록시

### 개발 환경 vs 프로덕션 환경

#### 개발 환경 (`npm run dev`)
```
브라우저 → GET /api/users
         ↓
Next.js rewrites → http://localhost:4090/api/users
         ↓
백엔드 응답
```

#### 프로덕션 환경 (Docker + Nginx)
```
브라우저 → GET /api/users
         ↓
상대 경로 해석 → http://workhub.biz/api/users
         ↓
Nginx 프록시 → http://wbhubmanager:4090/api/users
         ↓
백엔드 응답
```

### 배포 워크플로우 개선

#### 기존 방식 (BUILD ARG)
```bash
# 스테이징 빌드 (3-5분)
DOCKER_BUILDKIT=1 docker build \
  --build-arg NEXT_PUBLIC_API_URL="http://158.180.95.246:4400" \
  -t wbhubmanager:staging .

# 프로덕션 빌드 (3-5분 추가!)
DOCKER_BUILDKIT=1 docker build \
  --build-arg NEXT_PUBLIC_API_URL="https://workhub.biz" \
  -t wbhubmanager:production .

# 총 소요 시간: 6-10분
```

#### 상대 경로 방식 (권장)
```bash
# 스테이징 빌드 (3-5분)
DOCKER_BUILDKIT=1 docker build -t wbhubmanager:staging .

# 프로덕션 승격 (0초!)
docker tag wbhubmanager:staging wbhubmanager:production

# 총 소요 시간: 3-5분 (50% 감소!)
```

### 구현 체크리스트

#### 1. next.config.js 수정
```javascript
// env 객체 제거
const nextConfig = {
  output: 'export',  // Static Export 모드

  async rewrites() {
    // 개발 환경에서만 rewrites 사용
    if (process.env.NODE_ENV === 'development') {
      return [
        {
          source: '/api/:path*',
          destination: 'http://localhost:4090/api/:path*',
        },
      ];
    }
    return [];
  },
};
```

#### 2. API 클라이언트 수정
```typescript
// 모든 API 클라이언트에서 상대 경로 사용
const API_BASE_URL = '';  // 빈 문자열
const baseURL = '/api';   // 상대 경로
```

#### 3. Dockerfile 수정
```dockerfile
# BUILD ARG 제거
# ARG NEXT_PUBLIC_API_URL  ← 삭제
# ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}  ← 삭제

# 빌드 명령어는 그대로 유지
RUN npm run build
```

#### 4. docker-compose.yml 수정
```yaml
# build args 제거
wbhubmanager:
  build:
    context: .
    dockerfile: Dockerfile
    # args 섹션 삭제
```

#### 5. Nginx 설정 확인 (변경 불필요)
```nginx
# 이미 올바르게 설정되어 있음
location /api/ {
    proxy_pass http://wbhubmanager:4090/api/;
}
```

### 검증 방법

#### 로컬 개발 환경
```bash
cd /home/peterchung/WBHubManager/frontend
npm run dev
# 브라우저: http://localhost:3090
# 네트워크 탭에서 API 요청 확인
```

#### Docker 스테이징 환경
```bash
DOCKER_BUILDKIT=1 docker build -t wbhubmanager:staging .
docker-compose --profile staging up -d
# 브라우저: http://158.180.95.246:4400
```

#### 캐시 재사용 확인
```bash
# 프로덕션 승격 (재빌드 없음)
docker tag wbhubmanager:staging wbhubmanager:production
docker-compose --profile production up -d
# 즉시 실행됨 (빌드 시간 0초)
```

### 주의사항
- ⚠️ **개발 환경**: rewrites가 자동으로 프록시 처리
- ⚠️ **프로덕션 환경**: Nginx가 프록시 처리 (rewrites 비활성화)
- ⚠️ **Static Export 필수**: `output: 'export'` 설정 필요

### 참고 문서
- 계획서: `/home/peterchung/.claude/plans/robust-waddling-swan.md`
- 최적화 가이드: `/home/peterchung/WHCommon/tasks/tasks-docker-build-optimization-completed.md`
- 검증 사례: WBSalesHub (이미 운영 중)

## 최근 적용 사항 (2026-01-12)

### Docker 빌드 최적화 완료
**작업 문서**: [2026-01-12-docker-build-optimization.md](/home/peterchung/WHCommon/작업완료/2026-01-12-docker-build-optimization.md)

**주요 개선 사항**:
1. ✅ **Exit 255 근본 해결**: docker compose → docker build 직접 호출
2. ✅ **npm cache clean 제거**: BuildKit 캐시 충돌 방지
3. ✅ **NODE_OPTIONS 추가**: OOM 방지 (`--max-old-space-size=2048`)
4. ✅ **npm 타임아웃 설정**: 네트워크 불안정 대응
5. ✅ **--no-cache 플래그 제거**: BuildKit 캐시 100% 활용

**적용 허브**:
- WBHubManager: 완료 (스테이징 배포 완료)
- WBFinHub: 완료 (빌드 테스트 성공)
- WBSalesHub: 검증 완료 (이미 가이드 준수 상태)

**개선 효과**:
- 빌드 성공률: 50% → 95%+ (+45%p)
- 빌드 시간: 4.5분 → 3.1분 (-31%)
- 네트워크 트래픽: 350MB → 10MB (-97%)

**참고**: 모든 변경 사항은 claude-context.md 최적화 가이드 100% 준수

---
마지막 업데이트: 2026-01-12 (Docker 빌드 최적화 적용 완료)
