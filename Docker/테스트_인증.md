# Docker SSO í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

**ì‘ì„±ì¼:** 2025-12-31
**ëª©ì :** êµ¬ê¸€ OAuth ë° Hub ê°„ JWT SSO í†µì‹  ê²€ì¦
**ì†Œìš” ì‹œê°„:** 10-15ë¶„
**ì–¸ì œ ì‹¤í–‰:** SSO ê´€ë ¨ ë³€ê²½ í›„, Hub ê°„ í†µì‹  ê¸°ëŠ¥ ë³€ê²½ ì‹œ

---

## ê°œìš”

WBHub

Managerì™€ ê° Hub(WBFinHub, WBSalesHub, Onboarding) ê°„ Single Sign-On(SSO) ì¸ì¦ í”Œë¡œìš°ë¥¼ ì™„ì „íˆ ê²€ì¦í•˜ëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

Google OAuth ë¡œê·¸ì¸ë¶€í„° JWT í† í° ìƒì„±, Hub ê°„ í† í° ì „ì†¡ ë° ê²€ì¦ê¹Œì§€ ì „ì²´ SSO ì¸ì¦ íë¦„ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### SSO ì¸ì¦ í”Œë¡œìš°

```
ì‚¬ìš©ì
  â†“ 1. Google ë¡œê·¸ì¸ ìš”ì²­
WBHubManager
  â†“ 2. Google OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸
Google
  â†“ 3. ì¸ì¦ ì„±ê³µ í›„ ì½œë°±
WBHubManager
  â†“ 4. JWT í† í° ìƒì„± (RS256, Private Key)
  â†“ 5. Hub ì„ íƒ â†’ JWT í† í° ì „ë‹¬
WBFinHub
  â†“ 6. JWT ê²€ì¦ (Public Key)
  â†“ 7. ë¡œê·¸ì¸ ì™„ë£Œ
```

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ (7ê°œ)

1. **JWT Public Key ì—”ë“œí¬ì¸íŠ¸** - Hubê°€ Public Keyë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
2. **Hub Token ìƒì„± (ì„¸ì…˜ ì—†ìŒ)** - ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” Google OAuthë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ”ì§€ í™•ì¸
3. **Google OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸** - Google OAuth URL ìƒì„± ë° state íŒŒë¼ë¯¸í„° í™•ì¸
4. **Auth Callback ë¼ìš°íŠ¸** - Google OAuth ì½œë°± ì²˜ë¦¬
5. **Hub URL ì„¤ì •** - ê° Hubì˜ URLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
6. **SSO í™˜ê²½ë³€ìˆ˜** - JWT í‚¤ ë“± SSO ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ í™•ì¸
7. **ì»¨í…Œì´ë„ˆ ë¡œê·¸ ë¶„ì„** - SSO ê´€ë ¨ ë¡œê·¸ ë©”ì‹œì§€ í™•ì¸

---

## ì‹¤í–‰ ë°©ë²•

### ìë™ ì‹¤í–‰ (ê¶Œì¥)

```bash
cd c:/GitHub/WBHubManager
node scripts/docker-sso-test.cjs
```

### ğŸ“ í…ŒìŠ¤íŠ¸ í›„ ë¦¬í¬íŠ¸ ì‘ì„±

**ì¤‘ìš”:** í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ì—¬ ì €ì¥í•˜ì„¸ìš”.

1. **í…ŒìŠ¤íŠ¸ë¦¬í¬íŠ¸í¬ë§·** ì‚¬ìš©: `C:\GitHub\WorkHubShared\TestReport\í…ŒìŠ¤íŠ¸-ë¦¬í¬íŠ¸-í…œí”Œë¦¿.md`
2. **ì €ì¥ ìœ„ì¹˜**: `C:\GitHub\WorkHubShared\TestReport\YYYY-MM-DD-[í”„ë¡œì íŠ¸ëª…]-[í…ŒìŠ¤íŠ¸ëª…]-í…ŒìŠ¤íŠ¸.md`
3. **ì˜ˆì‹œ**: `2025-12-31-HubManager-SSO-í…ŒìŠ¤íŠ¸.md`

ë¦¬í¬íŠ¸ì—ëŠ” ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•˜ì„¸ìš”:
- í…ŒìŠ¤íŠ¸ ê²°ê³¼ (í†µê³¼/ì‹¤íŒ¨ í˜„í™©)
- ë°œê²¬ëœ ë¬¸ì œì  ë° ìˆ˜ì •ì‚¬í•­
- í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë³„ ìƒì„¸ ë¶„ì„
- ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­

**ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” ì‘ì—…:**
1. `common/railway-env.md`ì—ì„œ í™˜ê²½ë³€ìˆ˜ ì¶”ì¶œ
2. `.env.docker-sso-test` ì„ì‹œ íŒŒì¼ ìƒì„±
3. Docker ì´ë¯¸ì§€ ë¹Œë“œ
4. ì»¨í…Œì´ë„ˆ ì‹œì‘ (í¬íŠ¸ 14091)
5. 7ê°œ SSO í…ŒìŠ¤íŠ¸ ì‹¤í–‰
6. ê²°ê³¼ ìš”ì•½ ì¶œë ¥
7. í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ìë™ ì •ë¦¬

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 10-15ë¶„

---

## í…ŒìŠ¤íŠ¸ ìƒì„¸ ì„¤ëª…

### Test 1: JWT Public Key ì—”ë“œí¬ì¸íŠ¸

**ëª©ì :** Hubê°€ WBHubManagerì—ì„œ JWT Public Keyë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

**ì—”ë“œí¬ì¸íŠ¸:** `GET /api/auth/public-key`

**ìˆ˜ë™ í…ŒìŠ¤íŠ¸:**
```bash
curl http://localhost:14091/api/auth/public-key
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "publicKey": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgk...\n-----END PUBLIC KEY-----"
  }
}
```

**ê²€ì¦ í•­ëª©:**
- âœ… ìƒíƒœ ì½”ë“œ: 200 OK
- âœ… PEM í¬ë§· í™•ì¸ (`BEGIN PUBLIC KEY`, `END PUBLIC KEY` í¬í•¨)
- âœ… í‚¤ ê¸¸ì´: 400ì ì´ìƒ

**ì‹¤íŒ¨ ì‹œ:**
- `JWT_PUBLIC_KEY` í™˜ê²½ë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ í¬ë§·
- `common/railway-env.md`ì—ì„œ í™•ì¸ í•„ìš”

---

### Test 2: Hub Token ìƒì„± (ì„¸ì…˜ ì—†ìŒ)

**ëª©ì :** ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” Google OAuthë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ”ì§€ í™•ì¸

**ì—”ë“œí¬ì¸íŠ¸:** `POST /api/auth/generate-hub-token`

**í…ŒìŠ¤íŠ¸ Hub:** `wbfinhub`, `wbsaleshub`, `onboarding`

**ìˆ˜ë™ í…ŒìŠ¤íŠ¸:**
```bash
curl -X POST http://localhost:14091/api/auth/generate-hub-token \
  -H "Content-Type: application/json" \
  -d '{"hub_slug": "wbfinhub"}'
```

**ì˜ˆìƒ ì‘ë‹µ (ì„¸ì…˜ ì—†ìŒ):**
```json
{
  "success": true,
  "data": {
    "requires_auth": true,
    "auth_url": "https://accounts.google.com/o/oauth2/v2/auth?..."
  }
}
```

**ê²€ì¦ í•­ëª©:**
- âœ… `requires_auth: true`
- âœ… `auth_url`ì— Google OAuth URL í¬í•¨
- âœ… `state` íŒŒë¼ë¯¸í„°ì— `hub_slug` ì¸ì½”ë”©ë˜ì–´ ìˆìŒ

**state íŒŒë¼ë¯¸í„° ë””ì½”ë”© ì˜ˆì‹œ:**
```javascript
// URLì—ì„œ state ì¶”ì¶œ
const url = new URL(auth_url);
const state = url.searchParams.get('state');

// Base64 ë””ì½”ë”©
const decoded = JSON.parse(Buffer.from(state, 'base64').toString('utf-8'));
console.log(decoded.hub_slug); // "wbfinhub"
```

**ì‹¤íŒ¨ ì‹œ:**
- Google OAuth ì„¤ì • í™•ì¸ (`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`)
- `APP_URL` í™˜ê²½ë³€ìˆ˜ í™•ì¸

---

### Test 3: Google OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸

**ëª©ì :** Google OAuth ì—”ë“œí¬ì¸íŠ¸ê°€ ì˜¬ë°”ë¥´ê²Œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ”ì§€ í™•ì¸

**ì—”ë“œí¬ì¸íŠ¸:** `GET /api/auth/google-oauth?hub_slug={hub}`

**ìˆ˜ë™ í…ŒìŠ¤íŠ¸:**
```bash
curl -I http://localhost:14091/api/auth/google-oauth?hub_slug=wbfinhub
```

**ì˜ˆìƒ ì‘ë‹µ:**
```
HTTP/1.1 302 Found
Location: https://accounts.google.com/o/oauth2/v2/auth?client_id=...&redirect_uri=...&state=...
```

**ê²€ì¦ í•­ëª©:**
- âœ… ìƒíƒœ ì½”ë“œ: 302 Found (ë¦¬ë‹¤ì´ë ‰íŠ¸)
- âœ… Location í—¤ë”ì— `accounts.google.com` í¬í•¨
- âœ… `client_id`, `redirect_uri`, `state` íŒŒë¼ë¯¸í„° ì¡´ì¬

**Google OAuth URL íŒŒë¼ë¯¸í„°:**
- `client_id`: Google OAuth Client ID
- `redirect_uri`: `{APP_URL}/api/auth/callback`
- `response_type`: `code`
- `scope`: `email profile`
- `state`: Base64ë¡œ ì¸ì½”ë”©ëœ `{hub_slug, nonce}` JSON

**ì‹¤íŒ¨ ì‹œ:**
- `GOOGLE_CLIENT_ID` í™•ì¸
- `APP_URL` í™•ì¸ (Railway ë°°í¬ URL ë˜ëŠ” localhost)

---

### Test 4: Auth Callback ë¼ìš°íŠ¸

**ëª©ì :** Google OAuth ì½œë°± ë¼ìš°íŠ¸ê°€ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸

**ì—”ë“œí¬ì¸íŠ¸:** `GET /auth/callback`

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**

#### ì¼€ì´ìŠ¤ 1: Hub íŒŒë¼ë¯¸í„° ì—†ìŒ
```bash
curl http://localhost:14091/auth/callback
```

**ì˜ˆìƒ:** 200 OK ë˜ëŠ” 302 Redirect to `/hubs`

#### ì¼€ì´ìŠ¤ 2: Hub íŒŒë¼ë¯¸í„° ìˆìŒ
```bash
curl http://localhost:14091/auth/callback?hub=wbfinhub
```

**ì˜ˆìƒ:** 200 OK ë˜ëŠ” 302 Redirect (í† í° ìƒì„± ì‹œë„)

**ê²€ì¦ í•­ëª©:**
- âœ… ë¼ìš°íŠ¸ ì ‘ê·¼ ê°€ëŠ¥
- âœ… 500 ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠìŒ

**ì‹¤íŒ¨ ì‹œ:**
- Next.js ë¼ìš°íŒ… ì„¤ì • í™•ì¸
- `pages/auth/callback.tsx` ë˜ëŠ” `app/auth/callback/page.tsx` í™•ì¸

---

### Test 5: Hub URL ì„¤ì •

**ëª©ì :** ê° Hubì˜ URLì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

**ì—”ë“œí¬ì¸íŠ¸:** `GET /api/hubs`

**ìˆ˜ë™ í…ŒìŠ¤íŠ¸:**
```bash
curl http://localhost:14091/api/hubs
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "slug": "wbfinhub",
      "name": "WB FinHub",
      "url": "https://wbfinhub.up.railway.app",
      "status": "active"
    },
    {
      "id": 2,
      "slug": "wbsaleshub",
      "name": "WB SalesHub",
      "url": "https://wbsaleshub.up.railway.app",
      "status": "active"
    },
    {
      "id": 3,
      "slug": "onboarding",
      "name": "Onboarding Hub",
      "url": "https://onboarding.up.railway.app",
      "status": "active"
    }
  ]
}
```

**ê²€ì¦ í•­ëª©:**
- âœ… í•„ìˆ˜ Hub 3ê°œ ì¡´ì¬: `wbfinhub`, `wbsaleshub`, `onboarding`
- âœ… ê° Hubì˜ `url` í•„ë“œê°€ ì„¤ì •ë˜ì–´ ìˆìŒ
- âœ… `status`ê°€ `active`

**ì‹¤íŒ¨ ì‹œ:**
- ë°ì´í„°ë² ì´ìŠ¤ ì‹œë“œ ë°ì´í„° í™•ì¸
- Prisma migration ì‹¤í–‰ ì—¬ë¶€ í™•ì¸

---

### Test 6: SSO í™˜ê²½ë³€ìˆ˜

**ëª©ì :** SSOì— í•„ìš”í•œ ëª¨ë“  í™˜ê²½ë³€ìˆ˜ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸

**í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜:**
- `JWT_PRIVATE_KEY` - JWT í† í° ìƒì„±ìš© RSA Private Key
- `JWT_PUBLIC_KEY` - JWT í† í° ê²€ì¦ìš© RSA Public Key
- `GOOGLE_CLIENT_ID` - Google OAuth Client ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth Client Secret
- `APP_URL` - ì• í”Œë¦¬ì¼€ì´ì…˜ URL (ë¦¬ë‹¤ì´ë ‰íŠ¸ìš©)

**ìˆ˜ë™ í…ŒìŠ¤íŠ¸:**
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ í™˜ê²½ë³€ìˆ˜ í™•ì¸
docker exec wbhub-sso-test sh -c "echo \$JWT_PRIVATE_KEY" | head -n 1
docker exec wbhub-sso-test sh -c "echo \$JWT_PUBLIC_KEY" | head -n 1
docker exec wbhub-sso-test sh -c "echo \$GOOGLE_CLIENT_ID"
docker exec wbhub-sso-test sh -c "echo \$GOOGLE_CLIENT_SECRET"
docker exec wbhub-sso-test sh -c "echo \$APP_URL"
```

**ê²€ì¦ í•­ëª©:**
- âœ… ëª¨ë“  í™˜ê²½ë³€ìˆ˜ê°€ ë¹ˆ ê°’ì´ ì•„ë‹˜
- âœ… `JWT_PRIVATE_KEY`ê°€ `-----BEGIN PRIVATE KEY-----`ë¡œ ì‹œì‘
- âœ… `JWT_PUBLIC_KEY`ê°€ `-----BEGIN PUBLIC KEY-----`ë¡œ ì‹œì‘

**ì‹¤íŒ¨ ì‹œ:**
1. `common/railway-env.md` ì—´ê¸°
2. Railway ëŒ€ì‹œë³´ë“œ â†’ Variables íƒ­ì—ì„œ ìµœì‹  í™˜ê²½ë³€ìˆ˜ ë³µì‚¬
3. ```env ë¸”ë¡ì— ë¶™ì—¬ë„£ê¸°
4. í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰

---

### Test 7: ì»¨í…Œì´ë„ˆ ë¡œê·¸ ë¶„ì„

**ëª©ì :** ì»¨í…Œì´ë„ˆ ë¡œê·¸ì—ì„œ SSO ê´€ë ¨ ì´ˆê¸°í™” ë©”ì‹œì§€ í™•ì¸

**í™•ì¸í•  ë¡œê·¸ íŒ¨í„´:**
- `JWT.*configured` - JWT ì„¤ì • ì™„ë£Œ
- `Google.*OAuth` - Google OAuth ì„¤ì • ì™„ë£Œ
- `passport` - Passport ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì´ˆê¸°í™”
- `session` - ì„¸ì…˜ ê´€ë¦¬ ì´ˆê¸°í™”

**ìˆ˜ë™ í…ŒìŠ¤íŠ¸:**
```bash
# ì „ì²´ ë¡œê·¸ í™•ì¸
docker logs wbhub-sso-test

# JWT ì„¤ì • ë¡œê·¸ ê²€ìƒ‰
docker logs wbhub-sso-test 2>&1 | grep -i jwt

# Google OAuth ë¡œê·¸ ê²€ìƒ‰
docker logs wbhub-sso-test 2>&1 | grep -i google
```

**ê²€ì¦ í•­ëª©:**
- âœ… ë¡œê·¸ì— ì¹˜ëª…ì  ì—ëŸ¬ê°€ ì—†ìŒ
- âœ… SSO ê´€ë ¨ ì´ˆê¸°í™” ë©”ì‹œì§€ê°€ ì¼ë¶€ë¼ë„ í™•ì¸ë¨ (ëª¨ë‘ ì—†ì–´ë„ ì •ìƒì¼ ìˆ˜ ìˆìŒ)

**ê²½ê³  ë©”ì‹œì§€ëŠ” ë¬´ì‹œ ê°€ëŠ¥:**
- Deprecation warnings
- Performance hints

---

## í…ŒìŠ¤íŠ¸ ê²°ê³¼ í•´ì„

### âœ… ëª¨ë“  7ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼

**ì˜ë¯¸:**
- JWT Public Key ì—”ë“œí¬ì¸íŠ¸ ì •ìƒ
- ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” Google OAuthë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨
- Google OAuth URL ìƒì„± ì •ìƒ
- Auth Callback ë¼ìš°íŠ¸ ì ‘ê·¼ ê°€ëŠ¥
- Hub URL ì„¤ì • ì™„ë£Œ
- SSO í™˜ê²½ë³€ìˆ˜ ëª¨ë‘ ë¡œë“œë¨
- ì»¨í…Œì´ë„ˆ ë¡œê·¸ì— ì¹˜ëª…ì  ì—ëŸ¬ ì—†ìŒ

**ë‹¤ìŒ ë‹¨ê³„:**
```bash
# SSO ê¸°ëŠ¥ì´ ì •ìƒì´ë¯€ë¡œ ë°°í¬ ê°€ëŠ¥
git push origin main
```

**ì°¸ê³ :** ì´ í…ŒìŠ¤íŠ¸ëŠ” SSO **ì¸í”„ë¼**ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤. ì‹¤ì œ Google OAuth ë¡œê·¸ì¸ì€ ì‚¬ìš©ìì˜ ìˆ˜ë™ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.

---

### âŒ Test 1 ì‹¤íŒ¨: JWT Public Key ì—”ë“œí¬ì¸íŠ¸

**ì¦ìƒ:**
```
âŒ Public key endpoint FAILED: Invalid key format
```

**ì›ì¸:**
- `JWT_PUBLIC_KEY` í™˜ê²½ë³€ìˆ˜ê°€ PEM í¬ë§·ì´ ì•„ë‹˜
- `-----BEGIN PUBLIC KEY-----`ì™€ `-----END PUBLIC KEY-----` ëˆ„ë½

**í•´ê²°:**
1. `common/railway-env.md` ì—´ê¸°
2. `JWT_PUBLIC_KEY` ê°’ í™•ì¸:
   ```env
   JWT_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----
   MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
   ...
   -----END PUBLIC KEY-----
   ```
3. ì—¬ëŸ¬ ì¤„ë¡œ ë‚˜ëˆ„ì–´ì ¸ ìˆì–´ì•¼ í•¨ (`\n`ìœ¼ë¡œ ì¤„ë°”ê¿ˆí•˜ì§€ ì•ŠìŒ)
4. Railway ëŒ€ì‹œë³´ë“œì—ì„œ ìµœì‹  í‚¤ í™•ì¸ í›„ ì—…ë°ì´íŠ¸

---

### âŒ Test 2 ì‹¤íŒ¨: Hub Token ìƒì„±

**ì¦ìƒ:**
```
âŒ wbfinhub - Invalid response (expected requires_auth)
```

**ì›ì¸:**
- ì„¸ì…˜ì´ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ `requires_auth: false` ë°˜í™˜ (ì •ìƒì ì¸ ê²½ìš°ë„ ìˆìŒ)
- ë˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ ì˜¤ë¥˜

**í™•ì¸:**
ì‘ë‹µ ë‚´ìš© í™•ì¸:
```json
// ì„¸ì…˜ì´ ìˆëŠ” ê²½ìš° (ì •ìƒ)
{
  "success": true,
  "data": {
    "requires_auth": false,
    "token": "eyJhbGciOiJSUzI1NiIs..."
  }
}

// ì˜¤ë¥˜ì¸ ê²½ìš°
{
  "success": false,
  "error": "..."
}
```

**í•´ê²°:**
- ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚´ìš© í™•ì¸
- Google OAuth ì„¤ì • í™•ì¸ (`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`)

---

### âŒ Test 3 ì‹¤íŒ¨: Google OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸

**ì¦ìƒ:**
```
âŒ wbfinhub - Expected redirect, got 500
```

**ì›ì¸:**
- `GOOGLE_CLIENT_ID` ë˜ëŠ” `GOOGLE_CLIENT_SECRET` ëˆ„ë½
- `APP_URL` ì„¤ì • ì˜¤ë¥˜

**í•´ê²°:**
```bash
# í™˜ê²½ë³€ìˆ˜ í™•ì¸
docker exec wbhub-sso-test sh -c "env | grep GOOGLE"
docker exec wbhub-sso-test sh -c "env | grep APP_URL"

# ëˆ„ë½ë˜ì—ˆìœ¼ë©´ common/railway-env.md ì—…ë°ì´íŠ¸
```

**ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:**
```bash
docker logs wbhub-sso-test 2>&1 | tail -20
```

---

### âŒ Test 5 ì‹¤íŒ¨: Hub URL ì„¤ì •

**ì¦ìƒ:**
```
âŒ wbfinhub - NOT FOUND
```

**ì›ì¸:**
- ë°ì´í„°ë² ì´ìŠ¤ì— Hub ë°ì´í„°ê°€ ì—†ìŒ
- Prisma migration ë˜ëŠ” seedê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ

**í•´ê²°:**
```bash
# ë¡œì»¬ í™˜ê²½ì—ì„œ Prisma seed ì‹¤í–‰
npx prisma db seed

# ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ì‚½ì… (Railway PostgreSQL)
# Prisma Studio ì‚¬ìš©:
npx prisma studio
```

**ë˜ëŠ” SQLë¡œ ì§ì ‘ ì‚½ì…:**
```sql
INSERT INTO "Hub" (slug, name, url, status)
VALUES
  ('wbfinhub', 'WB FinHub', 'https://wbfinhub.up.railway.app', 'active'),
  ('wbsaleshub', 'WB SalesHub', 'https://wbsaleshub.up.railway.app', 'active'),
  ('onboarding', 'Onboarding Hub', 'https://onboarding.up.railway.app', 'active');
```

---

### âŒ Test 6 ì‹¤íŒ¨: SSO í™˜ê²½ë³€ìˆ˜

**ì¦ìƒ:**
```
âŒ JWT_PRIVATE_KEY: NOT SET
```

**ì›ì¸:**
- `common/railway-env.md`ì— í™˜ê²½ë³€ìˆ˜ ëˆ„ë½
- `.env.docker-sso-test` íŒŒì¼ ìƒì„± ì˜¤ë¥˜

**í•´ê²°:**
1. Railway ëŒ€ì‹œë³´ë“œ â†’ WBHubManager â†’ Variables
2. ëª¨ë“  í™˜ê²½ë³€ìˆ˜ ë³µì‚¬
3. `common/railway-env.md` ì—´ê¸°
4. ```env ë¸”ë¡ ë‚´ìš© ì „ì²´ë¥¼ ë¶™ì—¬ë„£ê¸°ë¡œ êµì²´
5. í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰

**ì¤‘ìš”:** JWT í‚¤ëŠ” ë©€í‹°ë¼ì¸ í¬ë§·ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
```env
JWT_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwgg...
...
-----END PRIVATE KEY-----
```

`\n`ìœ¼ë¡œ í•œ ì¤„ë¡œ ë§Œë“¤ì§€ ë§ˆì„¸ìš”!

---

## ìˆ˜ë™ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸

ìë™í™” í…ŒìŠ¤íŠ¸ë¡œ SSO ì¸í”„ë¼ë¥¼ ê²€ì¦í•œ í›„, ì‹¤ì œ Google OAuth ë¡œê·¸ì¸ì„ ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.

### ë¡œì»¬ í™˜ê²½ í…ŒìŠ¤íŠ¸

```bash
# 1. ì»¨í…Œì´ë„ˆ ì‹œì‘ (ìë™ í…ŒìŠ¤íŠ¸ í›„ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŒ)
docker run -d --name wbhub-sso-test \
  -p 14091:4090 \
  --env-file .env.docker-sso-test \
  wbhub-sso-test \
  node dist/server/index.js

# 2. ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†
open http://localhost:14091
```

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­**
   - Google ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ”ì§€ í™•ì¸

2. **Google ê³„ì • ì„ íƒ ë° ë¡œê·¸ì¸**
   - OAuth ë™ì˜ í™”ë©´ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
   - ì´ë©”ì¼, í”„ë¡œí•„ ê¶Œí•œ ìš”ì²­ í™•ì¸

3. **Hub ì„ íƒ í˜ì´ì§€**
   - ë¡œê·¸ì¸ ì„±ê³µ í›„ `/hubs` í˜ì´ì§€ë¡œ ì´ë™
   - WBFinHub, WBSalesHub, Onboarding Hub í‘œì‹œ í™•ì¸

4. **Hub í´ë¦­ (ì˜ˆ: WBFinHub)**
   - JWT í† í°ì´ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸ (ê°œë°œì ë„êµ¬ â†’ Network íƒ­)
   - WBFinHubë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸: `http://localhost:3020/auth/sso?token=eyJ...`

5. **WBFinHubì—ì„œ ë¡œê·¸ì¸ ì™„ë£Œ**
   - JWT í† í° ê²€ì¦ ì„±ê³µ
   - WBFinHub ëŒ€ì‹œë³´ë“œ ë¡œë“œ

### ì˜ˆìƒ URL íë¦„

```
http://localhost:14091
  â†“ (Google ë¡œê·¸ì¸ í´ë¦­)
https://accounts.google.com/o/oauth2/v2/auth?client_id=...&state=...
  â†“ (Google ë¡œê·¸ì¸ ì™„ë£Œ)
http://localhost:14091/api/auth/callback?code=...&state=...
  â†“ (Hub ì„ íƒ í˜ì´ì§€)
http://localhost:14091/hubs
  â†“ (WBFinHub í´ë¦­)
http://localhost:3020/auth/sso?token=eyJhbGciOiJSUzI1NiIs...
  â†“ (í† í° ê²€ì¦ ì„±ê³µ)
http://localhost:3020/dashboard
```

---

## ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

### Google OAuth ì˜¤ë¥˜: redirect_uri_mismatch

**ì¦ìƒ:**
Google OAuth í™”ë©´ì—ì„œ:
```
Error 400: redirect_uri_mismatch
```

**ì›ì¸:**
- Google Cloud Consoleì— ë“±ë¡ëœ Redirect URIì™€ ì‹¤ì œ ìš”ì²­ URIê°€ ë‹¤ë¦„

**í•´ê²°:**
1. [Google Cloud Console](https://console.cloud.google.com/) â†’ APIs & Services â†’ Credentials
2. OAuth 2.0 Client ID ì„ íƒ
3. Authorized redirect URIsì— ì¶”ê°€:
   ```
   http://localhost:14091/api/auth/callback (ë¡œì»¬ í…ŒìŠ¤íŠ¸)
   https://your-app.up.railway.app/api/auth/callback (Railway ë°°í¬)
   ```

---

### JWT í† í° ê²€ì¦ ì‹¤íŒ¨

**ì¦ìƒ:**
WBFinHubì—ì„œ:
```
Error: Invalid token signature
```

**ì›ì¸:**
- WBHubManagerì˜ Private Keyì™€ WBFinHubì˜ Public Keyê°€ ìŒì´ ì•„ë‹˜

**í•´ê²°:**
1. `common/railway-env.md`ì—ì„œ `JWT_PRIVATE_KEY`ì™€ `JWT_PUBLIC_KEY` í™•ì¸
2. í‚¤ ìŒì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (ë™ì¼í•œ ì‹œì ì— ìƒì„±ëœ í‚¤ì—¬ì•¼ í•¨)
3. í•„ìš”ì‹œ ìƒˆ í‚¤ ìŒ ìƒì„±:
   ```bash
   # Private Key ìƒì„±
   openssl genpkey -algorithm RSA -out private_key.pem -pkeyopt rsa_keygen_bits:2048

   # Public Key ì¶”ì¶œ
   openssl rsa -pubout -in private_key.pem -out public_key.pem
   ```
4. Railway ëŒ€ì‹œë³´ë“œì—ì„œ ë‘ í‚¤ ëª¨ë‘ ì—…ë°ì´íŠ¸

---

### Hub URLì´ localhostë¡œ ì„¤ì •ë¨

**ì¦ìƒ:**
Hub ì„ íƒ í›„ `http://localhost:3020`ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ì–´ ì ‘ì† ë¶ˆê°€

**ì›ì¸:**
- ë°ì´í„°ë² ì´ìŠ¤ì˜ Hub URLì´ ë¡œì»¬ ì£¼ì†Œë¡œ ì„¤ì •ë¨

**í•´ê²° (Railway ë°°í¬ í™˜ê²½):**
```sql
UPDATE "Hub"
SET url = 'https://wbfinhub.up.railway.app'
WHERE slug = 'wbfinhub';

UPDATE "Hub"
SET url = 'https://wbsaleshub.up.railway.app'
WHERE slug = 'wbsaleshub';

UPDATE "Hub"
SET url = 'https://onboarding.up.railway.app'
WHERE slug = 'onboarding';
```

---

## ê´€ë ¨ íŒŒì¼ ë° ì½”ë“œ

### ì£¼ìš” SSO ê´€ë ¨ íŒŒì¼

**Backend:**
- `server/routes/auth.ts` - SSO ì—”ë“œí¬ì¸íŠ¸ (`/api/auth/*`)
- `server/middleware/passport.ts` - Google OAuth ì„¤ì •
- `server/utils/jwt.ts` - JWT í† í° ìƒì„± ë° ê²€ì¦

**Frontend:**
- `pages/hubs/index.tsx` ë˜ëŠ” `app/hubs/page.tsx` - Hub ì„ íƒ í˜ì´ì§€
- `pages/auth/callback.tsx` ë˜ëŠ” `app/auth/callback/page.tsx` - OAuth ì½œë°± ì²˜ë¦¬

**í™˜ê²½ë³€ìˆ˜:**
- `common/railway-env.md` - ëª¨ë“  í™˜ê²½ë³€ìˆ˜ (JWT í‚¤, Google OAuth ë“±)

---

## npm ìŠ¤í¬ë¦½íŠ¸

```bash
# SSO í…ŒìŠ¤íŠ¸ (ì´ ë¬¸ì„œ)
node scripts/docker-sso-test.cjs
```

---

## ë‹¤ìŒ ë‹¨ê³„

### SSO í…ŒìŠ¤íŠ¸ í†µê³¼ í›„

**SSO ê´€ë ¨ ë³€ê²½ë§Œ í•œ ê²½ìš°:**
```bash
# Railway ë°°í¬
git push origin main
```

**ì¤‘ìš”í•œ ë³€ê²½ (ë¦¬íŒ©í† ë§, ì•„í‚¤í…ì²˜ ë³€ê²½):**
```bash
# ì •ë°€ í…ŒìŠ¤íŠ¸ë¡œ ì „ì²´ ì˜í–¥ë„ í™•ì¸
node scripts/docker-advanced-test.cjs
npm run test:railway
# ë˜ëŠ” ì •ë°€í…ŒìŠ¤íŠ¸.md ì°¸ì¡°
```

---

## ì°¸ê³  ë¬¸ì„œ

- **[ì¼ë°˜í…ŒìŠ¤íŠ¸.md](./ì¼ë°˜í…ŒìŠ¤íŠ¸.md)** - ë°°í¬ ì „ í•„ìˆ˜ ë¹ ë¥¸ ì²´í¬
- **[ì •ë°€í…ŒìŠ¤íŠ¸.md](./ì •ë°€í…ŒìŠ¤íŠ¸.md)** - ì™„ì „í•œ ì˜í–¥ë„ ë¶„ì„ ë° ê²€ì¦
- **[railway-docker-test-guide.md](./railway-docker-test-guide.md)** - Railway í™˜ê²½ ìƒì„¸ ê°€ì´ë“œ

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

SSO ë³€ê²½ í›„ ì´ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”:

- [ ] 7ê°œ SSO ìë™ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼
- [ ] JWT Public Key ì—”ë“œí¬ì¸íŠ¸ ì •ìƒ (PEM í¬ë§·)
- [ ] Google OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ ì •ìƒ
- [ ] Hub URL 3ê°œ ëª¨ë‘ ì„¤ì •ë¨
- [ ] SSO í™˜ê²½ë³€ìˆ˜ 5ê°œ ëª¨ë‘ ë¡œë“œë¨
- [ ] ë¸Œë¼ìš°ì € ìˆ˜ë™ í…ŒìŠ¤íŠ¸: Google ë¡œê·¸ì¸ ì„±ê³µ
- [ ] ë¸Œë¼ìš°ì € ìˆ˜ë™ í…ŒìŠ¤íŠ¸: Hub ì„ íƒ í›„ JWT í† í° ì „ë‹¬ ì„±ê³µ
- [ ] ë¸Œë¼ìš°ì € ìˆ˜ë™ í…ŒìŠ¤íŠ¸: Hubì—ì„œ í† í° ê²€ì¦ ì„±ê³µ

**ëª¨ë‘ ì²´í¬ë˜ë©´ SSO ê¸°ëŠ¥ì´ ì •ìƒì…ë‹ˆë‹¤!** ğŸ”

---

## ë²„ì „ íˆìŠ¤í† ë¦¬

| ë‚ ì§œ | ë³€ê²½ ë‚´ìš© | ì‘ì„±ì |
|------|----------|--------|
| 2025-12-31 | ì´ˆê¸° ë²„ì „ ì‘ì„± | Claude Code |
