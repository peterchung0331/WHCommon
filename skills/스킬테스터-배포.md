---
name: 스킬테스터-배포
description: 로컬 Docker → 오라클 배포 사전 검증 (dry-run 기본)
---

# 스킬테스터-배포 (Deployment Test)

## 개요
로컬 Docker 환경에서 테스트한 이미지가 오라클 클라우드에서 100% 동작하도록 보장하는 배포 사전 검증 시스템입니다.

## 특징
| 항목 | 값 |
|------|-----|
| 기본 모드 | dry-run (검증만) |
| 실제 배포 | full 모드 (명시적 요청 시) |
| 검증 항목 | 15개 체크포인트 |
| 자동 롤백 | 활성화 |
| 소요 시간 | 3-5분 (dry-run), 10-15분 (full) |
| Smoke 테스트 | 헬스체크만 (1분) |

## 입력 파라미터

### 프로젝트명 (필수)
- WBHubManager / 허브매니저
- WBSalesHub / 세일즈허브
- WBFinHub / 핀허브
- WBOnboardingHub / 온보딩허브

### 테스트 모드 (선택, 기본값: dry-run)
- **dry-run**: 사전 검증만 수행, 실제 배포 안함
- **full**: 검증 + 실제 배포 진행

### 환경 (선택, 기본값: oracle)
- oracle: 오라클 클라우드 (158.180.95.246)

## 작업 순서

### dry-run 모드 (기본)

#### Phase 1: 사전 검증 (15개 체크포인트)

**1.1 환경변수 검증**
```bash
cd ${PROJECT_PATH}

# 1. .env 파일 존재 확인 (로컬 Docker용)
if [ ! -f ".env" ]; then
  echo "❌ .env 파일이 없습니다."
  exit 1
fi

# 2. .env.template 필수 변수(*) 확인
# .env 파일 기준으로 검증
bash /home/peterchung/HWTestAgent/scripts/validate-env.sh ${PROJECT_PATH} .env

# 3. Doppler 토큰 확인
source /home/peterchung/WHCommon/env.doppler
if [ -z "$DOPPLER_TOKEN_${TOKEN_PREFIX}_PRD" ]; then
  echo "❌ Doppler Production 토큰이 없습니다."
  exit 1
fi

# 4. .env.prd 생성 테스트
bash WHCommon/scripts/sync-doppler.sh download prd
if [ $? -ne 0 ]; then
  echo "❌ .env.prd 생성 실패"
  exit 1
fi

# 5. URL 변환 확인 (localhost → workhub.biz)
bash /home/peterchung/HWTestAgent/scripts/validate-urls.sh .env.prd
```

**1.2 Git 상태 검증**
```bash
# 6. 변경사항 확인
if [ -n "$(git status --porcelain)" ]; then
  echo "⚠️ 커밋되지 않은 변경사항이 있습니다."
  git status --short
fi

# 7. 원격 브랜치 동기화 확인
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u} 2>/dev/null)
if [ "$LOCAL" != "$REMOTE" ]; then
  echo "⚠️ 원격 브랜치와 동기화되지 않았습니다."
fi

# 8. .gitignore에 .env.prd 포함 확인
if ! grep -q ".env.prd" .gitignore; then
  echo "⚠️ .gitignore에 .env.prd가 없습니다."
fi
```

**1.3 SSH 연결 검증**
```bash
# 9. Oracle SSH 키 확인
if [ ! -f ~/.ssh/oracle-cloud.key ]; then
  echo "❌ Oracle SSH 키가 없습니다."
  exit 1
fi

# 10. SSH 키 권한 확인
PERMS=$(stat -c "%a" ~/.ssh/oracle-cloud.key)
if [ "$PERMS" != "600" ]; then
  echo "⚠️ SSH 키 권한이 600이 아닙니다. 수정합니다."
  chmod 600 ~/.ssh/oracle-cloud.key
fi

# 11. Oracle 서버 접속 테스트
ssh -i ~/.ssh/oracle-cloud.key -o ConnectTimeout=10 ubuntu@158.180.95.246 "echo '✅ SSH 연결 성공'" || {
  echo "❌ Oracle 서버 접속 실패"
  exit 1
}

# 12. GitHub SSH 키 확인
if [ ! -f ~/.ssh/github_key ]; then
  echo "❌ GitHub SSH 키가 없습니다."
  exit 1
fi
```

**1.4 Docker 로컬 검증**
```bash
# 13. 로컬 Docker 컨테이너 상태 확인
CONTAINER_NAME=${PROJECT_NAME,,}  # 소문자 변환
if docker ps -a --filter "name=${CONTAINER_NAME}" --format "{{.Status}}" | grep -q "Up"; then
  echo "✅ 로컬 컨테이너 실행 중"
else
  echo "⚠️ 로컬 컨테이너가 실행되지 않았습니다."
fi

# 14. 로컬 헬스체크
curl -f http://localhost:${BACKEND_PORT}/api/health > /dev/null 2>&1
if [ $? -eq 0 ]; then
  echo "✅ 로컬 헬스체크 통과"
else
  echo "⚠️ 로컬 헬스체크 실패 - 로컬에서 먼저 테스트하세요."
fi
```

**1.5 네트워크 설정 검증**
```bash
# 15. .env.prd에서 프로덕션 URL 확인
if grep -q "localhost" .env.prd || grep -q "127.0.0.1" .env.prd; then
  echo "❌ .env.prd에 localhost가 포함되어 있습니다."
  bash /home/peterchung/HWTestAgent/scripts/validate-urls.sh .env.prd
  exit 1
fi

echo "✅ 모든 URL이 프로덕션으로 설정되었습니다."
```

#### Phase 2: 검증 결과 분석
- 15개 체크포인트 통과 여부 확인
- 경고 사항 정리
- 권장사항 도출

#### Phase 3: 리포트 생성
```markdown
# [프로젝트명] 배포 테스트 리포트 (dry-run)

## 메타정보
- 테스트 일시: YYYY-MM-DD HH:MM:SS
- 프로젝트: WBHubManager
- 모드: dry-run (검증만)
- 최종 결과: ✅ 배포 가능 / ❌ 문제 있음

## Phase 1: 사전 검증 결과 (15/15 통과)

| 체크포인트 | 상태 | 상세 |
|-----------|------|------|
| .env.local 존재 | ✅ | 파일 존재 확인 |
| 필수 환경변수 | ✅ | 12개 변수 모두 존재 |
| Doppler 토큰 | ✅ | Production 토큰 유효 |
| .env.prd 생성 | ✅ | Doppler에서 다운로드 성공 |
| URL 설정 | ✅ | localhost → workhub.biz 변환됨 |
| Git 커밋 상태 | ⚠️ | 2개 파일 미커밋 |
| 원격 동기화 | ✅ | 원격과 동기화됨 |
| .gitignore | ✅ | .env.prd 포함됨 |
| Oracle SSH 키 | ✅ | 키 존재, 권한 600 |
| SSH 연결 | ✅ | Oracle 서버 접속 성공 |
| GitHub SSH 키 | ✅ | 키 존재 |
| 로컬 컨테이너 | ✅ | 실행 중 |
| 로컬 헬스체크 | ✅ | HTTP 200 응답 |
| 프로덕션 URL | ✅ | localhost 없음 |
| 네트워크 설정 | ✅ | 모든 URL 프로덕션 설정 |

## 경고 사항
- Git 커밋 상태: 2개 파일 미커밋 (배포 전 커밋 권장)

## 권장사항
✅ **배포 가능합니다.**
- 실제 배포: `스킬테스터 [프로젝트] 배포 full` 명령 사용
- 배포 전 변경사항 커밋 권장

## 결론
모든 사전 검증 통과. 오라클 클라우드 배포 준비 완료.
```

### full 모드

#### Phase 1: 사전 검증 (dry-run과 동일)
15개 체크포인트 모두 통과해야 진행

#### Phase 2: 실제 배포 (8단계)

**2.1 환경변수 준비**
```bash
# .env.prd 다운로드 (이미 Phase 1에서 완료)
# 백업 생성
cp .env.prd .env.prd.backup.$(date +%Y%m%d-%H%M%S)
```

**2.2 코드 푸시**
```bash
# 변경사항 커밋 (있을 경우)
if [ -n "$(git status --porcelain)" ]; then
  git add .
  git commit -m "deploy: Preparing deployment to Oracle Cloud"
fi

# GitHub 푸시
BRANCH=$(git rev-parse --abbrev-ref HEAD)
git push origin ${BRANCH}
```

**2.3 파일 전송**
```bash
# .env.prd를 Oracle 서버로 전송
scp -i ~/.ssh/oracle-cloud.key .env.prd ubuntu@158.180.95.246:${REMOTE_DIR}/.env.prd

# 전송 확인
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 "ls -la ${REMOTE_DIR}/.env.prd"
```

**2.4 원격 배포 실행**
```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 << EOF
set -e

echo "📦 Git pull..."
cd ${REMOTE_DIR}
git fetch origin
git checkout ${BRANCH}
git pull origin ${BRANCH}

echo "🏷️ 현재 이미지 백업..."
docker tag ${IMAGE_NAME}:latest ${IMAGE_NAME}:backup || true

echo "🐳 Docker 빌드..."
docker build -t ${IMAGE_NAME}:latest .

echo "🛑 기존 컨테이너 중지..."
docker stop ${CONTAINER_NAME} || true
docker rm ${CONTAINER_NAME} || true

echo "▶️ 새 컨테이너 시작..."
docker run -d \
  --name ${CONTAINER_NAME} \
  --restart unless-stopped \
  -p ${FRONTEND_PORT}:${FRONTEND_PORT} \
  -p ${BACKEND_PORT}:${BACKEND_PORT} \
  -e NODE_ENV=production \
  ${IMAGE_NAME}:latest

echo "⏳ 컨테이너 시작 대기 (30초)..."
sleep 30

echo "✅ 배포 완료"
EOF
```

#### Phase 3: 배포 후 검증 (헬스체크)

**3.1 컨테이너 상태 확인**
```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 "docker ps --filter 'name=${CONTAINER_NAME}' --format '{{.Status}}'"
```

**3.2 헬스체크**
```bash
# HWTestAgent에서 헬스체크 실행
bash /home/peterchung/HWTestAgent/scripts/smoke-test.sh ${PROJECT_NAME}

# 또는 직접 curl
HEALTH_URL="http://158.180.95.246:${BACKEND_PORT}/api/health"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL})

if [ "$RESPONSE" = "200" ]; then
  echo "✅ 헬스체크 통과"
else
  echo "❌ 헬스체크 실패 (HTTP ${RESPONSE})"
  echo "🔄 자동 롤백 시작..."
  # 롤백 실행
fi
```

**3.3 자동 롤백 (검증 실패 시)**
```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 << EOF
echo "🔄 이전 버전으로 롤백 중..."

docker stop ${CONTAINER_NAME} || true
docker rm ${CONTAINER_NAME} || true

docker tag ${IMAGE_NAME}:backup ${IMAGE_NAME}:latest

docker run -d \
  --name ${CONTAINER_NAME} \
  --restart unless-stopped \
  -p ${FRONTEND_PORT}:${FRONTEND_PORT} \
  -p ${BACKEND_PORT}:${BACKEND_PORT} \
  -e NODE_ENV=production \
  ${IMAGE_NAME}:latest

echo "✅ 롤백 완료"
EOF
```

#### Phase 4: 리포트 생성
```markdown
# [프로젝트명] 배포 테스트 리포트 (full)

## 메타정보
- 배포 일시: YYYY-MM-DD HH:MM:SS
- 프로젝트: WBHubManager
- 모드: full (실제 배포)
- 최종 결과: ✅ 성공 / ❌ 실패 (롤백됨)

## Phase 1: 사전 검증 (15/15 통과)
[dry-run과 동일]

## Phase 2: 배포 실행 (8/8 성공)
1. ✅ 환경변수 준비 (.env.prd 백업)
2. ✅ 코드 푸시 (GitHub)
3. ✅ 파일 전송 (.env.prd → Oracle)
4. ✅ Git pull (Oracle 서버)
5. ✅ Docker 빌드 (2분 30초 소요)
6. ✅ 컨테이너 중지 및 제거
7. ✅ 새 컨테이너 시작
8. ✅ 컨테이너 안정화 (30초 대기)

## Phase 3: 배포 후 검증 (1/1 통과)
- ✅ 헬스체크: HTTP 200, success: true

**헬스체크 응답:**
```json
{
  "success": true,
  "timestamp": "2026-01-04T10:30:00Z",
  "version": "1.0.0"
}
```

## 접속 정보
- Frontend: http://158.180.95.246:${FRONTEND_PORT}
- Backend API: http://158.180.95.246:${BACKEND_PORT}/api/health
- 프로덕션 도메인: http://workhub.biz/[hub-name]

## 로그 확인
```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 'docker logs -f ${CONTAINER_NAME}'
```

## 결론
✅ 배포 성공. 모든 검증 통과.
```

## 반복 디버깅
- 배포는 재시도 리스크가 높으므로 **재시도 없음**
- Phase 1 검증 실패 시: 즉시 중단, 리포트 생성
- Phase 3 검증 실패 시: 자동 롤백, 리포트 생성

## 결과 저장 경로
```
/home/peterchung/HWTestAgent/test-results/deployment/
├── reports/
│   └── YYYY-MM-DD-[프로젝트명]-배포-테스트.md
├── screenshots/  (추후 확장 시)
└── logs/
    └── YYYY-MM-DD-[프로젝트명]-배포.log
```

## 프로젝트별 설정

### WBHubManager
- REMOTE_DIR: `/home/ubuntu/wbhubmanager`
- IMAGE_NAME: `wbhubmanager`
- CONTAINER_NAME: `hubmanager`
- FRONTEND_PORT: `3090`
- BACKEND_PORT: `5050`
- GITHUB_REPO: `git@github.com:peterchung0331/WBHubManager.git`

### WBSalesHub
- REMOTE_DIR: `/home/ubuntu/wbsaleshub`
- IMAGE_NAME: `wbsaleshub`
- CONTAINER_NAME: `saleshub`
- FRONTEND_PORT: `3010`
- BACKEND_PORT: `4010`
- GITHUB_REPO: `git@github.com:peterchung0331/WBSalesHub.git`

### WBFinHub
- REMOTE_DIR: `/home/ubuntu/workhub/WBFinHub`
- IMAGE_NAME: `wbfinhub`
- CONTAINER_NAME: `finhub`
- FRONTEND_PORT: `3020`
- BACKEND_PORT: `4020`
- GITHUB_REPO: `git@github.com:peterchung0331/WBFinHub.git`

### WBOnboardingHub
- REMOTE_DIR: `/home/ubuntu/wbonboardinghub`
- IMAGE_NAME: `wbonboardinghub`
- CONTAINER_NAME: `onboardinghub`
- FRONTEND_PORT: `3030`
- BACKEND_PORT: `4030`
- GITHUB_REPO: `git@github.com:peterchung0331/WBOnboardingHub.git`

## 사용 예시
```
# dry-run 모드 (기본)
/스킬테스터 허브매니저 배포 테스트
/스킬테스터 배포 세일즈허브
스킬테스터 핀허브 오라클 배포 검증

# full 모드 (실제 배포)
/스킬테스터 허브매니저 배포 full
/스킬테스터 배포 세일즈허브 full
스킬테스터 핀허브 배포 full
```

## 자동 수정 대상
- SSH 키 권한 자동 수정 (600)
- .env.prd 자동 생성 (Doppler에서 다운로드)
- Docker 이미지 자동 백업 및 롤백

## 수동 개입 필요
- Git 커밋되지 않은 변경사항 (경고만, 자동 커밋 안함)
- Doppler 토큰 없음 (수동 설정 필요)
- Oracle SSH 키 없음 (수동 설정 필요)
- GitHub SSH 키 없음 (수동 설정 필요)

## 100% 성공률을 위한 체크리스트
- [ ] 로컬에서 docker-compose.dev.yml 빌드 및 테스트 완료
- [ ] 로컬 헬스체크 통과
- [ ] .env 파일 필수 변수 모두 입력 (로컬 Docker용)
- [ ] Doppler Production 토큰 설정
- [ ] SSH 키 설정 (Oracle, GitHub)
- [ ] Git 변경사항 모두 커밋
- [ ] .env.prd에서 URL 설정 프로덕션으로 변경 (localhost → workhub.biz)

이 체크리스트를 모두 만족하면 오라클 클라우드 배포 성공률 100%에 근접합니다.
