# 실행_기획 - 상세 가이드

> **메인 문서로 돌아가기**: [실행_기획.md](./실행_기획.md)

이 문서는 PRD 작성을 위한 상세 가이드라인과 템플릿을 제공합니다.

---

## 명확화 질문 템플릿

### AskUserQuestion 사용법

**장점:**
- 사용자 친화적인 UI (버튼 클릭으로 응답)
- 명확한 선택지 제시
- 다중 선택 가능 (multiSelect 옵션)

**제약사항:**
- 한 번에 1-4개 질문까지
- 각 질문당 2-4개 옵션
- header는 최대 12자
- "Other" 옵션은 자동 추가됨 (명시하지 말 것)

---

### Template 1: 목표 및 문제 정의

```typescript
AskUserQuestion({
  questions: [
    {
      question: "이 기능의 주요 목표는 무엇인가요?",
      header: "Goal",
      multiSelect: false,
      options: [
        { label: "온보딩 개선", description: "신규 사용자 경험 향상" },
        { label: "유지율 증가", description: "기존 사용자 이탈 방지" },
        { label: "지원 부담 감소", description: "고객 문의 자동화" },
        { label: "매출 증대", description: "유료 기능 추가" }
      ]
    },
    {
      question: "해결하려는 가장 큰 문제는 무엇인가요?",
      header: "Problem",
      multiSelect: false,
      options: [
        { label: "성능 저하", description: "응답 시간이 느림" },
        { label: "보안 취약점", description: "인증/권한 문제" },
        { label: "사용성 문제", description: "UI/UX 개선 필요" },
        { label: "기술 부채", description: "레거시 코드 개선" }
      ]
    }
  ]
})
```

---

### Template 2: 범위 및 경계

```typescript
AskUserQuestion({
  questions: [
    {
      question: "이 기능이 적용될 허브를 선택하세요.",
      header: "Target Hubs",
      multiSelect: true,
      options: [
        { label: "HubManager", description: "SSO 및 허브 관리" },
        { label: "SalesHub", description: "고객 및 미팅 관리" },
        { label: "FinHub", description: "재무 및 트랜잭션" },
        { label: "OnboardingHub", description: "신규 사용자 온보딩" }
      ]
    },
    {
      question: "이 기능에 포함하지 않을 것은 무엇인가요?",
      header: "Out of Scope",
      multiSelect: true,
      options: [
        { label: "모바일 앱", description: "웹 브라우저만 지원" },
        { label: "오프라인 모드", description: "온라인 전용" },
        { label: "다국어 지원", description: "한국어만 우선" },
        { label: "데이터 마이그레이션", description: "신규 기능만" }
      ]
    }
  ]
})
```

---

### Template 3: 기술 접근

```typescript
AskUserQuestion({
  questions: [
    {
      question: "이 기능은 어떤 환경에서 먼저 배포되나요?",
      header: "Environment",
      multiSelect: false,
      options: [
        { label: "로컬 개발만", description: "로컬 테스트 후 결정" },
        { label: "스테이징 우선", description: "Docker 4400 포트" },
        { label: "프로덕션 직행", description: "오라클 클라우드 즉시" }
      ]
    },
    {
      question: "기존 시스템과의 호환성을 어떻게 처리하나요?",
      header: "Compatibility",
      multiSelect: false,
      options: [
        { label: "Breaking Change", description: "기존 API 변경 허용" },
        { label: "Backward Compatible", description: "기존 코드 유지" },
        { label: "Deprecation", description: "단계적 제거 계획" }
      ]
    }
  ]
})
```

---

### Template 4: WorkHub 특화 질문

```typescript
AskUserQuestion({
  questions: [
    {
      question: "이 기능은 허브 간 통신이 필요한가요?",
      header: "Hub Comm",
      multiSelect: false,
      options: [
        { label: "SSO만", description: "HubManager 인증만 사용" },
        { label: "API 호출", description: "허브 간 REST API" },
        { label: "공유 DB", description: "PostgreSQL 테이블 공유" },
        { label: "독립 실행", description: "허브 간 통신 없음 (권장)" }
      ]
    },
    {
      question: "환경변수 관리는 어떻게 하나요?",
      header: "Env Config",
      multiSelect: true,
      options: [
        { label: ".env.local", description: "로컬 개발용" },
        { label: ".env.staging", description: "Docker 스테이징용" },
        { label: ".env.prd", description: "프로덕션 배포용" },
        { label: "Doppler", description: "중앙 환경변수 관리" }
      ]
    }
  ]
})
```

---

## 섹션별 가이드라인

### 섹션 1-5: 핵심 요구사항

#### 1. Introduction/Overview

**목적**: 기능의 배경과 문제 정의

**템플릿**:
```markdown
## 1. Introduction/Overview

### 배경
[현재 상황과 문제점 설명]

### 목적
[이 기능이 해결하려는 핵심 문제]

### 대상 사용자
[이 기능의 주요 사용자 그룹]
```

#### 2. Goals

**목적**: 측정 가능한 목표 정의

**템플릿**:
```markdown
## 2. Goals

### Primary Goals
1. [정량적 목표 1]: [측정 방법]
2. [정량적 목표 2]: [측정 방법]

### Secondary Goals
1. [부차적 목표]
```

#### 3. User Stories

**목적**: 사용자 관점의 요구사항

**템플릿**:
```markdown
## 3. User Stories

### US-1: [스토리 제목]
**As a** [사용자 유형],
**I want to** [원하는 기능],
**So that** [얻고자 하는 가치].

**Acceptance Criteria:**
- [ ] AC-1.1: [검증 가능한 조건]
- [ ] AC-1.2: [검증 가능한 조건]
```

#### 4. Functional Requirements

**목적**: 구체적 기능 명세

**템플릿**:
```markdown
## 4. Functional Requirements

### FR-공통 (모든 허브)
- **FR-C1**: [기능 설명]
  - 입력: [입력 데이터]
  - 출력: [출력 결과]
  - 예외: [에러 처리]

### FR-[허브명] (적용 시에만)
- **FR-HM1**: [허브 전용 기능]
```

#### 5. Non-Goals (Out of Scope)

**목적**: 범위 제외 명확화

**템플릿**:
```markdown
## 5. Non-Goals

다음 항목은 이 PRD의 범위에 포함되지 않습니다:

- **[제외 항목 1]**: [제외 사유]
- **[제외 항목 2]**: [제외 사유]
- **향후 고려**: [다음 버전에서 검토할 항목]
```

---

### 섹션 6-7: 설계 고려사항

#### 6. Design Considerations

**목적**: UI/UX 요구사항 정의

**템플릿**:
```markdown
## 6. Design Considerations

### UI Components
- 아이콘: `lucide-react` 라이브러리 사용
- 버튼: Tailwind `bg-blue-600 hover:bg-blue-700` 스타일
- 테이블: `@tanstack/react-table` 사용

### Responsive Design
- 모바일: 768px 이하 → 단일 컬럼 레이아웃
- 데스크톱: 768px 이상 → 2컬럼 레이아웃

### 참고 화면
- [Figma 링크] 또는 [기존 페이지 참조]
```

#### 7. Technical Considerations

**목적**: 기술적 제약 및 의존성

**템플릿**:
```markdown
## 7. Technical Considerations

### 기술 스택
- Backend: Node.js + Express + TypeScript
- Frontend: Next.js 15 + React 19
- Database: PostgreSQL + Prisma

### 의존성
- [패키지명]: [버전] - [용도]

### 환경별 설정

| 항목 | 로컬 (.env.local) | 스테이징 (.env.staging) | 프로덕션 (.env.prd) |
|------|------------------|------------------------|-------------------|
| PORT | [허브별 포트] | 4400 | 4500 |
| NODE_ENV | development | production | production |
| [추가 변수] | [값] | [값] | [값] |

### API 엔드포인트

| Method | Endpoint | 설명 | 권한 |
|--------|----------|------|------|
| GET | /api/[resource] | [설명] | [권한] |
| POST | /api/[resource] | [설명] | [권한] |
```

---

### 섹션 8-10: 품질 요구사항

#### 8. Non-Functional Requirements (NFR)

**목적**: 성능, 가용성, 확장성 정의

**템플릿**:
```markdown
## 8. Non-Functional Requirements

### Performance
- API 응답 시간: < 200ms (95 percentile)
- 페이지 로딩 시간: < 1초 (초기 렌더링)
- 데이터베이스 쿼리: < 50ms (평균)

### Availability
- 목표 가동률: 99.9% (연간 8시간 이하 다운타임)
- RTO (Recovery Time Objective): < 15분
- RPO (Recovery Point Objective): < 5분

### Scalability
- 동시 사용자: 최소 1,000명 지원
- 데이터 볼륨: 10만 레코드까지 성능 유지
- 수평 확장: Docker Compose 스케일링 지원
```

**WorkHub 특화**:
```markdown
### Performance (WorkHub)
- SSO 리디렉션: < 500ms (OAuth 포함)
- 허브 간 API 호출: < 100ms (내부 네트워크)
- 동시 허브 접속: 5개 허브 동시 운영 지원

### Availability (WorkHub)
- 개별 허브 장애 시 다른 허브 정상 운영 (격리)
- WBHubManager 장애 시 RTO < 10분 (SSO 복구 우선)
```

#### 9. Security Requirements

**목적**: 보안 요구사항 명시

**템플릿**:
```markdown
## 9. Security Requirements

### Authentication & Authorization
- OAuth 2.0 사용 (Google 계정)
- JWT 토큰 유효기간: 24시간
- 리프레시 토큰: 30일
- 권한 검증: 모든 API 엔드포인트에 미들웨어 적용

### Data Protection
- 비밀번호: bcrypt 해싱 (salt rounds: 10)
- 민감 정보: 환경변수(.env) 또는 Doppler 사용
- 데이터베이스: 프로덕션에만 암호화 적용

### Network Security
- HTTPS 사용 (프로덕션 환경)
- CORS: whitelist 기반 허용
- Rate Limiting: API당 100 req/min

### WorkHub Security Checklist
- [ ] OAuth redirect_uri whitelist 검증
- [ ] httpOnly 쿠키 사용 (토큰 저장 시)
- [ ] 허브별 권한 분리 (`hub_id` 기반)
- [ ] SSO 토큰 공유 시 JWT 서명 검증
- [ ] 프로덕션에서 dev-login 엔드포인트 비활성화
```

#### 10. Test Strategy

**목적**: 테스트 계획 및 커버리지

**템플릿**:
```markdown
## 10. Test Strategy

### Unit Tests
- **범위**: 비즈니스 로직, 유틸리티 함수
- **도구**: Jest (Node.js), Vitest (Vite 프로젝트)
- **커버리지 목표**: 80% 이상
- **예시 테스트 케이스**:
  - `validateRedirectUri()` - whitelist 검증
  - `generateJWT()` - 토큰 생성 및 만료 확인

### Integration Tests
- **범위**: API 엔드포인트, 데이터베이스 연동
- **도구**: Supertest, HWTestAgent
- **커버리지 목표**: 주요 API 100%
- **예시 테스트 케이스**:
  - `POST /api/auth/login` - 로그인 성공/실패
  - `GET /api/users/:id` - 권한별 접근 제어

### E2E Tests
- **범위**: 사용자 시나리오 (User Stories 기반)
- **도구**: Playwright (HWTestAgent)
- **커버리지 목표**: 모든 User Story 커버
- **테스트 위치**: `/home/peterchung/HWTestAgent/tests/`

### 테스트 데이터 정의

#### 필수 테스트 데이터 (SQL)
```sql
-- 테스트 사용자 (모든 역할 포함)
INSERT INTO users (email, role, status) VALUES
  ('admin@test.com', 'admin', 'active'),
  ('user@test.com', 'user', 'active'),
  ('viewer@test.com', 'viewer', 'pending'),
  ('inactive@test.com', 'user', 'inactive');

-- 테스트 허브 권한
INSERT INTO hub_roles (user_id, hub_id, role) VALUES
  (1, 'hubmanager', 'admin'),
  (2, 'saleshub', 'user'),
  (3, 'finhub', 'viewer');
```

#### 테스트 환경 구성
- **로컬**: `docker-compose -f docker-compose.test.yml up`
- **CI/CD**: GitHub Actions의 `test` job 사용
- **데이터 초기화**: `npm run db:seed:test`

### E2E 시나리오 매핑

| User Story | E2E 시나리오 | 테스트 파일 |
|------------|-------------|------------|
| US-1 | Google OAuth 로그인 → 대시보드 접근 | `e2e-auth.spec.ts` |
| US-2 | Admin 권한 변경 → 변경 사항 반영 | `e2e-admin.spec.ts` |
```

---

### 섹션 11-14: 구현 및 검증

#### 11. Implementation Phases

**사용 조건**: FR 20개 이상 또는 2주 이상 구현 예상

**템플릿**:
```markdown
## 11. Implementation Phases

### Phase 1: 기반 구축
- **범위**: FR-C1, FR-C2, 데이터베이스 스키마
- **산출물**: API 기본 구조, DB 마이그레이션
- **검증**: 단위 테스트 통과

### Phase 2: 핵심 기능
- **범위**: FR-HM1, FR-SH1
- **산출물**: 주요 API 엔드포인트, UI 컴포넌트
- **검증**: 통합 테스트 통과

### Phase 3: 통합 및 최적화
- **범위**: 허브 간 연동, 성능 최적화
- **산출물**: 완성된 기능, 최적화된 쿼리
- **검증**: E2E 테스트 통과

### Phase 4: 배포
- **범위**: 스테이징 → 프로덕션 배포
- **산출물**: 배포된 서비스, 모니터링 설정
- **검증**: 프로덕션 검증 체크리스트 완료
```

#### 12. Risk & Mitigation

**사용 조건**: 마이그레이션, 인프라 변경, 아키텍처 변경

**템플릿**:
```markdown
## 12. Risk & Mitigation

### 위험 분석 매트릭스

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| 데이터베이스 마이그레이션 실패 | High | Low | 백업 + 롤백 스크립트 준비 |
| OAuth 토큰 만료로 세션 끊김 | Medium | Medium | 리프레시 토큰 자동 갱신 |
| 허브 간 네트워크 장애 | High | Low | Circuit Breaker 패턴 적용 |

### Rollback Strategy
- **조건**: 프로덕션 배포 후 30분 내 에러율 > 5%
- **절차**:
  1. `./scripts/rollback-production.sh` 실행
  2. 이전 버전 이미지로 자동 복원
  3. 데이터베이스 롤백 (필요 시 수동)

### 백업 절차
```bash
# 배포 전 백업
pg_dump -h $DB_HOST -U $DB_USER $DB_NAME > backup_$(date +%Y%m%d_%H%M%S).sql

# 롤백 시 복원
psql -h $DB_HOST -U $DB_USER $DB_NAME < backup_YYYYMMDD_HHMMSS.sql
```
```

#### 13. Success Metrics

**목적**: 성공 측정 기준 정의

**템플릿**:
```markdown
## 13. Success Metrics

### 기능적 지표
- [ ] SM-1: [User Story 1] 완료율 100%
- [ ] SM-2: [User Story 2] 완료율 100%

### 운영적 지표
- [ ] SM-3: 프로덕션 배포 후 24시간 내 Critical 버그 0건
- [ ] SM-4: 사용자 피드백 긍정률 > 80%

### 기술적 지표
- [ ] SM-5: API 응답 시간 < 200ms (95 percentile)
- [ ] SM-6: 테스트 커버리지 > 80%
- [ ] SM-7: Docker 이미지 크기 < 500MB
```

#### 14. Open Questions

**목적**: 미결정 사항 기록

**템플릿**:
```markdown
## 14. Open Questions

### 미결정 사항

| # | 질문 | 상태 | 담당 | 기한 |
|---|------|------|------|------|
| Q1 | [질문 내용] | 미정/결정됨 | [담당자] | [기한] |
| Q2 | [질문 내용] | 미정/결정됨 | [담당자] | [기한] |

### 결정된 사항

| # | 질문 | 결정 | 결정일 |
|---|------|------|--------|
| Q3 | [질문 내용] | [결정 내용] | [날짜] |
```

---

## PRD 작성 팁

### Do's (해야 할 것)
- 정량적 목표 사용 ("응답 시간 200ms 이하" > "빠른 응답")
- User Story와 FR, Test Case 간 추적성 유지
- 환경별 설정 표 필수 포함
- 허브별 적용 범위 명확히 구분

### Don'ts (하지 말 것)
- 추상적 표현 사용 ("적절히", "필요 시" 등)
- 테스트 데이터 없이 테스트 전략만 작성
- 환경별 차이 무시
- 구현 세부사항을 PRD에 과도하게 포함

---

## 관련 문서

| 문서 | 용도 |
|------|------|
| [실행_기획.md](./실행_기획.md) | 메인 PRD 가이드 |
| [실행_기획-WorkHub.md](./실행_기획-WorkHub.md) | WorkHub 특화 부록 |
| [실행_작업.md](./실행_작업.md) | PRD → Task 변환 |

---

**Last Updated**: 2026-01-14
