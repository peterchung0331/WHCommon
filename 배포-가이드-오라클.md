# Oracle Cloud 배포 가이드

모든 WorkHub 프로젝트는 로컬에서 Docker 이미지를 빌드하여 오라클 클라우드로 전송합니다.

## 배포 원칙

- ✅ **로컬 Docker 빌드**: WSL에서 Docker 이미지 빌드
- ✅ **이미지 전송**: 빌드된 이미지를 tar 파일로 저장하여 오라클 서버로 전송
- ✅ **오라클에서 로드**: 전송된 tar 파일을 Docker 이미지로 로드 후 실행

## 배포 환경 정보

### Oracle Cloud 서버
- **IP**: `158.180.95.246`
- **User**: `ubuntu`
- **SSH Key**: `~/.ssh/oracle-cloud.key` (WSL), `C:\GitHub\WHCommon\SSHkey\ssh-key-2026-01-01.key` (Windows)

### 프로젝트별 포트
- **WBHubManager**: 3090 (Frontend), 4090 (Backend)
- **WBSalesHub**: 3010 (Frontend), 4010 (Backend)
- **WBFinHub**: 3020 (Frontend), 4020 (Backend)
- **HWTestAgent**: 3100 (Frontend), 4100 (Backend)

## 초기 설정 (최초 1회만)

### 1. Docker 설치 확인 (WSL)

```bash
# WSL에서 Docker 설치 확인
docker --version
docker compose version

# Docker가 없으면 설치
# https://docs.docker.com/engine/install/ubuntu/
```

### 2. Oracle Cloud SSH 접속 테스트

```bash
# WSL에서 오라클 서버 접속 테스트
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 "echo 'Connection successful'"
```

## 배포 프로세스

### 방법 1: 자동 배포 스크립트 사용 (권장)

각 프로젝트의 `deploy-oracle.sh` 스크립트를 실행합니다.

```bash
# WSL에서 프로젝트 루트에서 실행
chmod +x deploy-oracle.sh
./deploy-oracle.sh
```

### 방법 2: 수동 배포

```bash
# 1. 로컬에서 Docker 이미지 빌드 (WSL)
cd /home/peterchung/<project-name>
docker build -t <image-name>:latest .

# 2. Docker 이미지를 tar 파일로 저장
docker save <image-name>:latest | gzip > <image-name>.tar.gz

# 3. 오라클 서버로 전송
scp -i ~/.ssh/oracle-cloud.key <image-name>.tar.gz ubuntu@158.180.95.246:/tmp/

# 4. 오라클 서버에서 이미지 로드 및 실행
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 << 'EOF'
  # 이미지 로드
  docker load < /tmp/<image-name>.tar.gz

  # 기존 컨테이너 중지 및 제거
  docker stop <container-name> 2>/dev/null || true
  docker rm <container-name> 2>/dev/null || true

  # 새 컨테이너 실행
  docker run -d \
    --name <container-name> \
    --restart unless-stopped \
    -p <frontend-port>:3090 \
    -p <backend-port>:5050 \
    -e NODE_ENV=production \
    <image-name>:latest

  # 임시 파일 삭제
  rm /tmp/<image-name>.tar.gz

  # 헬스 체크
  sleep 10
  curl -f http://localhost:<backend-port>/api/health || echo "Health check failed"
EOF

# 5. 로컬 tar 파일 삭제
rm <image-name>.tar.gz
```

### 환경변수 전달 방법

**중요**: `.env` 파일 형식으로는 JWT 키(개행 포함)를 전달할 수 없습니다. 따라서 `--env-file` 대신 `-e` 플래그로 직접 전달해야 합니다.

```bash
# ❌ 작동하지 않음 (JWT 키에 개행 문자 포함)
docker run -d --env-file /tmp/.env.prd <image-name>:latest

# ✅ 올바른 방법: -e 플래그로 직접 전달
docker run -d \
  --name <container-name> \
  --restart unless-stopped \
  --network host \
  -e NODE_ENV=production \
  -e DB_HOST=localhost \
  -e DB_USER=<db-user> \
  -e DB_PASSWORD=<db-password> \
  -e DATABASE_URL=<database-url> \
  -e APP_URL=https://workhub.biz \
  -e FRONTEND_URL=https://workhub.biz \
  -e GOOGLE_CLIENT_ID=<client-id> \
  -e GOOGLE_CLIENT_SECRET=<client-secret> \
  -e GOOGLE_REDIRECT_URI=https://workhub.biz/api/auth/google-callback \
  -e SESSION_SECRET=<session-secret> \
  -e COOKIE_DOMAIN=workhub.biz \
  <image-name>:latest
```

**참고**:
- JWT 키는 `server/keys/` 디렉토리의 파일에서 자동 로드됩니다
- 환경변수로 `JWT_PRIVATE_KEY`, `JWT_PUBLIC_KEY`를 전달할 필요 없음
- `--network host` 옵션으로 localhost PostgreSQL 접근 가능

## 프로젝트별 배포 명령어

### WBHubManager
```bash
./deploy-oracle.sh
# 또는 수동:
# docker build -t wbhubmanager:latest .
# docker save wbhubmanager:latest | gzip > wbhubmanager.tar.gz
# scp -i ~/.ssh/oracle-cloud.key wbhubmanager.tar.gz ubuntu@158.180.95.246:/tmp/
# ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 "docker load < /tmp/wbhubmanager.tar.gz && docker stop hubmanager || true && docker rm hubmanager || true && docker run -d --name hubmanager --restart unless-stopped -p 3090:3090 -p 5050:5050 wbhubmanager:latest"
```

### WBSalesHub
```bash
./deploy-oracle.sh
# URL: http://158.180.95.246:3091
```

### WBFinHub
```bash
./deploy-oracle.sh
# URL: http://158.180.95.246:3092
```

### HWTestAgent
```bash
./deploy-oracle.sh
# URL: http://158.180.95.246:3100
```

## 배포 후 확인사항

1. **컨테이너 실행 확인**
   ```bash
   ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 'docker ps | grep <container-name>'
   ```

2. **로그 확인**
   ```bash
   ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 'docker logs -f <container-name>'
   ```

3. **헬스 체크**
   ```bash
   curl http://158.180.95.246:<backend-port>/api/health
   ```

4. **브라우저 접속**
   - Frontend: `http://158.180.95.246:<frontend-port>`
   - Backend API: `http://158.180.95.246:<backend-port>/api/health`

## 신규 프로젝트 생성 시 체크리스트

### 1. 포트 할당
- [ ] Frontend 포트 결정 (3090번대)
- [ ] Backend 포트 결정 (5050번대 또는 4100번대)
- [ ] 이 문서에 포트 정보 업데이트

### 2. Docker 설정 파일 생성
- [ ] `Dockerfile.fullstack` 작성 (Frontend + Backend)
- [ ] `docker-compose.yml` 작성 (선택사항)
- [ ] `.dockerignore` 작성

### 3. 배포 스크립트 생성
- [ ] `deploy-oracle.sh` 스크립트 작성
  - 프로젝트 이름
  - 컨테이너 이름
  - 포트 번호
  - 환경변수
- [ ] 스크립트 실행 권한 부여 (`chmod +x`)

### 4. 프로젝트 문서 업데이트
- [ ] `README.md`에 배포 방법 추가
- [ ] `.claude/settings.json`에 배포 스크립트 등록

### 5. 초기 배포
- [ ] 로컬에서 코드 커밋 및 푸시
- [ ] `deploy-oracle.sh` 실행
- [ ] 배포 확인 (헬스 체크, 브라우저 접속)

## 트러블슈팅

### Docker 이미지 전송 실패
```bash
# 로컬에서 이미지 확인
docker images | grep <image-name>

# SCP 연결 테스트
scp -i ~/.ssh/oracle-cloud.key -v test.txt ubuntu@158.180.95.246:/tmp/

# 오라클 서버 디스크 공간 확인
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 "df -h"
```

### Docker 빌드 실패
```bash
# 로그 확인
docker logs <container-name>

# 디스크 공간 확인
df -h

# 미사용 이미지 정리
docker system prune -a
```

### 포트 충돌
```bash
# 포트 사용 확인
sudo netstat -tulpn | grep <port>

# 기존 컨테이너 중지
docker stop <container-name>
```

## 환경변수 관리

### 로컬 개발 환경
- **환경변수 파일**: `.env.local`
- **로딩 방식**: 애플리케이션 시작 시 `.env.local` 파일에서 로드
- **동기화**: Git Hook이 커밋 전에 자동으로 Doppler에 업로드

### 프로덕션 환경
- **환경변수 파일**: `.env.prd`
- **생성 방식**: 배포 스크립트가 Doppler Production 설정에서 자동 생성
- **전달 방식**: SSH를 통해 오라클 서버에 전달 후 Docker 빌드 시 사용

### Doppler 동기화 Flow
1. **로컬 개발 중**: `.env.local`에서 환경변수 읽기
2. **Git Commit 전**: `.env.local` → Doppler Development (자동 업로드)
3. **Git Pull 후**: Doppler Development → `.env.local` (자동 다운로드)
4. **배포 시**: Doppler Production → `.env.prd` (배포 스크립트가 생성)
5. **오라클 서버**: `.env.prd`를 서버에 전달 후 Docker 빌드

## 이미지 크기 최적화

Docker 이미지 크기가 클 경우 전송 시간이 오래 걸릴 수 있습니다.

### 최적화 방법
1. **Multi-stage 빌드 사용**: Dockerfile에서 불필요한 파일 제거
2. **node_modules 최소화**: `npm ci --omit=dev` 사용
3. **압축 전송**: `gzip`으로 압축하여 전송 (이미 적용됨)
4. **레이어 캐싱**: 변경이 적은 레이어를 먼저 배치

### 예상 이미지 크기
- WBHubManager: ~500MB (압축 후 ~200MB)
- WBSalesHub: ~400MB (압축 후 ~150MB)
- WBFinHub: ~400MB (압축 후 ~150MB)

## 참고사항

- **Railway 사용 안함**: 모든 프로젝트는 오라클 클라우드로 배포
- **환경변수 관리**: `.env.local` (로컬), `.env.prd` (프로덕션) 파일 사용, Doppler는 백업/동기화용
- **WSL 우선 원칙**: 배포 작업은 WSL에서 수행
- **SSH 키 관리**: Oracle SSH 키는 `~/.ssh/oracle-cloud.key`
- **Docker 이미지 전송**: 로컬 빌드 → tar.gz 압축 → SCP 전송 → 오라클 로드

---
마지막 업데이트: 2026-01-06
