# Oracle Cloud 배포 가이드

모든 WorkHub 프로젝트는 오라클 클라우드에서 직접 빌드하여 배포합니다.

## 배포 원칙

- ❌ **로컬 Docker 빌드 금지**: 로컬에서 Docker 이미지를 빌드하지 않음
- ✅ **오라클에서 직접 빌드**: 오라클 클라우드 서버에서 GitHub에서 코드를 받아 빌드
- ✅ **GitHub SSH 키 공유**: 로컬 WSL의 GitHub SSH 키를 오라클 서버에 복사하여 사용

## 배포 환경 정보

### Oracle Cloud 서버
- **IP**: `158.180.95.246`
- **User**: `ubuntu`
- **SSH Key**: `~/.ssh/oracle-cloud.key` (WSL), `C:\GitHub\WHCommon\SSHkey\ssh-key-2026-01-01.key` (Windows)

### 프로젝트별 포트
- **WBHubManager**: 3090 (Frontend), 4090 (Backend)
- **WBSalesHub**: 3010 (Frontend), 4010 (Backend)
- **WBFinHub**: 3020 (Frontend), 4020 (Backend)
- **HWTestAgent**: 3100 (Frontend), 4100 (Backend)

## 초기 설정 (최초 1회만)

### 1. GitHub SSH 키 오라클 서버에 복사

```bash
# WSL에서 실행
scp -i ~/.ssh/oracle-cloud.key ~/.ssh/github_key ubuntu@158.180.95.246:/home/ubuntu/.ssh/
scp -i ~/.ssh/oracle-cloud.key ~/.ssh/github_key.pub ubuntu@158.180.95.246:/home/ubuntu/.ssh/
```

### 2. 오라클 서버에서 SSH 설정

```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246

# 오라클 서버 내부에서 실행
chmod 600 ~/.ssh/github_key
ssh-keyscan github.com >> ~/.ssh/known_hosts

cat >> ~/.ssh/config << 'EOF'
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/github_key
    IdentitiesOnly yes
EOF
```

### 3. GitHub 접속 테스트

```bash
ssh -T git@github.com
# 출력: Hi peterchung0331! You've successfully authenticated...
```

## 배포 프로세스

### 방법 1: 자동 배포 스크립트 사용 (권장)

각 프로젝트의 `deploy-oracle.sh` 스크립트를 실행합니다.

```bash
# WSL에서 프로젝트 루트에서 실행
chmod +x deploy-oracle.sh
./deploy-oracle.sh
```

### 방법 2: 수동 배포

```bash
# 1. 로컬에서 코드 커밋 및 푸시
git add .
git commit -m "feat: ..."
git push origin <branch-name>

# 2. 오라클 서버 접속
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246

# 3. 프로젝트 디렉토리로 이동 또는 클론
cd /home/ubuntu/<project-name>
git pull origin <branch-name>

# 또는 최초 클론
cd /home/ubuntu
git clone -b <branch-name> git@github.com:peterchung0331/<repo-name>.git <project-name>

# 4. Docker 빌드 및 실행
cd /home/ubuntu/<project-name>
docker build -f Dockerfile.fullstack -t <image-name>:latest .

# 기존 컨테이너 중지 및 제거
docker stop <container-name> || true
docker rm <container-name> || true

# 새 컨테이너 실행
docker run -d \
  --name <container-name> \
  --restart unless-stopped \
  -p <frontend-port>:<frontend-port> \
  -p <backend-port>:<backend-port> \
  -e NODE_ENV=production \
  -e PORT=<backend-port> \
  -e NEXT_PUBLIC_API_URL=http://158.180.95.246:<backend-port>/api \
  <image-name>:latest

# 5. 헬스 체크
curl -f http://localhost:<backend-port>/api/health
```

## 프로젝트별 배포 명령어

### WBHubManager
```bash
./deploy-oracle.sh
# 또는
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 'cd /home/ubuntu/wbhubmanager && git pull && docker build -t wbhubmanager:latest . && docker stop hubmanager || true && docker rm hubmanager || true && docker run -d --name hubmanager --restart unless-stopped -p 3090:3090 -p 5050:5050 wbhubmanager:latest'
```

### WBSalesHub
```bash
./deploy-oracle.sh
# URL: http://158.180.95.246:3091
```

### WBFinHub
```bash
./deploy-oracle.sh
# URL: http://158.180.95.246:3092
```

### HWTestAgent
```bash
./deploy-oracle.sh
# URL: http://158.180.95.246:3100
```

## 배포 후 확인사항

1. **컨테이너 실행 확인**
   ```bash
   ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 'docker ps | grep <container-name>'
   ```

2. **로그 확인**
   ```bash
   ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246 'docker logs -f <container-name>'
   ```

3. **헬스 체크**
   ```bash
   curl http://158.180.95.246:<backend-port>/api/health
   ```

4. **브라우저 접속**
   - Frontend: `http://158.180.95.246:<frontend-port>`
   - Backend API: `http://158.180.95.246:<backend-port>/api/health`

## 신규 프로젝트 생성 시 체크리스트

### 1. 포트 할당
- [ ] Frontend 포트 결정 (3090번대)
- [ ] Backend 포트 결정 (5050번대 또는 4100번대)
- [ ] 이 문서에 포트 정보 업데이트

### 2. Docker 설정 파일 생성
- [ ] `Dockerfile.fullstack` 작성 (Frontend + Backend)
- [ ] `docker-compose.yml` 작성 (선택사항)
- [ ] `.dockerignore` 작성

### 3. 배포 스크립트 생성
- [ ] `deploy-oracle.sh` 스크립트 작성
  - 프로젝트 이름
  - 컨테이너 이름
  - 포트 번호
  - 환경변수
- [ ] 스크립트 실행 권한 부여 (`chmod +x`)

### 4. 프로젝트 문서 업데이트
- [ ] `README.md`에 배포 방법 추가
- [ ] `.claude/settings.json`에 배포 스크립트 등록

### 5. 초기 배포
- [ ] 로컬에서 코드 커밋 및 푸시
- [ ] `deploy-oracle.sh` 실행
- [ ] 배포 확인 (헬스 체크, 브라우저 접속)

## 트러블슈팅

### GitHub 접속 실패
```bash
# 오라클 서버에서 SSH 키 확인
ls -la ~/.ssh/github_key
chmod 600 ~/.ssh/github_key

# GitHub 접속 테스트
ssh -T git@github.com
```

### Docker 빌드 실패
```bash
# 로그 확인
docker logs <container-name>

# 디스크 공간 확인
df -h

# 미사용 이미지 정리
docker system prune -a
```

### 포트 충돌
```bash
# 포트 사용 확인
sudo netstat -tulpn | grep <port>

# 기존 컨테이너 중지
docker stop <container-name>
```

## 환경변수 관리

### 로컬 개발 환경
- **환경변수 파일**: `.env.local`
- **로딩 방식**: 애플리케이션 시작 시 `.env.local` 파일에서 로드
- **동기화**: Git Hook이 커밋 전에 자동으로 Doppler에 업로드

### 프로덕션 환경
- **환경변수 파일**: `.env.prd`
- **생성 방식**: 배포 스크립트가 Doppler Production 설정에서 자동 생성
- **전달 방식**: SSH를 통해 오라클 서버에 전달 후 Docker 빌드 시 사용

### Doppler 동기화 Flow
1. **로컬 개발 중**: `.env.local`에서 환경변수 읽기
2. **Git Commit 전**: `.env.local` → Doppler Development (자동 업로드)
3. **Git Pull 후**: Doppler Development → `.env.local` (자동 다운로드)
4. **배포 시**: Doppler Production → `.env.prd` (배포 스크립트가 생성)
5. **오라클 서버**: `.env.prd`를 서버에 전달 후 Docker 빌드

## 참고사항

- **Railway 사용 안함**: 모든 프로젝트는 오라클 클라우드로 배포
- **환경변수 관리**: `.env.local` (로컬), `.env.prd` (프로덕션) 파일 사용, Doppler는 백업/동기화용
- **WSL 우선 원칙**: 배포 작업은 WSL에서 수행
- **SSH 키 관리**: GitHub SSH 키는 `~/.ssh/github_key`, Oracle SSH 키는 `~/.ssh/oracle-cloud.key`

---
마지막 업데이트: 2026-01-02
