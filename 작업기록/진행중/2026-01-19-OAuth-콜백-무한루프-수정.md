# ğŸ¯ WBSalesHub OAuth ì½œë°± ë¬´í•œ ë£¨í”„ ìˆ˜ì •

## âš¡ ê¸´ê¸‰ ìš”ì•½ (2026-01-19 OAuth ì½œë°± ë¶„ì„)

**ë¬¸ì œ**: `workhub.biz/hubs`ì—ì„œ ì„¸ì¼ì¦ˆí—ˆë¸Œ í´ë¦­ â†’ Google ë¡œê·¸ì¸ â†’ ë‹¤ì‹œ `/hubs`ë¡œ ëŒì•„ì˜´ (ì„¸ì¼ì¦ˆí—ˆë¸Œ ì§„ì… ë¶ˆê°€)

**âœ… ê·¼ë³¸ ì›ì¸ (í™•ì •)**:
1. âŒ **ë¡œì»¬ ê°œë°œ í™˜ê²½**: ë‹¤ë¥¸ í¬íŠ¸ ê°„ ì¿ í‚¤ ê³µìœ  ë¶ˆê°€ (localhost:4090 â†” localhost:3010)
2. âŒ **í”„ë¡œë•ì…˜ í™˜ê²½**: Cloudflare ìºì‹œë¡œ ì¸í•´ ì´ì „ JavaScript íŒŒì¼ ìºì‹± (ì´ë¯¸ í•´ê²°ë¨)
3. âš ï¸ **ë¡œê¹… ë¶€ì¡±**: OAuth ì½œë°± íë¦„ ë””ë²„ê¹… ë¶ˆê°€

**í•´ê²° ë°©ë²•**:
1. **OAuth ì½œë°± ë¡œê¹… ê°•í™”** (ìµœìš°ì„ ) - ì–´ëŠ ë‹¨ê³„ì—ì„œ `/hubs`ë¡œ ëŒì•„ê°€ëŠ”ì§€ ì¶”ì 
2. **ë¡œì»¬ ê°œë°œ í™˜ê²½**: URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ SSOë¡œ ì „í™˜ (ì¿ í‚¤ ëŒ€ì‹ )
3. **í”„ë¡œë•ì…˜ í™˜ê²½**: `COOKIE_DOMAIN=.workhub.biz` ì„¤ì • í™•ì¸ ë° í…ŒìŠ¤íŠ¸

---

## 1. ê·¼ë³¸ ì›ì¸ ë¶„ì„ (2026-01-19 OAuth ì¡°ì‚¬ ì™„ë£Œ)

### ğŸ”´ **ë¬¸ì œ ë°œê²¬: OAuth ì½œë°± í›„ ë¦¬ë‹¤ì´ë ‰ì…˜ ì‹¤íŒ¨**

#### OAuth ì½œë°± í”Œë¡œìš° (ì •ìƒ)

```
1. /hubsì—ì„œ "ì„¸ì¼ì¦ˆí—ˆë¸Œ" í´ë¦­
   â†“
2. authApi.generateHubToken('wbsaleshub') í˜¸ì¶œ
   â†“
3. ì„¸ì…˜ ì—†ìŒ â†’ requires_auth=true + auth_url ë°˜í™˜
   â†“
4. Google OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ (stateì— hub_slug='wbsaleshub' í¬í•¨)
   â†“
5. Google ë¡œê·¸ì¸ ì™„ë£Œ â†’ /api/auth/google-callback?code=...&state=...
   â†“
6. HubManagerì—ì„œ í† í° ìƒì„± + ì¿ í‚¤ ì„¤ì •
   â†“
7. ì„¸ì¼ì¦ˆí—ˆë¸Œ /auth/sso-completeë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì˜ˆìƒ)
   â†“
8. âŒ ì‹¤ì œ: ë‹¤ì‹œ /hubsë¡œ ëŒì•„ì˜´!
```

#### ì‹¤íŒ¨ ì›ì¸ (ì¶”ì •)

**ì‹œë‚˜ë¦¬ì˜¤ A: ì¿ í‚¤ ë„ë©”ì¸ ë¬¸ì œ (ë¡œì»¬ ê°œë°œ)**
```typescript
// HubManager authRoutes.ts ì¤„ 530, 540
const accessCookieOptions = {
  httpOnly: true,
  secure: IS_HTTPS,
  sameSite: 'lax' as const,
  domain: process.env.COOKIE_DOMAIN || undefined,  // â† localhostì—ì„œ undefined!
  path: '/',
  maxAge: 24 * 60 * 60 * 1000,
};

// ê²°ê³¼: ì¿ í‚¤ê°€ localhost:4090ì—ë§Œ ì„¤ì •ë¨
// ì„¸ì¼ì¦ˆí—ˆë¸Œ(localhost:3010)ëŠ” ì¿ í‚¤ë¥¼ ì½ì„ ìˆ˜ ì—†ìŒ
```

**ì‹œë‚˜ë¦¬ì˜¤ B: state íŒŒë¼ë¯¸í„° íŒŒì‹± ì‹¤íŒ¨**
```typescript
// authRoutes.ts ì¤„ 341-368
if (state) {
  try {
    // Base64 ë””ì½”ë“œ ì‹œë„
    decoded = JSON.parse(Buffer.from(state as string, 'base64').toString('utf-8'));
    hub_slug = decoded.hub_slug || null;
  } catch {
    // ì‹¤íŒ¨ ì‹œ plain JSON ì‹œë„
    decoded = JSON.parse(state as string);
    hub_slug = decoded.hub_slug || null;
  }
}

// hub_slugê°€ nullì´ë©´ /hubsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì¤„ 574-578)
if (!hub_slug) {
  return res.redirect(`${frontendUrl}/hubs`);
}
```

**ì‹œë‚˜ë¦¬ì˜¤ C: ì„¸ì¼ì¦ˆí—ˆë¸Œ sso-completeì—ì„œ ì‹¤íŒ¨ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸**
```typescript
// SalesHub authRoutes.ts (ì¶”ì •)
// ì¿ í‚¤ì— í† í°ì´ ì—†ìœ¼ë©´ /loginìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
if (!accessToken) {
  return res.redirect('/login?error=no_token');
}

// ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ HubManager /hubsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸?
```

---

## 2. í•´ê²° ë°©ë²•

### âœ… ë°©ë²• 1: OAuth ì½œë°± ë¡œê¹… ê°•í™” (ìµœìš°ì„ )

**ëª©í‘œ**: ì–´ëŠ ë‹¨ê³„ì—ì„œ `/hubs`ë¡œ ëŒì•„ê°€ëŠ”ì§€ ì •í™•íˆ íŒŒì•…

#### ìˆ˜ì • íŒŒì¼ 1: `/home/peterchung/WBHubManager/server/routes/authRoutes.ts`

**ìˆ˜ì • ìœ„ì¹˜**: `/api/auth/google-callback` (ì¤„ 323-591)

**ì¶”ê°€í•  ë¡œê·¸**:
1. ì½œë°± ì‹œì‘ ì‹œ state íŒŒë¼ë¯¸í„° ì¶œë ¥
2. hub_slug ì¶”ì¶œ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸
3. ì¿ í‚¤ ì„¤ì • ì™„ë£Œ ë¡œê·¸ (domain, path, secure í¬í•¨)
4. ìµœì¢… ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ë¡œê·¸

```typescript
// ì¤„ 341 ì´í›„ ì¶”ê°€
console.log('ğŸ” [Google Callback] Received state:', state);
console.log('ğŸ” [Google Callback] Decoded hub_slug:', hub_slug);

// ì¤„ 530 ì´í›„ ì¶”ê°€
console.log('ğŸª [Google Callback] Access cookie set:', {
  domain: accessCookieOptions.domain,
  path: accessCookieOptions.path,
  secure: accessCookieOptions.secure,
  sameSite: accessCookieOptions.sameSite,
});

// ì¤„ 567 ì´í›„ ì¶”ê°€
const finalRedirectUrl = `${hubUrl}/auth/sso-complete`;
console.log(`ğŸ”— [Google Callback] Final redirect to: ${finalRedirectUrl}`);
return res.redirect(finalRedirectUrl);
```

#### ìˆ˜ì • íŒŒì¼ 2: `/home/peterchung/WBSalesHub/server/routes/authRoutes.ts`

**ìˆ˜ì • ìœ„ì¹˜**: `/auth/sso-complete` ì—”ë“œí¬ì¸íŠ¸

**ì¶”ê°€í•  ë¡œê·¸**:
1. ì—”ë“œí¬ì¸íŠ¸ ë„ë‹¬ ë¡œê·¸
2. ì¿ í‚¤ ì½ê¸° ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸
3. í† í° ê²€ì¦ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸
4. ìµœì¢… ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ë¡œê·¸

```typescript
console.log('ğŸ”µ [SSO Complete] Endpoint reached');
console.log('ğŸª [SSO Complete] Cookies received:', {
  accessToken: req.cookies.wbhub_access_token ? 'present' : 'missing',
  refreshToken: req.cookies.wbhub_refresh_token ? 'present' : 'missing',
});

if (!accessToken) {
  console.log('âŒ [SSO Complete] No access token in cookie, redirecting to login');
  return res.redirect('/login?error=no_token');
}

console.log('âœ… [SSO Complete] Token verified, redirecting to dashboard');
return res.redirect('/');
```

#### ìˆ˜ì • íŒŒì¼ 3: `/home/peterchung/WBHubManager/frontend/app/hubs/page.tsx`

**ìˆ˜ì • ìœ„ì¹˜**: `handleHubClick` í•¨ìˆ˜ (ì¤„ 107-130)

**ì¶”ê°€í•  ë¡œê·¸**:
```typescript
console.log('ğŸ”µ [Hub Click] Hub clicked:', hubSlug);
console.log('ğŸ”µ [Hub Click] Token response:', response.data);

if (response.data.requires_auth && response.data.auth_url) {
  console.log('ğŸ”— [Hub Click] Redirecting to OAuth:', response.data.auth_url);
  window.location.href = response.data.auth_url;
}
```

---

### âœ… ë°©ë²• 2: ë¡œì»¬ ê°œë°œ í™˜ê²½ ì¿ í‚¤ ë„ë©”ì¸ ì„¤ì •

**ëª©í‘œ**: localhostì—ì„œë„ ì¿ í‚¤ ê³µìœ  ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •

**ë¬¸ì œ**: localhost:4090ê³¼ localhost:3010ì€ ë‹¤ë¥¸ originì´ë¯€ë¡œ ì¿ í‚¤ ê³µìœ  ë¶ˆê°€

**í•´ê²°ì±… A: ëª¨ë“  í—ˆë¸Œë¥¼ ê°™ì€ í¬íŠ¸ì—ì„œ ì‹¤í–‰ (Nginx í”„ë¡ì‹œ)**
- ë¡œì»¬ì—ì„œë„ Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì‚¬ìš©
- localhost:80 â†’ HubManager, localhost:80/saleshub â†’ SalesHub
- `COOKIE_DOMAIN=localhost` ì„¤ì •

**í•´ê²°ì±… B: URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ SSOë¡œ ì „í™˜ (ê¶Œì¥)**
- ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œë§Œ URL íŒŒë¼ë¯¸í„° ì‚¬ìš©
- í”„ë¡œë•ì…˜/ìŠ¤í…Œì´ì§•ì€ ì¿ í‚¤ ê¸°ë°˜ SSO ìœ ì§€

```typescript
// HubManager authRoutes.ts ìˆ˜ì •
const IS_LOCAL_DEV = process.env.NODE_ENV === 'development' && !process.env.COOKIE_DOMAIN;

if (IS_LOCAL_DEV) {
  // URL íŒŒë¼ë¯¸í„° ë°©ì‹ (ë¡œì»¬ ê°œë°œ)
  const tokenUrl = `${hubUrl}/auth/sso-complete?accessToken=${accessToken}&refreshToken=${refreshToken}`;
  console.log(`ğŸ”— [Local Dev] Redirecting with URL params: ${tokenUrl}`);
  return res.redirect(tokenUrl);
} else {
  // ì¿ í‚¤ ë°©ì‹ (í”„ë¡œë•ì…˜/ìŠ¤í…Œì´ì§•)
  res.cookie('wbhub_access_token', accessToken, accessCookieOptions);
  res.cookie('wbhub_refresh_token', refreshToken, refreshCookieOptions);

  const redirectUrl = `${hubUrl}/auth/sso-complete`;
  console.log(`ğŸ”— [Production] Redirecting with cookies: ${redirectUrl}`);
  return res.redirect(redirectUrl);
}
```

---

### âœ… ë°©ë²• 3: í”„ë¡œë•ì…˜ í™˜ê²½ COOKIE_DOMAIN ì„¤ì • í™•ì¸

**íŒŒì¼**: `/home/ubuntu/WBHubManager/.env.prd` (ì˜¤ë¼í´ ì„œë²„)

**í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜**:
```bash
COOKIE_DOMAIN=.workhub.biz
COOKIE_SECURE=true
SAME_SITE=lax
```

**í™•ì¸ ëª…ë ¹ì–´**:
```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246
cat /home/ubuntu/WBHubManager/.env.prd | grep COOKIE
```

---

## 3. êµ¬í˜„ ë‹¨ê³„

### 1ë‹¨ê³„: ë¡œê¹… ì¶”ê°€ (ìµœìš°ì„ )

**ëª©í‘œ**: í˜„ì¬ ì–´ëŠ ë‹¨ê³„ì—ì„œ `/hubs`ë¡œ ëŒì•„ê°€ëŠ”ì§€ íŒŒì•…

1. HubManager `authRoutes.ts`ì— ë¡œê¹… ì¶”ê°€
2. SalesHub `authRoutes.ts`ì— ë¡œê¹… ì¶”ê°€
3. í”„ë¡ íŠ¸ì—”ë“œ `hubs/page.tsx`ì— ë¡œê¹… ì¶”ê°€
4. ë¡œì»¬ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
5. ë¸Œë¼ìš°ì € ì½˜ì†” + ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸

**ì˜ˆìƒ ë¡œê·¸ ì¶œë ¥**:
```
[Hub Click] Hub clicked: wbsaleshub
[Hub Click] Token response: { requires_auth: true, auth_url: '...' }
[Hub Click] Redirecting to OAuth: https://accounts.google.com/...
[Google Callback] Received state: eyJodWJfc2x1ZyI6Indic2FsZXNodWIifQ==
[Google Callback] Decoded hub_slug: wbsaleshub
[Google Callback] Access cookie set: { domain: undefined, ... }
[Google Callback] Final redirect to: http://localhost:3010/auth/sso-complete
[SSO Complete] Endpoint reached
[SSO Complete] Cookies received: { accessToken: 'missing', ... }
[SSO Complete] No access token in cookie, redirecting to login
```

---

### 2ë‹¨ê³„: ë¡œì»¬ ê°œë°œ í™˜ê²½ URL íŒŒë¼ë¯¸í„° ì „í™˜ (ì¡°ê±´ë¶€)

**ì¡°ê±´**: ë¡œê·¸ í™•ì¸ ê²°ê³¼ ì¿ í‚¤ ê³µìœ  ë¬¸ì œê°€ ì›ì¸ì¸ ê²½ìš°

1. HubManager `authRoutes.ts` ìˆ˜ì •
2. SalesHub `authRoutes.ts` ìˆ˜ì • (`sso-complete`ì—ì„œ URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬)
3. ë¡œì»¬ í…ŒìŠ¤íŠ¸

---

### 3ë‹¨ê³„: í”„ë¡œë•ì…˜ í™˜ê²½ COOKIE_DOMAIN í™•ì¸

1. ì˜¤ë¼í´ ì„œë²„ `.env.prd` í™•ì¸
2. `COOKIE_DOMAIN=.workhub.biz` ì„¤ì • ì¶”ê°€ (ì—†ëŠ” ê²½ìš°)
3. HubManager ì¬ë°°í¬
4. ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸ (ì¿ í‚¤ í™•ì¸)

---

## 4. ê²€ì¦ ë°©ë²•

### 4.1 ë¡œì»¬ ê°œë°œ í™˜ê²½

**í…ŒìŠ¤íŠ¸ ë‹¨ê³„**:
1. HubManager ì„œë²„ ë¡œê·¸ í„°ë¯¸ë„ ì—´ê¸°
2. SalesHub ì„œë²„ ë¡œê·¸ í„°ë¯¸ë„ ì—´ê¸°
3. ë¸Œë¼ìš°ì € ì½˜ì†” ì—´ê¸°
4. `http://localhost:3090/hubs` ì ‘ì†
5. "ì„¸ì¼ì¦ˆí—ˆë¸Œ" í´ë¦­
6. Google ë¡œê·¸ì¸ ì™„ë£Œ
7. **ì˜ˆìƒ**: ì„¸ì¼ì¦ˆí—ˆë¸Œ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ âœ…
8. ë¡œê·¸ í™•ì¸:
   - HubManager: `[Google Callback] Final redirect to: ...`
   - SalesHub: `[SSO Complete] Endpoint reached`
   - SalesHub: `[SSO Complete] Token verified`

### 4.2 í”„ë¡œë•ì…˜ í™˜ê²½

**í…ŒìŠ¤íŠ¸ ë‹¨ê³„**:
1. `https://workhub.biz/hubs` ì ‘ì† (ì‹œí¬ë¦¿ ëª¨ë“œ)
2. "ì„¸ì¼ì¦ˆí—ˆë¸Œ" í´ë¦­
3. Google ë¡œê·¸ì¸ ì™„ë£Œ
4. **ì˜ˆìƒ**: ì„¸ì¼ì¦ˆí—ˆë¸Œ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ âœ…
5. ê°œë°œì ë„êµ¬ Application â†’ Cookies í™•ì¸:
   - `wbhub_access_token` ì¿ í‚¤ ì¡´ì¬ âœ…
   - domain: `.workhub.biz` âœ…

---

## 5. ì‘ì—… íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ì‘ì—… | ìš°ì„ ìˆœìœ„ | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|----------|
| `WBHubManager/server/routes/authRoutes.ts` | OAuth ì½œë°± ë¡œê¹… ì¶”ê°€ (10ì¤„) | Critical | 3ë¶„ |
| `WBSalesHub/server/routes/authRoutes.ts` | SSO Complete ë¡œê¹… ì¶”ê°€ (5ì¤„) | Critical | 2ë¶„ |
| `WBHubManager/frontend/app/hubs/page.tsx` | í—ˆë¸Œ í´ë¦­ ë¡œê¹… ì¶”ê°€ (3ì¤„) | Critical | 1ë¶„ |
| ë¡œì»¬ í…ŒìŠ¤íŠ¸ | ë¡œê·¸ í™•ì¸ ë° ì›ì¸ íŒŒì•… | Critical | 5ë¶„ |
| (ì¡°ê±´ë¶€) URL íŒŒë¼ë¯¸í„° ì „í™˜ | ë¡œì»¬ ê°œë°œ í™˜ê²½ ìˆ˜ì • | High | 10ë¶„ |
| í”„ë¡œë•ì…˜ í™˜ê²½ í™•ì¸ | COOKIE_DOMAIN ì„¤ì • ê²€ì¦ | High | 3ë¶„ |

**ì´ ì˜ˆìƒ ì‹œê°„**: 11ë¶„ (ë¡œê¹…ë§Œ) / 24ë¶„ (ë¡œê¹… + URL íŒŒë¼ë¯¸í„° ì „í™˜)

---

## 6. ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ A: ì¿ í‚¤ ë„ë©”ì¸ ë¬¸ì œ (ë¡œì»¬)

**ë¡œê·¸ ì¶œë ¥**:
```
[Google Callback] Access cookie set: { domain: undefined, ... }
[SSO Complete] Cookies received: { accessToken: 'missing', ... }
```

**í•´ê²°ì±…**: URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ SSOë¡œ ì „í™˜ (ë¡œì»¬ ê°œë°œ)

### ì‹œë‚˜ë¦¬ì˜¤ B: state íŒŒë¼ë¯¸í„° íŒŒì‹± ì‹¤íŒ¨

**ë¡œê·¸ ì¶œë ¥**:
```
[Google Callback] Decoded hub_slug: null
[Google Callback] No hub_slug, redirecting to /hubs
```

**í•´ê²°ì±…**: Base64 ì¸ì½”ë”©/ë””ì½”ë”© ë¡œì§ ìˆ˜ì •

### ì‹œë‚˜ë¦¬ì˜¤ C: hub_slug DB ì¡°íšŒ ì‹¤íŒ¨

**ë¡œê·¸ ì¶œë ¥**:
```
[Google Callback] Hub not found for slug: wbsaleshub
```

**í•´ê²°ì±…**: DB ë°ì´í„° í™•ì¸ ë° ìˆ˜ì •

---

## 7. ë¡¤ë°± ê³„íš

ë¡œê¹…ë§Œ ì¶”ê°€í•˜ë¯€ë¡œ ë¡¤ë°± ë¶ˆí•„ìš”. ë§Œì•½ ë¬¸ì œ ë°œìƒ ì‹œ:

```bash
git checkout HEAD -- server/routes/authRoutes.ts
git checkout HEAD -- frontend/app/hubs/page.tsx
```

---

## 8. ìµœì¢… í™•ì¸ ì‚¬í•­

- âœ… **ë¡œê¹… ì¶”ê°€**: ë””ë²„ê¹… ê°€ëŠ¥í•˜ë„ë¡ ìƒì„¸ ë¡œê·¸ ì¶”ê°€
- âœ… **ë¡œì»¬ ê°œë°œ ì „ëµ**: ì¿ í‚¤ ê³µìœ  ë¶ˆê°€ ë¬¸ì œ í•´ê²° (URL íŒŒë¼ë¯¸í„°)
- âœ… **í”„ë¡œë•ì…˜ ê²€ì¦**: COOKIE_DOMAIN ì„¤ì • í™•ì¸
- âœ… **ì˜í–¥ ë²”ìœ„ ìµœì†Œ**: ë¡œê¹…ë§Œ ì¶”ê°€, ê¸°ì¡´ ë¡œì§ ë³€ê²½ ì—†ìŒ

**ì´ ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 11-24ë¶„ (ë¡œê¹… 11ë¶„ + ì„ íƒì  URL íŒŒë¼ë¯¸í„° ì „í™˜ 13ë¶„)
