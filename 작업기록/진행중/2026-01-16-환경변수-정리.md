# 환경변수 정리 작업

**날짜**: 2026-01-16
**작업자**: Claude + 사용자
**상태**: 플랜 작성 완료, 실행 대기 중

## 작업 개요

4개 프로젝트(WBHubManager, WBSalesHub, WBFinHub, WBOnboardingHub)의 환경변수 파일에서 실제로 사용되지 않는 환경변수를 식별하고 제거하여 관리 복잡도를 줄이는 작업입니다.

## 주요 발견사항

### 전체 통계
- **총 환경변수 개수**: 약 744개
- **미사용 환경변수**: 약 224개 (30%)
- **정리 후 예상**: 약 520개
- **예상 감소율**: 30%

### 공통 미사용 환경변수

#### 1. Doppler 관련 (외부 서비스용, 코드에서 미참조)
```bash
DOPPLER_CONFIG
DOPPLER_ENVIRONMENT
DOPPLER_PROJECT
```

#### 2. Docker 포트 관련 (docker-compose.yml에서만 사용)
```bash
DOCKER_FINHUB_PORT
DOCKER_HUBMANAGER_PORT
DOCKER_ONBOARDING_PORT
DOCKER_PORT
DOCKER_SALESHUB_PORT
DOCKER_TESTAGENT_PORT
DOCKER_HOST_URL
```

#### 3. Railway 관련 (더 이상 사용 안 함)
```bash
RAILWAY_API_TOKEN
RAILWAY_DATABASE_URL
RAILWAY_TOKEN
```

#### 4. 백업 관련 (미구현)
```bash
BACKUP_DIR
BACKUP_RETENTION_DAYS
```

#### 5. 기타 공통 미사용
```bash
TZ                # 시스템 레벨 설정
WSL_HOST_IP       # 개발 환경 전용
```

### 프로젝트별 미사용 환경변수

#### WBHubManager (13개)
```bash
FRONTEND_GOOGLE_CLIENT_ID      # GOOGLE_CLIENT_ID 사용
FRONTEND_GOOGLE_CLIENT_SECRET  # GOOGLE_CLIENT_SECRET 사용
FRONTEND_PORT                  # 미사용
NEXT_PUBLIC_HUB_MANAGER_URL    # 미사용
NEXT_PUBLIC_IS_DOCKER          # 미사용
FINHUB_DATABASE_URL            # DATABASE_URL만 사용
SALESHUB_DATABASE_URL          # DATABASE_URL만 사용
ONBOARDINGHUB_DATABASE_URL     # DATABASE_URL만 사용
ORACLE_DATABASE_URL            # DATABASE_URL과 중복
DB_PROVIDER                    # 미사용
COOKIE_SECURE                  # NODE_ENV로 자동 설정
SAME_SITE                      # 코드에 하드코딩됨
POSTGRES_PORT                  # .env.staging에만, 미사용
```

#### WBSalesHub (5개)
```bash
AUTH_ENABLED          # 미구현
BASE_URL              # 미사용
COOKIE_DOMAIN         # 미사용
HUBMANAGER_API_KEY    # 미구현
WEB_APP_BASE_URL      # 미사용
```

#### WBFinHub (11개)
```bash
ALLOWED_DOMAIN            # 미구현
APP_URL                   # 미구현
DEBUG_LOGGING             # 미구현
FINHUB_URL                # 미구현
GOOGLE_CLIENT_ID          # Google OAuth 미구현
GOOGLE_CLIENT_SECRET      # Google OAuth 미구현
GOOGLE_CALLBACK_URL       # Google OAuth 미구현
NEXTAUTH_SECRET           # NextAuth 사용 안 함
NEXTAUTH_URL              # NextAuth 사용 안 함
SESSION_SECRET            # JWT 사용 중
USE_JWT_AUTH              # AUTH_ENABLED로 대체
```

#### WBOnboardingHub (5개)
```bash
CORS_ORIGINS          # 코드에 하드코딩됨
NEXTAUTH_SECRET       # NextAuth 사용 안 함
NEXTAUTH_URL          # NextAuth 사용 안 함
JWT_PRIVATE_KEY       # HUBMANAGER_PUBLIC_KEY 사용
JWT_PUBLIC_KEY        # HUBMANAGER_PUBLIC_KEY 사용
```

## 실행 계획

### Phase 1: 환경변수 제거

#### 대상 파일
- WBHubManager: `.env.local`, `.env.staging`, `.env.prd`, `.env.template`, `.env.example`
- WBSalesHub: `.env.local`, `.env.staging`, `.env.prd`, `.env.template`
- WBFinHub: `.env.local`, `.env.staging`, `.env.prd`, `.env.template`
- WBOnboardingHub: `.env.local`, `.env.prd`, `.env.template`

#### 제외 파일 (유지)
- `/mnt/c/GitHub/WBHubManager/.env.doppler` - Doppler 토큰 저장용
- `/home/peterchung/WHCommon/.env.doppler` - Doppler 토큰 저장용

### Phase 2: 검증

#### 2.1 백업 생성
```bash
# 모든 .env 파일 백업
cp .env.local .env.local.backup
cp .env.staging .env.staging.backup
cp .env.prd .env.prd.backup
```

#### 2.2 빌드 테스트
```bash
cd /mnt/c/GitHub/WBHubManager && npm run build:server && npm run build:frontend
cd /mnt/c/GitHub/WBSalesHub && npm run build:server && npm run build:frontend
cd /mnt/c/GitHub/WBFinHub && npm run build:server && npm run build:frontend
cd /mnt/c/GitHub/WBOnboardingHub && npm run build:server && npm run build:frontend
```

#### 2.3 환경변수 참조 재검증
```bash
rg "DOPPLER_CONFIG|RAILWAY_API_TOKEN|BACKUP_DIR|SALESHUB_DATABASE_URL" \
   --type ts --type tsx --type js \
   /mnt/c/GitHub/WBHubManager/server \
   /mnt/c/GitHub/WBHubManager/frontend
```

### Phase 3: Doppler 동기화

```bash
/home/peterchung/WHCommon/scripts/push-all-to-doppler.sh
```

### Phase 4: 문서화 및 커밋

```bash
git add .env.local .env.staging .env.prd .env.template .env.example
git commit -m "chore: 미사용 환경변수 정리

- Doppler, Railway, Docker 포트 관련 환경변수 제거
- 중복/미사용 환경변수 정리 (224개 제거, -30%)
- .env.template 및 .env.example 업데이트

영향받는 프로젝트:
- WBHubManager: 77개 → ~50개 (-35%)
- WBSalesHub: 71개 → ~55개 (-22%)
- WBFinHub: 71개 → ~50개 (-30%)
- WBOnboardingHub: 63개 → ~50개 (-21%)
"
git push origin master
```

## 예상 결과

### 환경변수 감소 통계

| 프로젝트 | 환경 | 제거 전 | 제거 후 | 감소율 |
|----------|------|---------|---------|--------|
| WBHubManager | local | 77개 | ~50개 | -35% |
| WBHubManager | staging | 40개 | ~25개 | -37% |
| WBHubManager | prd | 87개 | ~60개 | -31% |
| WBSalesHub | local | 71개 | ~55개 | -22% |
| WBSalesHub | staging | 66개 | ~50개 | -24% |
| WBSalesHub | prd | 76개 | ~60개 | -21% |
| WBFinHub | local | 71개 | ~50개 | -30% |
| WBFinHub | staging | 38개 | ~25개 | -34% |
| WBFinHub | prd | 85개 | ~60개 | -29% |
| WBOnboardingHub | local | 63개 | ~50개 | -21% |
| WBOnboardingHub | prd | 70개 | ~55개 | -21% |

**총 감소: 약 744개 → 약 520개 (224개 제거, -30%)**

### 주요 개선사항
1. ✅ 환경변수 파일 가독성 향상
2. ✅ 신규 개발자 온보딩 시 혼란 감소
3. ✅ Doppler 동기화 시간 단축
4. ✅ 환경변수 관리 복잡도 30% 감소

## 위험 요소 및 완화 방안

### 위험 요소
1. **제거한 환경변수가 런타임에 필요할 수 있음**
   - ✅ 완화: 로컬 빌드 테스트 + 스테이징 배포 테스트

2. **Doppler 동기화 후 롤백 어려움**
   - ✅ 완화: Git으로 이전 .env 파일 버전 관리

3. **Docker Compose에서 DOCKER_* 포트 사용 가능성**
   - ✅ 완화: docker-compose.yml 파일 확인 후 제거

### 롤백 계획
```bash
# Git으로 이전 .env 파일 복원
git checkout HEAD~1 -- .env.local .env.staging .env.prd

# Doppler 재동기화
/home/peterchung/WHCommon/scripts/push-all-to-doppler.sh
```

## 검증 체크리스트

### 빌드 검증
- [ ] WBHubManager 빌드 성공
- [ ] WBSalesHub 빌드 성공
- [ ] WBFinHub 빌드 성공
- [ ] WBOnboardingHub 빌드 성공

### 런타임 검증
- [ ] WBHubManager 서버 실행 성공 (localhost:4090)
- [ ] WBSalesHub 서버 실행 성공 (localhost:4010)
- [ ] WBFinHub 서버 실행 성공 (localhost:4020)
- [ ] WBOnboardingHub 서버 실행 성공 (localhost:4030)

### Health Check
- [ ] `curl http://localhost:4090/api/health` - 200 OK
- [ ] `curl http://localhost:4010/api/health` - 200 OK
- [ ] `curl http://localhost:4020/api/health` - 200 OK
- [ ] `curl http://localhost:4030/api/health` - 200 OK

### 환경변수 참조 검증
- [ ] 제거된 환경변수가 코드에 남아있지 않음 확인

### Doppler 동기화 검증
- [ ] dev_wbhubmanager 환경변수 개수 확인
- [ ] stg_hubmanager 환경변수 개수 확인
- [ ] prd_wbhubmanager 환경변수 개수 확인

## 예상 소요 시간
- Phase 1 (환경변수 제거): 30분
- Phase 2 (검증): 20분
- Phase 3 (Doppler 동기화): 10분
- Phase 4 (문서 업데이트 및 커밋): 10분
- **총 예상 시간: 70분**

## 관련 파일
- 플랜 파일: `/home/peterchung/.claude/plans/logical-growing-cosmos.md`
- 분석 에이전트 ID: a4a410c, a431c9c, ace8917

## 다음 단계
1. 사용자 승인 대기 중
2. 승인 후 Phase 1부터 순차 실행
3. 각 Phase 완료 시 체크리스트 업데이트
4. 최종 결과 기록 및 완료 폴더로 이동
