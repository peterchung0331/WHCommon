# 오라클 서버 스테이징/프로덕션 컨테이너 분리

**작업 일시**: 2026-01-18 15:00 - 16:30 (KST)
**작업자**: Claude Code
**관련 세션**: valiant-stargazing-quokka

## 요약

오라클 클라우드 서버에서 스테이징과 프로덕션 환경을 완전히 분리하여 각각 독립적인 컨테이너로 운영하도록 재구성하였습니다. 기존에는 단일 컨테이너가 스테이징 환경변수를 사용하고 있었으나, 이제 각 환경별로 별도의 컨테이너와 Nginx 설정을 갖추었습니다.

## 배경

### 기존 문제점

1. **FinHub 단일 컨테이너**: `finhub` 컨테이너 하나가 스테이징 환경변수를 사용
2. **프로덕션 FinHub 없음**: 프로덕션 환경에서 FinHub 서비스가 없었음
3. **docker-compose 미정의**: docker-compose.oracle.yml에 FinHub, SalesHub 정의 없음
4. **수동 배포**: 각 컨테이너를 수동으로 관리

### 사용자 결정

> "포트를 4000번대, 4400번대로 나눠서 사용하는걸로 해서 모두 따로 분리해야겠어"

**최종 포트 전략**:
- 컨테이너 내부 포트는 모두 동일 (4090, 4010, 4020)
- 환경 구분은 Nginx 외부 포트로 (스테이징 :4400, 프로덕션 :80/:443)

## 구현 내용

### 1. docker-compose.oracle.yml 전면 재작성

**파일**: `/home/ubuntu/workhub/docker-compose.oracle.yml`

#### 주요 변경사항

- **Profile 분리**: `--profile staging`, `--profile production`
- **스테이징**: 호스트 포트 노출 없음, Nginx :4400으로만 접근
- **프로덕션**: 호스트 포트 4090, 4010, 4020 노출
- **OnboardingHub**: 환경변수 파일 없어서 주석 처리

#### 컨테이너 정의

**스테이징 프로필**:
```yaml
services:
  hubmanager-staging:
    container_name: hubmanager-staging
    profiles: [staging]
    environment:
      - PORT=4090
    networks:
      - workhub-network
    # 호스트 포트 노출 없음

  wbsaleshub-staging:
    container_name: wbsaleshub-staging
    profiles: [staging]
    environment:
      - PORT=4010

  wbfinhub-staging:
    container_name: wbfinhub-staging
    profiles: [staging]
    environment:
      - PORT=4020

  nginx-staging:
    container_name: nginx-staging
    profiles: [staging]
    ports:
      - "4400:4400"
```

**프로덕션 프로필**:
```yaml
services:
  wbhubmanager-prod:
    container_name: wbhubmanager-prod
    profiles: [production]
    environment:
      - PORT=4090
    ports:
      - "4090:4090"  # 호스트 포트 노출

  wbsaleshub-prod:
    container_name: wbsaleshub-prod
    profiles: [production]
    ports:
      - "4010:4010"

  wbfinhub-prod:
    container_name: wbfinhub-prod
    profiles: [production]
    ports:
      - "4020:4020"

  nginx-prod:
    container_name: nginx-prod
    profiles: [production]
    ports:
      - "80:80"
      - "443:443"
```

### 2. Nginx 설정 파일 생성

#### nginx-staging.conf

**파일**: `/home/ubuntu/workhub/nginx/nginx-staging.conf`

**주요 설정**:
- Listen: `:4400 ssl`
- Upstream: `wbfinhub-staging:4020`, `wbsaleshub-staging:4010`, `hubmanager-staging:4090`
- OnboardingHub upstream 주석 처리

#### nginx-prod.conf

**파일**: `/home/ubuntu/workhub/nginx/nginx-prod.conf`

**주요 설정**:
- Listen: `:80` (HTTP)
- Upstream: `wbfinhub-prod:4020`, `wbsaleshub-prod:4010`, `wbhubmanager-prod:4090`
- OnboardingHub upstream 주석 처리

### 3. 환경변수 파일 정리

#### WBFinHub

- `.env.staging`: 기존 파일 사용 (DATABASE_URL=172.19.0.1)
- `.env.prd`: 기존 파일 사용 (DATABASE_URL=172.19.0.1)

#### WBSalesHub

- `.env.staging`: 기존 파일 사용
- `.env.prd`: **신규 생성** (스테이징 복사 후 프로덕션 URL로 수정)

#### WBHubManager

- `.env.prd` DB 주소 수정: `158.180.95.246` → `172.19.0.1` (Docker 게이트웨이)

### 4. 시스템 Nginx 중지

오라클 서버의 시스템 Nginx가 포트 80을 사용하고 있어서 Docker nginx-prod와 충돌:

```bash
sudo systemctl stop nginx
sudo systemctl disable nginx
```

## 배포 과정

### 1단계: 파일 업로드

```bash
# docker-compose.oracle.yml
scp -i ~/.ssh/oracle-cloud.key docker-compose.oracle.yml ubuntu@158.180.95.246:/home/ubuntu/workhub/

# Nginx 설정
scp -i ~/.ssh/oracle-cloud.key nginx/nginx-staging.conf ubuntu@158.180.95.246:/home/ubuntu/workhub/nginx/
scp -i ~/.ssh/oracle-cloud.key nginx/nginx-prod.conf ubuntu@158.180.95.246:/home/ubuntu/workhub/nginx/

# 환경변수 파일
scp -i ~/.ssh/oracle-cloud.key WBFinHub/.env.staging ubuntu@158.180.95.246:/home/ubuntu/workhub/WBFinHub/
scp -i ~/.ssh/oracle-cloud.key WBFinHub/.env.prd ubuntu@158.180.95.246:/home/ubuntu/workhub/WBFinHub/
scp -i ~/.ssh/oracle-cloud.key WBSalesHub/.env.staging ubuntu@158.180.95.246:/home/ubuntu/workhub/WBSalesHub/
scp -i ~/.ssh/oracle-cloud.key WBSalesHub/.env.prd ubuntu@158.180.95.246:/home/ubuntu/workhub/WBSalesHub/
scp -i ~/.ssh/oracle-cloud.key WBHubManager/.env.prd ubuntu@158.180.95.246:/home/ubuntu/workhub/WBHubManager/
```

### 2단계: 기존 컨테이너 정리

```bash
# 기존 finhub 컨테이너 제거
docker stop finhub nginx-staging
docker rm finhub nginx-staging
```

### 3단계: 스테이징 환경 시작

```bash
cd /home/ubuntu/workhub
docker compose -f docker-compose.oracle.yml --profile staging up -d
```

### 4단계: 프로덕션 환경 시작

```bash
cd /home/ubuntu/workhub
docker compose -f docker-compose.oracle.yml --profile production up -d
```

## 최종 결과

### 컨테이너 상태

**스테이징**:
- ✅ hubmanager-staging (healthy)
- ✅ wbsaleshub-staging (running)
- ✅ wbfinhub-staging (running)
- ✅ nginx-staging (running)

**프로덕션**:
- ✅ wbhubmanager-prod (healthy)
- ✅ wbsaleshub-prod (running)
- ✅ wbfinhub-prod (running)
- ✅ nginx-prod (running)

### 접속 URL 검증

**스테이징** (https://staging.workhub.biz:4400):
- `/api/health` → 200 ✅
- `/finhub/api/health` → 200 ✅
- `/saleshub/api/health` → 200 ✅

**프로덕션** (https://workhub.biz):
- `/api/health` → 200 ✅
- `/finhub/api/health` → 200 ✅
- `/saleshub/api/health` → 200 ✅

### 포트 매핑 요약

| 환경 | 컨테이너 내부 포트 | 호스트 포트 노출 | Nginx 외부 포트 |
|------|-------------------|----------------|----------------|
| **스테이징** | 4090, 4010, 4020 | 없음 | :4400 (HTTPS) |
| **프로덕션** | 4090, 4010, 4020 | 4090, 4010, 4020 | :80, :443 |

## 트러블슈팅

### 문제 1: OnboardingHub 환경변수 누락

**증상**: `env file /home/ubuntu/workhub/WBOnboardingHub/.env.staging not found`

**해결**: docker-compose.oracle.yml과 nginx 설정에서 OnboardingHub 주석 처리

### 문제 2: nginx upstream not found

**증상**: `host not found in upstream "wbonboardinghub-staging:4030"`

**해결**: nginx-staging.conf와 nginx-prod.conf에서 onboardinghub upstream 주석 처리

### 문제 3: 포트 80 충돌

**증상**: `failed to bind host port 0.0.0.0:80/tcp: address already in use`

**해결**: 시스템 nginx 중지 (`sudo systemctl stop nginx && sudo systemctl disable nginx`)

### 문제 4: HubManager DB 연결 실패

**증상**: `Postgres is unavailable at 158.180.95.246`

**해결**: WBHubManager/.env.prd의 DB 주소를 `158.180.95.246` → `172.19.0.1`로 변경

### 문제 5: nginx-prod workhub-network 미연결

**증상**: nginx-prod가 upstream 컨테이너에 접근 불가

**해결**: nginx-prod 컨테이너 제거 후 재생성 (`docker rm nginx-prod && docker compose up -d nginx-prod`)

## 참고 문서

- 플랜 파일: `/home/peterchung/.claude/plans/valiant-stargazing-quokka.md`
- 컨텍스트 업데이트: `/home/peterchung/WHCommon/claude-context.md` (2026-01-18)
- 관련 이슈: WBFinHub E2E 테스트 준비 (cookie-auth.spec.ts)

## 향후 작업

1. **OnboardingHub 활성화**: `.env.staging` 및 `.env.prd` 생성 후 컨테이너 활성화
2. **HTTPS 인증서**: nginx-prod에 Let's Encrypt 인증서 적용 (현재 HTTP만 사용)
3. **헬스체크 개선**: FinHub/SalesHub unhealthy 상태 개선 필요
4. **모니터링**: 각 환경별 로그 수집 및 모니터링 설정

## 작업량

**실제 소요 시간**: 1.5시간
**복잡도**: 중 (Docker Compose 재구성, 환경변수 정리, 트러블슈팅)

---

**마지막 업데이트**: 2026-01-18 16:30 (KST)
