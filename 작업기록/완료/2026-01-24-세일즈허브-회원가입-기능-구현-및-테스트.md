# 세일즈허브 회원가입 기능 구현 및 테스트

**작업 일시**: 2026. 01. 24. 08:00 - 08:20 (KST)
**작업자**: Claude Code
**프로젝트**: WBSalesHub, WBHubManager
**작업 유형**: 기능 구현 및 테스트

## 작업 개요

세일즈허브에 이메일/비밀번호 기반 회원가입 기능을 추가하고, 로그인/회원가입 컴포넌트를 공용 패키지로 패키징하여 여러 허브에서 재사용할 수 있도록 구현.

## 구현 내용

### 1. 백엔드 API 추가

#### WBSalesHub/server/services/authService.ts
- `registerUser(email, password)` 메서드 추가
  - 이메일 중복 체크
  - 이메일에서 username 자동 생성 (`@` 앞부분 + 타임스탬프)
  - bcrypt 해싱 (salt rounds: 10)
  - HubManager DB의 users 테이블에 삽입 (status: 'pending')

#### WBSalesHub/server/routes/authRoutes.ts
- `POST /api/auth/register` 엔드포인트 추가
  - 이메일 형식 검증 (정규표현식)
  - 비밀번호 최소 길이 검증 (8자 이상)
  - authService.registerUser 호출

### 2. 프론트엔드 페이지 추가

#### WBSalesHub/frontend/app/(auth)/signup/page.tsx
- 회원가입 폼 컴포넌트
  - 이메일, 비밀번호, 비밀번호 확인 입력 필드
  - 실시간 유효성 검사 (클라이언트 사이드)
    - 비밀번호 8자 미만: 버튼 비활성화 + 안내 메시지
    - 비밀번호 불일치: 버튼 비활성화 + 경고 메시지
    - 비밀번호 일치: "✓ 비밀번호 일치" 메시지
  - 비밀번호 보기/숨기기 토글 (Eye/EyeOff 아이콘)
  - 회원가입 성공 시 성공 화면 표시 → 3초 후 `/pending-approval`로 이동
  - 로그인 페이지 링크

#### WBSalesHub/frontend/lib/api.ts
- `authApi.register(email, password)` 함수 추가

#### WBSalesHub/frontend/app/(auth)/login/page.tsx
- 회원가입 링크 추가 ("계정이 없으신가요? 회원가입")

### 3. 공용 패키지 생성

#### WBHubManager/packages/hub-auth/
새로운 npm 패키지 생성 (기존 JWT 패키지 삭제 후 재생성)

**프론트엔드 컴포넌트**:
- `src/frontend/components/LoginForm.tsx`: 재사용 가능한 로그인 폼
- `src/frontend/components/SignupForm.tsx`: 재사용 가능한 회원가입 폼
- `src/frontend/components/AuthCard.tsx`: 인증 카드 레이아웃
- `src/frontend/components/PendingApproval.tsx`: 승인 대기 화면

**프론트엔드 훅**:
- `src/frontend/hooks/useLogin.ts`: 로그인 로직
- `src/frontend/hooks/useSignup.ts`: 회원가입 로직

**백엔드 유틸리티**:
- `src/backend/middleware/authMiddleware.ts`: 인증 미들웨어
- `src/backend/services/registrationService.ts`: 회원가입 서비스

**공용 타입**:
- `src/types/auth.types.ts`: 인증 관련 타입 정의

**유틸리티**:
- `src/utils/validation.ts`: 이메일/비밀번호 유효성 검사

**package.json 업데이트**:
- WBSalesHub/package.json에 `"@wavebridge/hub-auth": "file:../WBHubManager/packages/hub-auth"` 추가

### 4. E2E 테스트 작성

#### WBSalesHub/e2e/signup.spec.ts
Playwright E2E 테스트 (10개 테스트 케이스)

**테스트 항목**:
1. ✅ 회원가입 폼이 정상 렌더링된다
2. ✅ 비밀번호 짧으면 버튼이 비활성화된다
3. ✅ 비밀번호 8자 이상이면 길이 충족 메시지가 표시된다
4. ✅ 비밀번호 불일치 시 경고 메시지가 표시되고 버튼이 비활성화된다
5. ✅ 비밀번호 일치 시 일치 메시지가 표시된다
6. ✅ 비밀번호 보기/숨기기 토글이 동작한다
7. ✅ 로그인 페이지로 이동할 수 있다
8. ✅ 중복 이메일 회원가입 시 에러 메시지가 표시된다
9. ✅ 회원가입 성공 시 성공 화면이 표시된다
10. ✅ 로그인 페이지에 회원가입 링크가 있다

## 테스트 결과

### API 테스트 ✅

| 테스트 케이스 | 입력 | 결과 | 설명 |
|--------------|------|------|------|
| 짧은 비밀번호 | `test.kim@wavebridge.com` / `1234` | `INVALID_PASSWORD` | ✅ 정상 거부 (8자 미만) |
| 중복 이메일 | `test.kim@wavebridge.com` / `12345678` | `EMAIL_EXISTS` | ✅ 정상 거부 |
| 새 사용자 등록 | `test.kim2@wavebridge.com` / `12345678` | 성공 (status: pending) | ✅ DB 삽입 성공 |

**API 엔드포인트**:
```bash
POST http://localhost:4010/api/auth/register
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "12345678"
}
```

**성공 응답**:
```json
{
  "success": true,
  "message": "회원가입이 완료되었습니다. 관리자 승인을 기다려주세요.",
  "user": {
    "id": 5,
    "email": "test.kim2@wavebridge.com",
    "username": "test.kim2",
    "status": "pending"
  }
}
```

### E2E 테스트 ✅ (10/10 통과)

**실행 명령어**:
```bash
SKIP_AUTH=true npx playwright test e2e/signup.spec.ts --reporter=list
```

**결과**:
```
Running 10 tests using 1 worker

  ✓   1 [chromium] › 회원가입 폼이 정상 렌더링된다 (563ms)
  ✓   2 [chromium] › 비밀번호 짧으면 버튼이 비활성화된다 (489ms)
  ✓   3 [chromium] › 비밀번호 8자 이상이면 길이 충족 메시지가 표시된다 (478ms)
  ✓   4 [chromium] › 비밀번호 불일치 시 경고 메시지가 표시되고 버튼이 비활성화된다 (489ms)
  ✓   5 [chromium] › 비밀번호 일치 시 일치 메시지가 표시된다 (495ms)
  ✓   6 [chromium] › 비밀번호 보기/숨기기 토글이 동작한다 (514ms)
  ✓   7 [chromium] › 로그인 페이지로 이동할 수 있다 (570ms)
  ✓   8 [chromium] › 중복 이메일 회원가입 시 에러 메시지가 표시된다 (614ms)
  ✓   9 [chromium] › 회원가입 성공 시 성공 화면이 표시된다 (630ms)
  ✓  10 [chromium] › 로그인 페이지에 회원가입 링크가 있다 (672ms)

  10 passed (6.3s)
```

## 발견 및 해결한 이슈

### 이슈 #1: 로컬 DB 스키마 불일치

**문제**:
- 로컬 HubManager DB (localhost:5433)의 `users` 테이블에 `status` 컬럼이 없음
- API 호출 시 `SERVER_ERROR` 발생

**원인**:
- 로컬 DB 스키마가 프로덕션(오라클) DB와 동기화되지 않음
- 원격 DB에는 `status` 컬럼이 존재하지만 로컬에는 없었음

**해결**:
```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'active';
UPDATE users SET status = 'active' WHERE status IS NULL;
```

**검증**:
```bash
PGPASSWORD=workhub psql -h localhost -p 5433 -U workhub -d hubmanager -c "\d users"
```

**에러 패턴 DB 기록**:
- Pattern ID: 75
- Solution ID: 64
- Category: database
- Success Rate: 100%

## 등록된 테스트 계정

| ID | 이메일 | Username | Status | 등록일시 |
|----|--------|----------|--------|----------|
| 4 | test.kim@wavebridge.com | test.kim | pending | 2026-01-23 23:14:24 |
| 5 | test.kim2@wavebridge.com | test.kim2 | pending | 2026-01-23 23:14:34 |

## 파일 변경 목록

### 생성된 파일

**백엔드**:
- `WBSalesHub/server/services/authService.ts` (registerUser 메서드 추가)
- `WBSalesHub/server/routes/authRoutes.ts` (POST /register 추가)

**프론트엔드**:
- `WBSalesHub/frontend/app/(auth)/signup/page.tsx` (회원가입 페이지)
- `WBSalesHub/frontend/app/(auth)/login/page.tsx` (회원가입 링크 추가)
- `WBSalesHub/frontend/lib/api.ts` (register API 추가)

**공용 패키지**:
- `WBHubManager/packages/hub-auth/package.json`
- `WBHubManager/packages/hub-auth/tsconfig.json`
- `WBHubManager/packages/hub-auth/src/frontend/components/LoginForm.tsx`
- `WBHubManager/packages/hub-auth/src/frontend/components/SignupForm.tsx`
- `WBHubManager/packages/hub-auth/src/frontend/components/AuthCard.tsx`
- `WBHubManager/packages/hub-auth/src/frontend/components/PendingApproval.tsx`
- `WBHubManager/packages/hub-auth/src/frontend/hooks/useLogin.ts`
- `WBHubManager/packages/hub-auth/src/frontend/hooks/useSignup.ts`
- `WBHubManager/packages/hub-auth/src/backend/middleware/authMiddleware.ts`
- `WBHubManager/packages/hub-auth/src/backend/services/registrationService.ts`
- `WBHubManager/packages/hub-auth/src/types/auth.types.ts`
- `WBHubManager/packages/hub-auth/src/utils/validation.ts`
- `WBHubManager/packages/hub-auth/src/index.ts`

**테스트**:
- `WBSalesHub/e2e/signup.spec.ts` (E2E 테스트)

### 삭제된 파일

- `WBHubManager/packages/hub-auth/` (기존 JWT 패키지)
- `WBSalesHub/packages/hub-auth/` (복사본)
- `WBFinHub/server/lib/hub-auth/` (임베디드 소스)

### 수정된 파일

- `WBSalesHub/package.json` (@wavebridge/hub-auth 의존성 추가)

## 기술 스택

- **백엔드**: Express.js, bcryptjs, PostgreSQL
- **프론트엔드**: Next.js 15, React, TypeScript, TailwindCSS
- **테스트**: Playwright (E2E), curl (API)
- **DB**: PostgreSQL (HubManager DB - 중앙 인증)

## 보안 고려사항

- ✅ 비밀번호 bcrypt 해싱 (salt rounds: 10)
- ✅ 비밀번호 최소 길이 검증 (8자 이상)
- ✅ 이메일 형식 검증 (정규표현식)
- ✅ SQL Injection 방지 (parameterized query)
- ✅ 회원가입 후 기본 status: 'pending' (관리자 승인 필요)
- ✅ 비밀번호 평문 로깅 없음

## 다음 단계

1. ✅ 회원가입 기능 구현 완료
2. ✅ API 테스트 완료
3. ✅ E2E 테스트 완료
4. ⏳ HubManager 어드민 화면에서 계정 승인 기능 추가 (향후 작업)
5. ⏳ 다른 허브(FinHub, OnboardingHub)에 공용 패키지 적용 (향후 작업)

## 참고 문서

- 에러 패턴 DB: http://workhub.biz/testagent/api/error-patterns
- Pattern ID 75: users 테이블 status 컬럼 누락 이슈
- Solution ID 64: ALTER TABLE로 status 컬럼 추가

## 작업 완료 체크리스트

- [x] 백엔드 API 구현
- [x] 프론트엔드 페이지 구현
- [x] 공용 패키지 생성
- [x] API 테스트
- [x] E2E 테스트
- [x] 로컬 DB 스키마 수정
- [x] 에러 패턴 DB 기록
- [x] 작업기록 문서 작성
- [ ] HubManager 어드민 승인 기능 (향후 작업)
