# ë ˆë…¸ë´‡ Slack í”„ë¡œí•„ ì´ë©”ì¼ ì½ê¸° ë° ê¶Œí•œ í™•ì¸ ë¬¸ì œ í•´ê²°

**ì‘ì—… ì¼ì‹œ**: 2026.01.25 10:30 - 11:20 (KST)
**ì‘ì—…ëŸ‰**: 1ì¼ (8 WU)
**ìƒíƒœ**: âœ… ì™„ë£Œ
**ë‹´ë‹¹**: Claude Sonnet 4.5

---

## ë¬¸ì œ ì§„ë‹¨

### í•µì‹¬ ì›ì¸
ë ˆë…¸ë´‡ì´ Slack í”„ë¡œí•„ì—ì„œ ì´ë©”ì¼ì„ ì½ì§€ ëª»í•˜ëŠ” ì´ìœ ëŠ” **Slack App OAuth Scope ë¯¸ì„¤ì •**

- âŒ `users:read` scope ì—†ìŒ â†’ Slack ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ë¶ˆê°€
- âŒ `users:read.email` scope ì—†ìŒ â†’ ì´ë©”ì¼ í•„ë“œ ì ‘ê·¼ ë¶ˆê°€
- ê²°ê³¼: `users.info()` API í˜¸ì¶œ ì‹¤íŒ¨ â†’ WBSalesHub ê³„ì • ë§¤ì¹­ ì‹¤íŒ¨ â†’ ê¶Œí•œ í™•ì¸ ë¶ˆê°€

### í˜„ì¬ ìƒíƒœ (ì‘ì—… ì „)
- âœ… WBSalesHubì˜ ê¶Œí•œ í™•ì¸ ë¡œì§ì€ ì™„ë²½í•˜ê²Œ êµ¬í˜„ë¨ ([renoSlackApp.ts:60-158](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts#L60-L158))
- âœ… Slack API í˜¸ì¶œ ì½”ë“œë„ ì´ë¯¸ ì¡´ì¬í•¨
- âœ… `@slack/bolt` íŒ¨í‚¤ì§€ ì„¤ì¹˜ë¨
- âŒ **OAuth Scopeë§Œ ì¶”ê°€í•˜ë©´ ì¦‰ì‹œ ì‘ë™**

---

## êµ¬í˜„ ì‘ì—…

### Phase 1: Slack App OAuth Scope ì„¤ì • (30ë¶„)

#### 1.1 Slack App ì„¤ì • ë³€ê²½
```
https://api.slack.com/apps
â†’ WBSalesHub ì•± ì„ íƒ
â†’ "OAuth & Permissions" ë©”ë‰´
```

**ì¶”ê°€í•œ Scopes**:
- `users:read` - Slack ì‚¬ìš©ì ì •ë³´ ì½ê¸°
- `users:read.email` - Slack ì‚¬ìš©ì ì´ë©”ì¼ ì½ê¸°

#### 1.2 Bot Token ì¬ë°œê¸‰
- "Reinstall to Workspace" ë²„íŠ¼ í´ë¦­
- ê¶Œí•œ ìŠ¹ì¸
- ìƒˆ Bot Token: `xoxb-***-[MASKED]`

#### 1.3 í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸
**ë¡œì»¬**: `/home/peterchung/WBSalesHub/.env.local`
```bash
SLACK_BOT_TOKEN=xoxb-***-[MASKED]
```

**ì˜¤ë¼í´ ìŠ¤í…Œì´ì§•**: `/home/ubuntu/WBSalesHub/.env.staging`
```bash
SLACK_BOT_TOKEN=xoxb-***-[MASKED]
```

**ì˜¤ë¼í´ í”„ë¡œë•ì…˜**: `/home/ubuntu/WBSalesHub/.env.prd`
```bash
SLACK_BOT_TOKEN=xoxb-***-[MASKED]
```

---

### Phase 3: Slack API ì—ëŸ¬ ë¡œê¹… ê°•í™” (30ë¶„)

#### 3.1 Slack API ì—ëŸ¬ ë¡œê¹… ê°œì„ 
**íŒŒì¼**: [renoSlackApp.ts:100-110](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts#L100-L110)

**ë³€ê²½ ë‚´ìš©**:
```typescript
} catch (slackError) {
  console.error('[RenoSlackApp] Failed to get Slack user info:', slackError);

  // Scope ì—ëŸ¬ êµ¬ì²´ì ìœ¼ë¡œ ë¡œê¹…
  if (slackError && typeof slackError === 'object' && 'data' in slackError) {
    const errorData = (slackError as any).data;
    if (errorData?.error === 'missing_scope') {
      console.error(`[RenoSlackApp] Missing Slack OAuth scope: ${errorData.needed}`);
      console.error('[RenoSlackApp] Please add the required scope in Slack App settings and reinstall the app.');
    }
  }
}
```

#### 3.2 ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ ê°œì„ 
**íŒŒì¼**: [RenoAgent.ts:264-269](WBSalesHub/server/modules/reno/agent/RenoAgent.ts#L264-L269)

**ë³€ê²½ ë‚´ìš©**:
```typescript
case 'not_linked':
  return 'ğŸ”’ ê³ ê° ì •ë³´ ì¡°íšŒë¥¼ ìœ„í•´ì„œëŠ” WBSalesHub ê³„ì • ì—°ê²°ì´ í•„ìš”í•´ìš”!\n' +
         'Slack í”„ë¡œí•„ì˜ ì´ë©”ì¼ì´ WBSalesHub ì´ë©”ì¼ê³¼ ê°™ìœ¼ë©´ ìë™ ì—°ê²°ë¼ìš”~\n\n' +
         'ğŸ’¡ ë§Œì•½ ì´ë©”ì¼ì´ ê°™ì€ë°ë„ ì—°ê²°ì´ ì•ˆ ëœë‹¤ë©´, ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.\n' +
         '(Slack App ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”)\n\n' +
         'ë‹¤ë¥¸ ê±´ ë¬¼ì–´ë´ë„ ê´œì°®ì•„ìš”! ğŸ˜Š';
```

---

### Phase 4: Persona Variant ìë™ ì„ íƒ êµ¬í˜„ (45ë¶„)

#### 4.1 Import ì¶”ê°€
**íŒŒì¼**: [renoSlackApp.ts:14](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts#L14)

```typescript
import type { RenoAgent, UserPermission, PersonaVariant } from '../../reno/agent/RenoAgent.js';
```

#### 4.2 í—¬í¼ í•¨ìˆ˜ ì¶”ê°€
**íŒŒì¼**: [renoSlackApp.ts:188-201](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts#L188-L201)

```typescript
/**
 * Determine persona variant based on user permission
 * - Internal: ì§ì› (ADMIN + hasCustomerAccess)
 * - External: ê³ ê° ë˜ëŠ” ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì
 */
private determinePersonaVariant(permission: UserPermission): PersonaVariant {
  // ADMIN ì—­í• ì´ê³  ê³ ê° ì ‘ê·¼ ê¶Œí•œì´ ìˆìœ¼ë©´ Internal
  if (permission.hasCustomerAccess && permission.user?.role === 'ADMIN') {
    return 'internal';
  }

  // ê·¸ ì™¸ ëª¨ë“  ê²½ìš° External (ê³ ê° ëŒ€ì‘ í†¤)
  return 'external';
}
```

#### 4.3 App Mention í•¸ë“¤ëŸ¬ ìˆ˜ì •
**íŒŒì¼**: [renoSlackApp.ts:464-485](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts#L464-L485)

**ë³€ê²½ ì „**:
```typescript
variant: 'internal', // Slack mentions are internal
```

**ë³€ê²½ í›„**:
```typescript
const variant = this.determinePersonaVariant(permission);

// startSession
variant,

// processMessage
const response = await this.renoAgent.processMessage(
  sessionId,
  userMessage,
  variant
);
```

#### 4.4 Direct Message í•¸ë“¤ëŸ¬ ìˆ˜ì •
**íŒŒì¼**: [renoSlackApp.ts:531-552](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts#L531-L552)

ë™ì¼í•˜ê²Œ `variant` ìë™ ì„ íƒ ì ìš©

---

### Phase 5: ë¹Œë“œ ë° ë°°í¬ (1ì‹œê°„)

#### 5.1 íƒ€ì… ì²´í¬ ë° ë¹Œë“œ
```bash
cd /home/peterchung/WBSalesHub
npm run type-check  # âœ… í†µê³¼
npm run build       # âœ… ì„±ê³µ (1ë¶„ 25ì´ˆ)
```

#### 5.2 Git ì»¤ë°‹ ë° í‘¸ì‹œ
```bash
git add server/modules/integrations/slack/renoSlackApp.ts
git commit -m "fix: ë ˆë…¸ë´‡ Slack í”„ë¡œí•„ ì´ë©”ì¼ ì½ê¸° ë° ê¶Œí•œ í™•ì¸ ë¬¸ì œ í•´ê²°

- Slack API OAuth Scope ì¶”ê°€ ì•ˆë‚´ (users:read, users:read.email)
- Slack API ì—ëŸ¬ ë¡œê¹… ê°•í™” (missing_scope êµ¬ì²´ì  í‘œì‹œ)
- Persona Variant ìë™ ì„ íƒ êµ¬í˜„ (ADMIN=Internal, ê·¸ ì™¸=External)
- ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ ê°œì„  (ì‚¬ìš©ì ì•ˆë‚´ ëª…í™•í™”)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push origin master  # âœ… ì»¤ë°‹ 4a2177c
```

#### 5.3 ì˜¤ë¼í´ ì„œë²„ ë°°í¬
```bash
# SSH ì ‘ì†
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246

# Git Pull
cd /home/ubuntu/WBSalesHub
git pull origin master

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t wbsaleshub:production -f Dockerfile .  # âœ… 1ë¶„ 25ì´ˆ

# í”„ë¡œë•ì…˜ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
docker stop wbsaleshub-prod && docker rm wbsaleshub-prod
docker run -d --name wbsaleshub-prod \
  --env-file /home/ubuntu/WBSalesHub/.env.prd \
  --network workhub-network \
  --restart unless-stopped \
  -p 4010:4010 \
  wbsaleshub:production
```

#### 5.4 ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
```bash
docker ps | grep saleshub
# âœ… wbsaleshub-prod: Up, healthy

docker logs wbsaleshub-prod | grep Reno
# âœ… [RenoAgent] Initialized
# âœ… Reno Slack integration enabled
# âœ… Slack Bot: Enabled
```

---

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© | ë¼ì¸ |
|------|----------|------|
| [renoSlackApp.ts](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts) | PersonaVariant import ì¶”ê°€ | 14 |
| [renoSlackApp.ts](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts) | Slack API ì—ëŸ¬ ë¡œê¹… ê°•í™” | 100-110 |
| [renoSlackApp.ts](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts) | determinePersonaVariant() í•¨ìˆ˜ ì¶”ê°€ | 188-201 |
| [renoSlackApp.ts](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts) | App Mention variant ìë™ ì„ íƒ | 464-485 |
| [renoSlackApp.ts](WBSalesHub/server/modules/integrations/slack/renoSlackApp.ts) | Direct Message variant ìë™ ì„ íƒ | 531-552 |
| [RenoAgent.ts](WBSalesHub/server/modules/reno/agent/RenoAgent.ts) | ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ ê°œì„  | 264-269 |

**í™˜ê²½ë³€ìˆ˜ íŒŒì¼**:
- `/home/peterchung/WBSalesHub/.env.local`
- `/home/ubuntu/WBSalesHub/.env.staging`
- `/home/ubuntu/WBSalesHub/.env.prd`

---

## í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ì»¨í…Œì´ë„ˆ ì •ìƒ ì‘ë™ í™•ì¸
```bash
docker ps
# âœ… wbsaleshub-prod: Up 26 seconds (healthy)

docker exec wbsaleshub-prod printenv SLACK_BOT_TOKEN
# âœ… xoxb-***-[MASKED]

docker logs wbsaleshub-prod | grep -E '(Reno|Slack)'
# âœ… [RenoAgent] Initialized
# âœ… Reno Slack integration enabled at /slack/reno
# âœ… Slack Bot: Enabled
# âœ… Reno AI: Enabled
```

### ì˜ˆìƒ ë™ì‘

#### 1. ADMIN ì‚¬ìš©ì (Internal í˜ë¥´ì†Œë‚˜)
```
@Reno ì•ˆë…•
â†’ "ì•—! ì•ˆë…•í•˜ì„¸ìš”~ ğŸ™‹" (ì´ëª¨ì§€ O, ì¹œê·¼í•œ í†¤)

@Reno ê³ ê° ë¦¬ìŠ¤íŠ¸
â†’ ê³ ê° ëª©ë¡ ë°˜í™˜ (ë°ì´í„° ì¡°íšŒ ì„±ê³µ)
```

#### 2. VIEWER ì‚¬ìš©ì (External í˜ë¥´ì†Œë‚˜)
```
@Reno ì•ˆë…•í•˜ì„¸ìš”
â†’ "ì•ˆë…•í•˜ì„¸ìš”, ì›¨ì´ë¸Œë¸Œë¦¿ì§€ì…ë‹ˆë‹¤." (ì´ëª¨ì§€ X, ê²©ì‹ì²´)

@Reno ê³ ê° ë¦¬ìŠ¤íŠ¸
â†’ ê¶Œí•œ ê±°ë¶€ ë©”ì‹œì§€ (ê²©ì‹ì²´ í†¤)
```

#### 3. ì´ë©”ì¼ ìë™ ë§¤ì¹­
- Slack í”„ë¡œí•„ ì´ë©”ì¼ = WBSalesHub ì´ë©”ì¼ì´ë©´ ìë™ ì—°ê²°
- ì—°ê²° ì‹¤íŒ¨ ì‹œ ê°œì„ ëœ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

---

## ì°¸ê³  ë¬¸ì„œ

### ê´€ë ¨ ì»¤ë°‹
- `4a2177c`: fix: ë ˆë…¸ë´‡ Slack í”„ë¡œí•„ ì´ë©”ì¼ ì½ê¸° ë° ê¶Œí•œ í™•ì¸ ë¬¸ì œ í•´ê²°

### ê´€ë ¨ ì´ìŠˆ
- Slack API `users.info()` í˜¸ì¶œ ì‹¤íŒ¨ë¡œ ì´ë©”ì¼ ì½ê¸° ë¶ˆê°€
- ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨ â†’ ê³ ê° ì •ë³´ ì ‘ê·¼ ì°¨ë‹¨

### ì†”ë£¨ì…˜
- Slack App OAuth Scope ì¶”ê°€ (`users:read`, `users:read.email`)
- Bot Token ì¬ë°œê¸‰ ë° í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸
- Persona Variant ìë™ ì„ íƒ ë¡œì§ êµ¬í˜„
- ì—ëŸ¬ ë¡œê¹… ë° ì‚¬ìš©ì ë©”ì‹œì§€ ê°œì„ 

---

## ì¶”ê°€ ê°œì„  ì‚¬í•­

### í–¥í›„ ì‘ì—…
- [ ] ì‹¤ì œ Slack í™˜ê²½ì—ì„œ E2E í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
- [ ] ì—ëŸ¬ íŒ¨í„´ DBì— ì´ë²ˆ ì´ìŠˆ ê¸°ë¡
- [ ] ë””ë²„ê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸ì— Slack OAuth Scope í•­ëª© ì¶”ê°€

### ëª¨ë‹ˆí„°ë§
í”„ë¡œë•ì…˜ ë¡œê·¸ í™•ì¸:
```bash
ssh -i ~/.ssh/oracle-cloud.key ubuntu@158.180.95.246
docker logs -f wbsaleshub-prod | grep -E '(Reno|Slack|users\.info)'
```

---

**ì‘ì—… ì™„ë£Œ ì‹œê°**: 2026.01.25 11:20 (KST)
**ì´ ì†Œìš” ì‹œê°„**: 50ë¶„
**ê²°ê³¼**: âœ… ì„±ê³µ
