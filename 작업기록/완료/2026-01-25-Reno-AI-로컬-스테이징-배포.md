# Reno AI 프론트엔드 통합 - 로컬 및 스테이징 배포

**작업일**: 2026. 01. 25.
**프로젝트**: WBSalesHub
**작업량**: 0.3일 (2.5 WU)
**관련 작업**: [2026-01-25-Reno-AI-프론트엔드-통합-자동화.md](./2026-01-25-Reno-AI-프론트엔드-통합-자동화.md)

## 작업 개요

Reno AI 프론트엔드 통합 작업(Phase 1-3)을 완료한 후, 로컬 개발 환경과 스테이징 환경에 배포하여 크론 작업이 정상적으로 동작하는지 검증했습니다.

### 배포 목표
1. 로컬 환경에서 개발 서버 실행 준비
2. 스테이징 환경에서 크론 작업 정상 동작 확인
3. 프로덕션 배포 전 최종 검증

---

## 배포 작업 내역

### 1. 로컬 환경 배포

#### 1.1 데이터베이스 마이그레이션
**목적**: `cron_logs` 테이블 생성

**실행 명령**:
```bash
PGPASSWORD=workhub psql -h localhost -p 5433 -U workhub -d saleshub < server/database/migrations/015_add_cron_logs_table.sql
```

**결과**:
```
CREATE TABLE
CREATE INDEX
CREATE INDEX
COMMENT (×5)
```

**테이블 구조 확인**:
```sql
\d cron_logs

Table "public.cron_logs"
      Column       |           Type           | Nullable |                Default
-------------------+--------------------------+----------+---------------------------------------
 id                | integer                  | not null | nextval('cron_logs_id_seq'::regclass)
 job_name          | character varying(100)   | not null |
 success           | boolean                  | not null | false
 records_processed | integer                  |          | 0
 errors            | jsonb                    |          |
 created_at        | timestamp with time zone |          | now()
Indexes:
    "cron_logs_pkey" PRIMARY KEY, btree (id)
    "idx_cron_logs_created_at" btree (created_at DESC)
    "idx_cron_logs_job_name" btree (job_name)
```

#### 1.2 환경변수 설정
**파일**: `.env.local`

**추가한 내용**:
```bash
# Cron Jobs (로컬 개발 시 비활성화)
CRON_ENABLED=false
```

**이유**: 로컬 개발 환경에서는 불필요한 Slack 알림 발송을 방지하기 위해 크론 작업을 비활성화

#### 1.3 로컬 환경 상태
- ✅ DB 마이그레이션 완료
- ✅ 환경변수 설정 완료
- ✅ 개발 서버 실행 준비 완료 (`npm run dev`)

**로컬 접속 정보**:
- 프론트엔드: `http://localhost:3010`
- 백엔드: `http://localhost:4010/api/health`

---

### 2. 스테이징 환경 배포

#### 2.1 서버 코드 동기화
**원격 서버**: `ubuntu@158.180.95.246`

**동기화 과정**:
```bash
# 로컬에서 푸시
git push origin master  # 커밋: 4703183

# 원격에서 풀
cd /home/ubuntu/WBSalesHub
git pull origin master
```

**충돌 해결**:
- 문제: `packages/hub-auth/` 파일 충돌 발생
- 해결: `git reset --hard origin/master`로 강제 리셋

**최종 커밋**: `4703183` (fix: require is not defined 에러 수정)

#### 2.2 데이터베이스 마이그레이션
**실행 명령**:
```bash
sudo -u postgres psql -d saleshub < server/database/migrations/015_add_cron_logs_table.sql
```

**결과**:
```
CREATE TABLE
CREATE INDEX
CREATE INDEX
COMMENT (×5)
```

#### 2.3 환경변수 설정
**파일**: `.env.staging`

**추가한 내용**:
```bash
# Cron Jobs
CRON_ENABLED=true
```

**기존 환경변수 확인**:
- ✅ `SLACK_BOT_TOKEN=xoxb-...` (존재)
- ✅ `SLACK_SIGNING_SECRET=...` (존재)

#### 2.4 Docker 빌드 및 배포

**Docker 이미지 빌드**:
```bash
docker build -t wbsaleshub:staging-latest .
```

**빌드 시간**: 1분 42초

**빌드 주요 단계**:
1. **deps 스테이지** (15.9초)
   - npm 의존성 설치 (BuildKit 캐시 활용)
   - 512개 패키지 설치

2. **frontend-builder 스테이지** (121.8초)
   - Next.js 빌드 (Static Export)
   - 16개 페이지 생성
   - ESLint 경고 (기존 문제, 기능 무관)

3. **backend-builder 스테이지** (17.2초)
   - TypeScript 컴파일
   - **크론 파일 포함 확인**:
     - `dist/server/cron/index.js`
     - `dist/server/cron/generateUpcomingMeetingBriefings.js`
     - `dist/server/cron/notifyDealsAtRisk.js`

4. **runner 스테이지**
   - 최종 이미지 생성 (Node.js 20-alpine 기반)

**최종 이미지 크기**: 약 300MB

**컨테이너 시작**:
```bash
docker run -d \
  --name wbsaleshub-staging \
  --restart unless-stopped \
  --network workhub-network \
  --env-file .env.staging \
  -e CRON_ENABLED=true \
  --health-cmd='curl -f http://localhost:4010/api/health || exit 1' \
  --health-interval=30s \
  --health-timeout=5s \
  --health-retries=3 \
  wbsaleshub:staging-latest
```

**주의사항**:
- `--env-file`만으로는 `.env.staging`의 `CRON_ENABLED`가 로드되지 않는 이슈 발견
- **해결**: `-e CRON_ENABLED=true` 명시적 전달 필요

#### 2.5 배포 검증

**컨테이너 상태 확인**:
```bash
docker ps | grep wbsaleshub-staging
```

**결과**:
```
b4e6449be736   wbsaleshub:staging-latest   ...   Up 2 minutes (healthy)   4010/tcp   wbsaleshub-staging
```

**로그 확인**:
```bash
docker logs wbsaleshub-staging 2>&1 | grep -i cron
```

**크론 초기화 성공 로그**:
```
✅ Reno AI routes registered
⏰ Initializing cron jobs...
✅ Cron jobs initialized:
  - Meeting briefings: Daily at 00:00 KST
  - At-risk notifications: Daily at 09:00 KST

==================================================
✅ All services initialized successfully
🤖 Slack Bot: Enabled
🤖 Reno AI: Enabled
==================================================
```

**헬스체크 확인**:
```bash
curl https://staging.workhub.biz:4400/saleshub/api/health
```

**응답**:
```json
{
  "success": true,
  "message": "WBSalesHub API is running",
  "timestamp": "2026-01-24T23:16:24.786Z",
  "port": 4010,
  "authMode": "Session",
  "serverReady": true
}
```

---

## 배포 후 검증 항목

### 스테이징 환경 체크리스트

#### 1. 크론 작업 초기화
- [x] ✅ 크론 스케줄러 초기화 성공
- [x] ✅ 미팅 브리핑 크론 등록 (매일 00:00 KST)
- [x] ✅ 위험 고객 알림 크론 등록 (매일 09:00 KST)

#### 2. 데이터베이스
- [x] ✅ `cron_logs` 테이블 생성 완료
- [x] ✅ 인덱스 생성 완료 (job_name, created_at)

#### 3. 환경변수
- [x] ✅ `CRON_ENABLED=true` (스테이징)
- [x] ✅ `SLACK_BOT_TOKEN` 존재
- [x] ✅ `SLACK_SIGNING_SECRET` 존재

#### 4. 컨테이너 상태
- [x] ✅ 컨테이너 실행 중 (healthy)
- [x] ✅ 네트워크 연결 (`workhub-network`)
- [x] ✅ 헬스체크 통과
- [x] ✅ 자동 재시작 설정 (`--restart unless-stopped`)

#### 5. 서비스 초기화
- [x] ✅ 데이터베이스 연결 성공
- [x] ✅ Slack 봇 초기화 성공
- [x] ✅ Reno AI 초기화 성공
- [x] ✅ 정적 파일 서빙 설정 완료
- [x] ✅ 모든 라우트 등록 완료

---

## 발견된 이슈 및 해결

### Issue 1: 환경변수 로드 실패
**문제**:
- `--env-file .env.staging`만 사용 시 `CRON_ENABLED` 로드 안 됨
- 로그: "⏰ Cron jobs are disabled (CRON_ENABLED=false)"

**원인**:
- Docker의 `--env-file` 파싱 문제로 추정
- `.env.staging` 파일 끝에 추가한 변수가 로드되지 않음

**해결**:
```bash
# 명시적 환경변수 전달 추가
-e CRON_ENABLED=true
```

**검증**:
```bash
docker exec wbsaleshub-staging env | grep CRON
# 출력: CRON_ENABLED=true
```

### Issue 2: 크론 파일 빌드 누락 (초기)
**문제**:
- Docker 이미지에 `/app/dist/server/cron/` 폴더 없음
- 로컬에서는 빌드되었지만 원격 서버에서 누락

**원인**:
- `dist/` 폴더가 `.gitignore`에 포함되어 Git 추적 안 됨
- 원격 서버에서 빌드 시 크론 파일 생성됨

**해결**:
- 원격 서버에서 Docker 빌드 다시 실행
- `docker build` 시 TypeScript 컴파일 단계에서 크론 파일 자동 생성

**검증**:
```bash
docker exec wbsaleshub-staging ls -la /app/dist/server/cron/
# 출력: index.js, generateUpcomingMeetingBriefings.js, notifyDealsAtRisk.js
```

---

## 접속 정보

### 스테이징 환경
- **URL**: `https://staging.workhub.biz:4400/saleshub`
- **백엔드 헬스체크**: `https://staging.workhub.biz:4400/saleshub/api/health`
- **컨테이너명**: `wbsaleshub-staging`
- **네트워크**: `workhub-network`
- **포트**: 4010 (내부), 4400 (Nginx)

### 로컬 환경
- **프론트엔드**: `http://localhost:3010`
- **백엔드**: `http://localhost:4010/api/health`
- **실행 명령**: `npm run dev`

---

## 크론 작업 상세

### 1. 미팅 브리핑 자동 생성
**스케줄**: `0 0 * * *` (매일 자정, KST)

**동작**:
1. 24시간 이내 예정된 미팅 조회
2. 각 미팅에 대해 브리핑 생성
3. `cron_logs` 테이블에 실행 결과 저장

**파일**: `server/cron/generateUpcomingMeetingBriefings.ts`

**로그 포맷**:
```json
{
  "job_name": "meeting_briefing",
  "success": true,
  "records_processed": 5,
  "errors": null,
  "created_at": "2026-01-26T00:00:01Z"
}
```

### 2. 위험 고객 Slack 알림
**스케줄**: `0 9 * * *` (매일 오전 9시, KST)

**동작**:
1. 건강도 50점 미만 고객 조회
2. 고객 정보 및 담당자 조회
3. 담당자 이메일로 Slack User ID 매핑
4. Slack DM 발송 (블록 메시지)
5. `cron_logs` 테이블에 실행 결과 저장

**파일**: `server/cron/notifyDealsAtRisk.ts`

**Slack 메시지 형식**:
```
🚨 고객 주의 알림

고객명: (주)샘플컴퍼니
건강도 점수: 45/100 (↓ declining)

추천 액션:
• 최근 30일 간 미팅 기록 없음 - 즉시 미팅 일정 잡기
• 마지막 이메일 후 2주 경과 - 팔로업 메일 발송
• 문의 응답 지연 (평균 3일) - 응답 시간 단축 필요

[고객 상세 보기] 버튼
```

**이메일 → Slack User ID 매핑**:
- 형식: `${primaryContactWB}@workhub.biz`
- API: `app.client.users.lookupByEmail()`

**로그 포맷**:
```json
{
  "job_name": "notify_at_risk",
  "success": true,
  "records_processed": 3,
  "errors": ["Failed to notify for (주)ABC: Slack user not found"],
  "created_at": "2026-01-26T09:00:01Z"
}
```

---

## 수동 테스트 방법

### 크론 작업 즉시 실행 (테스트용)
스테이징 서버에서:

```typescript
// server/index.ts 또는 별도 스크립트에서
import { triggerMeetingBriefings, triggerAtRiskNotifications } from './cron/index.js';

// 미팅 브리핑 즉시 실행
await triggerMeetingBriefings();

// 위험 고객 알림 즉시 실행
await triggerAtRiskNotifications();
```

### 크론 로그 조회
```sql
-- 최근 10개 크론 실행 로그
SELECT * FROM cron_logs
ORDER BY created_at DESC
LIMIT 10;

-- 성공률 확인
SELECT
  job_name,
  COUNT(*) as total_runs,
  SUM(CASE WHEN success THEN 1 ELSE 0 END) as successful_runs,
  ROUND(100.0 * SUM(CASE WHEN success THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate
FROM cron_logs
GROUP BY job_name;
```

---

## 배포 타임라인

| 시간 | 작업 | 상태 |
|------|------|------|
| 08:13 | 로컬 DB 마이그레이션 | ✅ 완료 |
| 08:14 | 로컬 환경변수 설정 | ✅ 완료 |
| 08:14 | 스테이징 코드 동기화 | ✅ 완료 |
| 08:15 | 스테이징 DB 마이그레이션 | ✅ 완료 |
| 08:15 | 스테이징 환경변수 설정 | ✅ 완료 |
| 08:14-08:16 | 스테이징 Docker 빌드 | ✅ 완료 (1분 42초) |
| 08:16 | 컨테이너 시작 (1차) | ⚠️ 환경변수 로드 실패 |
| 08:17 | 컨테이너 재시작 (2차) | ✅ 크론 초기화 성공 |
| 08:18 | 배포 검증 완료 | ✅ 완료 |

**총 소요 시간**: 약 5분

---

## 프로덕션 배포 준비사항

### 배포 전 체크리스트
- [ ] 스테이징 환경에서 24시간 모니터링
- [ ] 크론 로그 정상 기록 확인
- [ ] Slack 알림 수신 테스트
- [ ] 미팅 브리핑 생성 테스트
- [ ] 프론트엔드 UI 동작 확인
  - [ ] 대시보드 위험 거래 위젯
  - [ ] 고객 목록 건강도 컬럼
  - [ ] 고객 상세 건강도 배지
  - [ ] 미팅노트 팔로업 메일 생성

### 프로덕션 배포 절차
1. `.env.prd`에 `CRON_ENABLED=true` 추가
2. 프로덕션 DB 마이그레이션 실행
3. Docker 이미지 빌드 (`wbsaleshub:production-latest`)
4. 컨테이너 배포 (명시적 `-e CRON_ENABLED=true` 포함)
5. 크론 초기화 로그 확인
6. 헬스체크 통과 확인

---

## 기술적 결정사항

### 1. 로컬 환경에서 크론 비활성화
**이유**:
- 개발 중 불필요한 Slack 알림 방지
- 데이터베이스 부하 감소
- 테스트 시에만 수동으로 실행 가능

### 2. 스테이징 환경변수 명시적 전달
**결정**: `--env-file` + `-e CRON_ENABLED=true` 병행 사용

**이유**:
- `--env-file`만으로는 모든 변수가 로드되지 않는 Docker 이슈
- 중요한 환경변수는 명시적으로 전달하여 확실성 보장

### 3. 크론 타임존 설정
**선택**: `Asia/Seoul` (KST)

**이유**:
- 한국 기업 대상 서비스
- 업무 시간 기준 알림 필요 (오전 9시)
- 자정 배치는 한국 시간 기준

---

## 참고 문서

- **구현 작업기록**: [2026-01-25-Reno-AI-프론트엔드-통합-자동화.md](./2026-01-25-Reno-AI-프론트엔드-통합-자동화.md)
- **PRD**: `/home/peterchung/WHCommon/기획/진행중/PRD-Reno-AI-Integration.md`
- **배포 가이드**: `/home/peterchung/WHCommon/문서/가이드/배포-가이드-오라클.md`

---

## 다음 작업

1. **스테이징 환경 모니터링** (24시간)
   - 크론 로그 기록 확인
   - 에러 발생 여부 모니터링
   - Slack 알림 수신 테스트

2. **프로덕션 배포** (스테이징 검증 완료 후)
   - 동일 절차 반복
   - 프로덕션 환경변수 설정
   - 크론 작업 활성화

3. **향후 개선사항**
   - `notification_history` 테이블 구현 (중복 알림 방지)
   - 미팅 상세 페이지 브리핑 탭 추가
   - 크론 작업 관리 UI 추가 (관리자 전용)

---

## 작업 완료 시점

**날짜**: 2026. 01. 25.
**시간**: 08:18 (KST)
**상태**: ✅ 완료 (로컬 + 스테이징 배포)
