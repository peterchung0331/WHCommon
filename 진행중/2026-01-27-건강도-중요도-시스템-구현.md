# WBSalesHub 건강도 & 중요도 시스템 구현

## 📋 프로젝트 개요

### 목적
영업 팀이 고객의 거래 건강도(Deal Health)와 중요도(Importance)를 실시간으로 모니터링하고, AI 기반 추천사항을 통해 효과적인 영업 전략을 수립할 수 있도록 지원

### 작업 기간
- 시작일: 2026-01-27
- 현재 상태: 스테이징 배포 완료

### 담당자
- 개발: Claude Code
- 검토: Peter Chung

---

## 🎯 핵심 기능

### 1. 건강도(Deal Health) 스코어링 시스템

#### 계산 로직
6가지 주요 요인을 기반으로 0-100점 척도로 건강도 점수 산출:

1. **세일즈 활동 빈도 (Engagement)** - 가중치 25%
   - 최근 30일간 활동 유형별 가중치 적용
   - 미팅(1.5점) > 계약(2.0점) > 제안(1.2점) > 전화(1.0점) > 이메일(0.5점)
   - 불만(-2.0점), 기타(0.3점)
   - 점수 기준: 우수(5.0+), 양호(3.0+), 보통(2.0+), 미흡(1.0+)

2. **마지막 연락 경과 (Recency)** - 가중치 20%
   - 경고 기준: 14일 이상 경과
   - 위험 기준: 30일 이상 경과
   - 중요도 연동 감점: 중요한 고객일수록 더 빠르게 감점
   - 감점 공식: `기본감점(1점/일) × min(중요도/50, 최대배수2.0) × (경과일 - 3일)`

3. **마일스톤 완료도 (Milestone)** - 가중치 20%
   - 온보딩 완료 여부 (50점)
   - KYC 완료 여부 (50점)

4. **CSM 관계 평가 (Relationship)** - 가중치 15%
   - CSM의 주관적 평가 (0-100점)
   - 30일 이내 평가만 유효
   - 평가 만료 시 0점 처리

5. **영업 단계 (Stage)** - 가중치 10%
   - 액티브: 100점
   - 계약 안내 완료: 90점
   - 회원가입 완료: 70점
   - 회원가입 진행중: 50점
   - 잠재 고객: 30점
   - 휴면/지연: 10점
   - Drop: 0점

6. **위험 신호 (Risk)** - 가중치 10%
   - 온보딩 진행 중 장기 지연 감점
   - CSM 평가가 낮거나 만료된 경우 감점

#### 트렌드 분석
- 최근 5개 기록과 비교하여 추세 판단
- `improving`: 평균 대비 +5점 이상 상승
- `declining`: 평균 대비 -5점 이하 하락
- `stable`: 그 외

#### AI 추천사항
건강도 점수 및 요인 분석을 기반으로 자동 생성:
- 낮은 요인 개선 방안 제시
- 영업 단계별 액션 아이템 제안
- 위험 신호에 대한 대응 전략 권장

---

### 2. 중요도(Importance) 스코어링 시스템

#### 계산 로직
4가지 주요 요인을 기반으로 0-100점 척도로 중요도 점수 산출:

1. **회사 규모 (Company Size)** - 가중치 25%
   - 대기업/금융기관: 100점
   - 중견기업: 80점
   - 중소기업: 60점
   - 스타트업: 40점
   - 개인/기타: 20점

2. **잠재 거래량 (Potential Volume)** - 가중치 30%
   - 우수: 100건/월 이상 (100점)
   - 양호: 50건/월 이상 (80점)
   - 보통: 20건/월 이상 (60점)
   - 미흡: 5건/월 이상 (40점)
   - 그 외: 선형 보간

3. **잠재 거래 빈도 (Potential Frequency)** - 가중치 20%
   - 일간: 100점
   - 주간: 80점
   - 월간: 60점
   - 분기: 40점
   - 연간: 20점

4. **잠재 수탁금액 (Potential AUM)** - 가중치 25%
   - 우수: 100억원 이상 (100점)
   - 양호: 50억원 이상 (80점)
   - 보통: 10억원 이상 (60점)
   - 미흡: 1억원 이상 (40점)
   - 그 외: 선형 보간

---

### 3. 설정 관리 시스템

#### 데이터베이스 기반 설정
모든 가중치, 임계값, 점수 기준을 DB에서 관리:

**건강도 설정 테이블 (`health_config`)**
- 가중치 6개 (합계 100%)
- 기준 기간 4개 (활동 측정, 연락 경과 경고/위험, CSM 평가 유효기간)
- 감점 설정 3개 (기본 감점률, 최대 배수, 감점 시작일)
- 활동 유형별 점수 7개
- 영업 단계별 점수 7개
- Engagement 점수 기준 4개

**중요도 설정 테이블 (`importance_config`)**
- 가중치 4개 (합계 100%)
- 회사 규모 등급별 점수 5개
- 거래량 기준 4개
- 거래 빈도 점수 5개
- 수탁금액 기준 4개

#### 관리자 UI
`/settings/deal-config` 페이지에서 실시간 설정 변경:
- 건강도 설정 탭
- 중요도 설정 탭
- 각 설정 항목별 입력 필드
- 저장 버튼 클릭 시 즉시 반영
- 변경 이력 기록 (updated_at)

---

### 4. 프론트엔드 대시보드

#### Deal Health Insights 컴포넌트
`/customers/:customerId` 페이지 내 통합:

1. **건강도 점수 카드**
   - 대형 숫자 표시 (0-100)
   - 트렌드 아이콘 및 레이블 (개선 중/안정적/하락 중)
   - 점수 범위별 색상 코딩:
     - 70점 이상: 녹색
     - 40-70점: 노란색
     - 40점 미만: 빨간색
   - 마지막 업데이트 시간 표시

2. **건강도 요인 분석 레이더 차트**
   - 5가지 주요 요인을 시각화
   - Recharts 라이브러리 사용
   - 호버 시 상세 점수 표시

3. **건강도 추이 차트**
   - 최근 5개 기록을 시간순으로 표시
   - 라인 차트로 트렌드 시각화
   - 날짜별 점수 변화 확인

4. **AI 추천사항 목록**
   - 번호 매긴 리스트 형태
   - 각 추천사항마다 액션 아이템 제시
   - 건강도 개선을 위한 구체적 가이드

5. **유사 고객 비교 패널**
   - 산업/규모가 유사한 고객 5개 표시
   - 각 고객의 건강도 점수 비교
   - 클릭 시 해당 고객 페이지로 이동

#### 실시간 데이터 갱신
- React Query를 사용한 자동 갱신 (1분 간격)
- 로딩 상태 표시
- 에러 처리 및 재시도 로직

---

## 🏗️ 기술 아키텍처

### 백엔드 (Node.js + Express + TypeScript)

#### API 엔드포인트

**1. 건강도 조회**
```
GET /api/reno/deal-health/:customerId
```
- 실시간 건강도 계산 및 반환
- 최근 히스토리와 비교하여 트렌드 판단
- AI 추천사항 생성

**2. 건강도 히스토리 조회**
```
GET /api/reno/deal-health/:customerId/history?limit=5
```
- 과거 건강도 기록 조회
- 최신순 정렬
- 개수 제한 가능

**3. 건강도 설정 조회**
```
GET /api/settings/deal-config/health
```
- 활성화된 모든 건강도 설정 반환
- 타입별 그룹핑

**4. 건강도 설정 업데이트**
```
PUT /api/settings/deal-config/health
```
- 여러 설정 항목 일괄 업데이트
- 트랜잭션 처리
- 변경 시간 자동 기록

**5. 중요도 설정 조회 및 업데이트**
```
GET /api/settings/deal-config/importance
PUT /api/settings/deal-config/importance
```
- 건강도 설정과 동일한 패턴

#### 서비스 레이어

**DealHealthService** (`server/services/dealHealthService.ts`)
- `calculateDealHealth()`: 건강도 계산 메인 로직
- `getHealthHistory()`: 히스토리 조회
- `saveHealthScore()`: 계산 결과 DB 저장
- `generateRecommendations()`: AI 추천사항 생성
- 각 요인별 계산 메서드:
  - `calculateEngagementScore()`
  - `calculateRecencyScore()`
  - `calculateMilestoneScore()`
  - `calculateRelationshipScore()`
  - `calculateStageScore()`
  - `calculateRiskScore()`

**DealConfigService** (`server/services/dealConfigService.ts`)
- `getHealthConfig()`: 건강도 설정 조회
- `updateHealthConfig()`: 건강도 설정 업데이트
- `getImportanceConfig()`: 중요도 설정 조회
- `updateImportanceConfig()`: 중요도 설정 업데이트
- 설정 캐싱 및 무효화 로직

#### 데이터베이스 스키마

**deal_health_scores** 테이블
```sql
CREATE TABLE deal_health_scores (
  id SERIAL PRIMARY KEY,
  deal_id VARCHAR(100) NOT NULL,
  customer_id VARCHAR(100) NOT NULL,
  score DECIMAL(5,2) NOT NULL,
  trend VARCHAR(20) NOT NULL,
  factors JSONB,
  recommendations TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**health_config** 테이블
```sql
CREATE TABLE health_config (
  id SERIAL PRIMARY KEY,
  config_key VARCHAR(100) UNIQUE NOT NULL,
  config_value DECIMAL(10,2) NOT NULL,
  config_type VARCHAR(50) NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**importance_config** 테이블
```sql
CREATE TABLE importance_config (
  id SERIAL PRIMARY KEY,
  config_key VARCHAR(100) UNIQUE NOT NULL,
  config_value DECIMAL(10,2) NOT NULL,
  config_type VARCHAR(50) NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

### 프론트엔드 (Next.js + React + TypeScript)

#### 컴포넌트 구조

**DealHealthInsights** (`frontend/components/customers/DealHealthInsights.tsx`)
- 메인 컴포넌트
- 자식 컴포넌트 조합
- 데이터 로딩 및 에러 처리

**HealthRadarChart** (`frontend/components/customers/HealthRadarChart.tsx`)
- Recharts 기반 레이더 차트
- 5가지 요인 시각화

**SimilarCustomersPanel** (`frontend/components/customers/SimilarCustomersPanel.tsx`)
- 유사 고객 비교 패널
- 산업/규모 기반 필터링

**DealConfigSettings** (`frontend/app/(main)/settings/deal-config/page.tsx`)
- 설정 관리 페이지
- 탭 기반 UI (건강도/중요도)
- 폼 입력 및 저장 기능

#### Custom Hooks

**useDealHealth** (`frontend/hooks/useDealHealth.ts`)
```typescript
export function useDealHealth(customerId: string) {
  return useQuery({
    queryKey: ['deal-health', customerId],
    queryFn: async () => {
      const response = await api.get(`/api/reno/deal-health/${customerId}`);
      return response.data;
    },
    enabled: !!customerId,
    refetchInterval: 60000, // 1분마다 갱신
  });
}
```

**useDealHealthHistory** (`frontend/hooks/useDealHealth.ts`)
```typescript
export function useDealHealthHistory(customerId: string, limit: number = 5) {
  return useQuery({
    queryKey: ['deal-health-history', customerId, limit],
    queryFn: async () => {
      const response = await api.get(`/api/reno/deal-health/${customerId}/history?limit=${limit}`);
      return response.data;
    },
    enabled: !!customerId,
  });
}
```

---

## 📦 배포 현황

### 스테이징 환경
- URL: https://staging.workhub.biz:4400/saleshub
- 배포일: 2026-01-27
- 상태: ✅ 정상 작동
- Docker 이미지: `wbsaleshub:staging`

### 주요 변경사항
1. ✅ 데이터베이스 마이그레이션 완료 (`020_add_deal_config_tables.sql`)
2. ✅ 백엔드 API 구현 완료
3. ✅ 프론트엔드 UI 구현 완료
4. ✅ Nginx 라우팅 수정 (404 에러 해결)
   - 문제: `/saleshub/api/auth/login` 요청 시 404 반환
   - 원인: Nginx가 잘못된 포트(4011)로 프록시
   - 해결: 올바른 포트(4401)로 변경 및 리로드
5. ✅ 사용자 인증 복구 (password: test1234)

---

## 🧪 테스트 체크리스트

### 기능 테스트
- [ ] 고객 상세 페이지에서 건강도 점수 카드 표시 확인
- [ ] 레이더 차트 정상 렌더링 확인
- [ ] 건강도 추이 차트 정상 렌더링 확인
- [ ] AI 추천사항 리스트 표시 확인
- [ ] 유사 고객 패널 표시 확인
- [ ] 1분마다 자동 갱신 동작 확인
- [ ] 설정 페이지에서 건강도 설정 변경 및 저장 확인
- [ ] 설정 페이지에서 중요도 설정 변경 및 저장 확인
- [ ] 설정 변경 후 실시간 반영 확인

### 인증 테스트
- [x] 로그인 정상 작동 (test1234)
- [ ] 세션 유지 확인
- [ ] 로그아웃 후 보호된 페이지 접근 차단 확인

### 성능 테스트
- [ ] 건강도 계산 응답 시간 측정 (목표: 1초 이내)
- [ ] 대량 고객 데이터 처리 성능 확인
- [ ] 프론트엔드 렌더링 성능 확인 (Lighthouse 점수)

### 에러 핸들링 테스트
- [ ] 존재하지 않는 고객 ID 요청 시 에러 메시지 표시
- [ ] 네트워크 에러 발생 시 재시도 로직 작동 확인
- [ ] 잘못된 설정 값 입력 시 검증 에러 표시

---

## 📝 향후 개선 계획

### 단기 (1-2주)
1. **알림 시스템 구축**
   - 건강도 급락 시 담당 CSM에게 알림
   - 30일 이상 연락 없는 중요 고객 알림

2. **대시보드 개선**
   - 전체 고객 건강도 분포 차트
   - 위험 고객 우선순위 리스트
   - 건강도 트렌드 히트맵

3. **추천사항 고도화**
   - GPT-4 기반 개인화된 추천
   - 과거 성공 사례 참조

### 중기 (1-2개월)
1. **자동화 워크플로우**
   - 건강도 하락 시 자동 이메일 발송
   - 마일스톤 미완료 시 리마인더 생성

2. **예측 모델 도입**
   - 건강도 미래 추세 예측
   - 이탈 가능성 예측 (Churn Prediction)

3. **모바일 앱 지원**
   - 건강도 점수 푸시 알림
   - 간편 조회 UI

### 장기 (3개월 이상)
1. **머신러닝 모델 고도화**
   - 실제 성과 데이터 기반 학습
   - 가중치 자동 최적화

2. **고급 분석 기능**
   - 건강도 변화 패턴 분석
   - 산업별/규모별 벤치마킹

---

## 🐛 알려진 이슈

### 해결됨
- ✅ 로그인 404 에러 (Nginx 프록시 포트 수정으로 해결)
- ✅ 비밀번호 인증 실패 (DB 해시 업데이트로 해결)

### 미해결
- 없음

---

## 📚 참고 문서

### 코드 위치
- **백엔드 서비스**: [server/services/dealHealthService.ts](../../WBSalesHub/server/services/dealHealthService.ts)
- **백엔드 설정 서비스**: [server/services/dealConfigService.ts](../../WBSalesHub/server/services/dealConfigService.ts)
- **API 라우트**: [server/routes/renoRoutes.ts](../../WBSalesHub/server/routes/renoRoutes.ts)
- **DB 마이그레이션**: [server/database/migrations/020_add_deal_config_tables.sql](../../WBSalesHub/server/database/migrations/020_add_deal_config_tables.sql)
- **프론트엔드 컴포넌트**: [frontend/components/customers/DealHealthInsights.tsx](../../WBSalesHub/frontend/components/customers/DealHealthInsights.tsx)
- **설정 페이지**: [frontend/app/(main)/settings/deal-config/page.tsx](../../WBSalesHub/frontend/app/(main)/settings/deal-config/page.tsx)
- **Custom Hook**: [frontend/hooks/useDealHealth.ts](../../WBSalesHub/frontend/hooks/useDealHealth.ts)

### 관련 문서
- [2026-01-18 프로덕션 SSO 쿠키 도메인 수정](/home/peterchung/WHCommon/작업기록/완료/2026-01-18-프로덕션-SSO-쿠키-도메인-수정.md)
- [Claude Context](../claude-context.md)

---

## ✅ 최종 체크리스트

### 개발 완료
- [x] 데이터베이스 스키마 설계 및 마이그레이션
- [x] 백엔드 API 구현
- [x] 건강도 계산 로직 구현
- [x] 중요도 계산 로직 구현
- [x] 설정 관리 시스템 구현
- [x] 프론트엔드 UI 컴포넌트 구현
- [x] 레이더 차트 구현
- [x] 추이 차트 구현
- [x] AI 추천사항 생성 로직 구현
- [x] React Query 기반 데이터 페칭 구현

### 배포 및 테스트
- [x] 스테이징 환경 배포
- [x] Nginx 라우팅 설정
- [x] 데이터베이스 연결 확인
- [x] 로그인 기능 복구
- [ ] 전체 기능 테스트 수행
- [ ] 프로덕션 배포 준비

### 문서화
- [x] 한글 PRD 작성
- [x] 코드 주석 작성
- [x] API 문서화
- [ ] 사용자 매뉴얼 작성

---

**작성일**: 2026-01-27
**작성자**: Claude Code
**버전**: 1.0
**상태**: 스테이징 배포 완료
